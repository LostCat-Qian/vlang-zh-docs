# V æ–‡æ¡£

(æœ‰å…³ V æ ‡å‡†åº“çš„æ–‡æ¡£,è¯·å‚é˜… https://modules.vlang.io/)

## ç®€ä»‹

V æ˜¯ä¸€ç§é™æ€ç±»å‹åŒ–çš„ç¼–è¯‘è¯­è¨€,æ—¨åœ¨æ„å»ºå¯ç»´æŠ¤çš„è½¯ä»¶ã€‚

å®ƒç±»ä¼¼äº Go å’Œ Oberon,åŒæ—¶ä¹Ÿå—åˆ° Rustã€Swiftã€Kotlin å’Œ Python çš„å½±å“ã€‚

V æ˜¯ä¸€ç§éå¸¸ç®€å•çš„è¯­è¨€ã€‚é€šè¯»æœ¬æ–‡æ¡£åªéœ€è¦ä¸€ä¸ªå‘¨æœ«çš„æ—¶é—´,åˆ°æ—¶å€™ä½ å°±åŸºæœ¬æŒæ¡äº†è¿™é—¨è¯­è¨€ã€‚

è¿™é—¨è¯­è¨€æå€¡ç¼–å†™ç®€å•æ˜æ™°çš„ä»£ç ,å°½é‡å‡å°‘æŠ½è±¡ã€‚

å°½ç®¡ç®€å•,V ä¹Ÿèµ‹äºˆå¼€å‘è€…å¼ºå¤§çš„èƒ½åŠ›ã€‚ä»»ä½•ä½ èƒ½ç”¨å…¶ä»–è¯­è¨€åšåˆ°çš„,åœ¨ V é‡Œä¹Ÿå¯ä»¥å®ç°ã€‚

## æºç å®‰è£… V

è·å–æœ€æ–°ç‰ˆæœ¬ V çš„æœ€ä½³æ–¹å¼,å°±æ˜¯ä»æºç å®‰è£…ã€‚æ“ä½œç®€å•,åªéœ€å‡ ç§’é’Ÿ:

```bash
git clone https://github.com/vlang/v
cd v
make
# æ³¨æ„:Windows ç”¨æˆ·è¯·åœ¨ cmd.exe ç»ˆç«¯é‡Œè¿è¡Œ make.bat
```

æ›´å¤šè¯¦ç»†ä¿¡æ¯,è¯·å‚é˜… README.md çš„ [ä»æºç å®‰è£… V](https://github.com/vlang/v/blob/master/README.md#installing-v-from-source) éƒ¨åˆ†ã€‚

## å‡çº§ V åˆ°æœ€æ–°ç‰ˆæœ¬

å¦‚æœè®¾å¤‡ä¸Šå·²ç»å®‰è£…äº† V,å¯ä»¥ä½¿ç”¨ V å†…ç½®çš„è‡ªæ›´æ–°å™¨å°†å…¶å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬ã€‚ è¿è¡Œ `v up` å‘½ä»¤å³å¯ã€‚

## æ‰“åŒ… V ä»¥å‘å¸ƒå‘è¡Œç‰ˆ

è¯·å‚é˜…[æ‰“åŒ… V ä»¥å‘å¸ƒå‘è¡Œç‰ˆ](https://claude.ai/chat/packaging_v_for_distributions.md) çš„ç›¸å…³è¯´æ˜ã€‚

## æ–°æ‰‹ä¸Šè·¯

é€šè¿‡ä»»æ„ä»¥ä¸‹å‘½ä»¤,å¯ä»¥è®© V è‡ªåŠ¨ä¸ºä½ è®¾ç½®é¡¹ç›®çš„åŸºæœ¬ç»“æ„:

- `v init` â†’ åœ¨å½“å‰æ–‡ä»¶å¤¹æ·»åŠ æ‰€éœ€æ–‡ä»¶,ä½¿å…¶æˆä¸ºä¸€ä¸ª V é¡¹ç›®
- `v new abc` â†’ åœ¨æ–°æ–‡ä»¶å¤¹ `abc` ä¸­,åˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®(é»˜è®¤ç”Ÿæˆä¸€ä¸ª "hello world" é¡¹ç›®)
- `v new abcd web` â†’ åœ¨æ–°æ–‡ä»¶å¤¹ `abcd` ä¸­,ä½¿ç”¨ `vweb` æ¨¡æ¿åˆ›å»ºæ–°é¡¹ç›®

## ç›®å½•

<table> <tr><td width=33% valign=top>

- [Hello World ç¤ºä¾‹](#Hello-World)
- [è¿è¡ŒåŒ…å«å¤šä¸ªæ–‡ä»¶çš„é¡¹ç›®æ–‡ä»¶å¤¹](#è¿è¡ŒåŒ…å«å¤šä¸ªæ–‡ä»¶çš„é¡¹ç›®æ–‡ä»¶å¤¹)
- [æ³¨é‡Š](#æ³¨é‡Š)
- [å‡½æ•°](#å‡½æ•°)
  - [æå‡å£°æ˜](#æå‡å£°æ˜)
  - [è¿”å›å¤šä¸ªå€¼](#è¿”å›å¤šä¸ªå€¼)
- [ç¬¦å·å¯è§æ€§](#ç¬¦å·å¯è§æ€§)
- [å˜é‡](#å˜é‡)
  - [å¯å˜å˜é‡](#å¯å˜å˜é‡)
  - [åˆå§‹åŒ– vs èµ‹å€¼](#åˆå§‹åŒ– vs èµ‹å€¼)
  - [å£°æ˜é”™è¯¯](#å£°æ˜é”™è¯¯)
- [V ç±»å‹](#V ç±»å‹)
  - [åŸºæœ¬ç±»å‹](#åŸºæœ¬ç±»å‹)
  - [å­—ç¬¦ä¸²](#å­—ç¬¦ä¸²)
  - [ç¬¦å·](#ç¬¦å·)
  - [æ•°å­—](#æ•°å­—)
  - Array
    - [å¤šç»´æ•°ç»„](#å¤šç»´æ•°ç»„)
    - [æ•°ç»„æ–¹æ³•](#æ•°ç»„æ–¹æ³•)
    - [æ•°ç»„åˆ‡ç‰‡](#æ•°ç»„åˆ‡ç‰‡)
  - [å›ºå®šå¤§å°æ•°ç»„](#å›ºå®šå¤§å°æ•°ç»„)
  - [Map](#Maps)

</td><td width=33% valign=top>

- æ¨¡å—å¯¼å…¥
  - [é€‰æ‹©æ€§å¯¼å…¥](#é€‰æ‹©æ€§å¯¼å…¥)
  - [æ¨¡å—å¯¼å…¥åˆ«å](#æ¨¡å—å¯¼å…¥åˆ«å)
- è¯­å¥å’Œè¡¨è¾¾å¼
  - [If](#if)
  - [Match](#Match)
  - [In æ“ä½œç¬¦](#In-æ“ä½œç¬¦)
  - [For å¾ªç¯](#For-å¾ªç¯)
  - [Defer](#defer)
  - [Goto](#goto)
- ç»“æ„ä½“
  - [å †ç»“æ„ä½“](#å †ç»“æ„ä½“)
  - [é»˜è®¤å­—æ®µå€¼](#é»˜è®¤å­—æ®µå€¼)
  - [å¿…å¡«å­—æ®µ](#å¿…å¡«å­—æ®µ)
  - [ç®€æ´çš„ç»“æ„ä½“å­—é¢é‡è¯­æ³•](#ç®€æ´çš„ç»“æ„ä½“å­—é¢é‡è¯­æ³•)
  - [ç»“æ„ä½“æ›´æ–°è¯­æ³•](#ç»“æ„ä½“æ›´æ–°è¯­æ³•)
  - [ç»“æ„ä½“å­—é¢é‡åç¼€å‚æ•°](#ç»“æ„ä½“å­—é¢é‡åç¼€å‚æ•°)
  - [è®¿é—®ä¿®é¥°ç¬¦](#è®¿é—®ä¿®é¥°ç¬¦)
  - [åŒ¿åç»“æ„ä½“](#åŒ¿åç»“æ„ä½“)
  - [é™æ€ç±»å‹æ–¹æ³•](#é™æ€ç±»å‹æ–¹æ³•)
  - [[noinit\] ç»“æ„ä½“](#noinit-ç»“æ„ä½“)
  - [æ–¹æ³•](#æ–¹æ³•)
  - [åµŒå…¥ç»“æ„ä½“](#åµŒå…¥ç»“æ„ä½“)
- [è”åˆä½“](#è”åˆä½“)

</td><td valign=top>

- å‡½æ•° 2
  - [é»˜è®¤ä¸å¯å˜å‡½æ•°å‚æ•°](#é»˜è®¤ä¸å¯å˜å‡½æ•°å‚æ•°)
  - [å¯å˜å‚æ•°](#å¯å˜å‚æ•°)
  - [å¯å˜æ•°é‡çš„å‚æ•°](#å¯å˜æ•°é‡çš„å‚æ•°)
  - [åŒ¿åå’Œé«˜é˜¶å‡½æ•°](#åŒ¿åå’Œé«˜é˜¶å‡½æ•°)
  - [é—­åŒ…](#é—­åŒ…)
  - [å‚æ•°è¯„ä¼°é¡ºåº](#å‚æ•°è¯„ä¼°é¡ºåº)
- [å¼•ç”¨](#å¼•ç”¨)
- å¸¸é‡
  - [éœ€è¦æ¨¡å—å‰ç¼€](#éœ€è¦æ¨¡å—å‰ç¼€)
- å†…ç½®å‡½æ•°
  - [println](#println)
  - [æ‰“å°è‡ªå®šä¹‰ç±»å‹](#æ‰“å°è‡ªå®šä¹‰ç±»å‹)
  - [è¿è¡Œæ—¶è½¬å‚¨è¡¨è¾¾å¼](#è¿è¡Œæ—¶è½¬å‚¨è¡¨è¾¾å¼)
- æ¨¡å—
  - [åˆ›å»ºæ¨¡å—](#åˆ›å»ºæ¨¡å—)
  - [init å‡½æ•°](#init-å‡½æ•°)

</td></tr> <tr><td width=33% valign=top>

- ç±»å‹å£°æ˜
  - [ç±»å‹åˆ«å](#ç±»å‹åˆ«å)
  - [æšä¸¾](#æšä¸¾)
  - [å‡½æ•°ç±»å‹](#å‡½æ•°ç±»å‹)
  - [æ¥å£](#æ¥å£)
  - [å’Œç±»å‹](#å’Œç±»å‹)
  - Option/Result ç±»å‹å’Œé”™è¯¯å¤„ç†
    - [å¤„ç† Option/Result](#å¤„ç†-optionresult)
  - [è‡ªå®šä¹‰é”™è¯¯ç±»å‹](#è‡ªå®šä¹‰é”™è¯¯ç±»å‹)
  - [æ³›å‹](#æ³›å‹)
- å¹¶å‘
  - [ç”Ÿæˆå¹¶å‘ä»»åŠ¡](#ç”Ÿæˆå¹¶å‘ä»»åŠ¡)
  - [é€šé“](#é€šé“)
  - [å…±äº«å¯¹è±¡](#å…±äº«å¯¹è±¡)
- JSON
  - [è§£æ JSON](#è§£æ-Json)
  - [ç¼–ç  JSON](#ç¼–ç -Json)
- æµ‹è¯•
  - [æ–­è¨€](#æ–­è¨€)
  - [å¸¦é¢å¤–ä¿¡æ¯çš„æ–­è¨€](#å¸¦é¢å¤–ä¿¡æ¯çš„æ–­è¨€)
  - [ä¸ä¼šä¸­æ–­ç¨‹åºçš„æ–­è¨€](#ä¸ä¼šä¸­æ–­ç¨‹åºçš„æ–­è¨€)
  - [æµ‹è¯•æ–‡ä»¶](#æµ‹è¯•æ–‡ä»¶)
  - [è¿è¡Œæµ‹è¯•](#è¿è¡Œæµ‹è¯•)
- å†…å­˜ç®¡ç†
  - [æ§åˆ¶](#æ§åˆ¶)
  - [æ ˆå’Œå †](#æ ˆå’Œå †)
- [ORM](#orm)
- ç¼–å†™æ–‡æ¡£
  - [æ–‡æ¡£æ³¨é‡Šä¸­çš„æ¢è¡Œç¬¦](#æ–‡æ¡£æ³¨é‡Šä¸­çš„æ¢è¡Œç¬¦)

</td><td width=33% valign=top>

- å·¥å…·
  - [v fmt](#v-fmt)
  - [v shader](#v-shader)
  - [æ€§èƒ½åˆ†æ](#æ€§èƒ½åˆ†æ)
- åŒ…ç®¡ç†
  - [åŒ…å‘½ä»¤](#åŒ…å‘½ä»¤)
  - [å‘å¸ƒåŒ…](#å‘å¸ƒåŒ…)
- é«˜çº§ä¸»é¢˜
  - [å±æ€§](#å±æ€§)
  - æ¡ä»¶ç¼–è¯‘
    - [ç¼–è¯‘æ—¶ä¼ªå˜é‡](#ç¼–è¯‘æ—¶ä¼ªå˜é‡)
    - [ç¼–è¯‘æ—¶åå°„](#ç¼–è¯‘æ—¶åå°„)
    - [ç¼–è¯‘æ—¶ä»£ç ](#ç¼–è¯‘æ—¶ä»£ç )
    - [ç¼–è¯‘æ—¶ç±»å‹](#ç¼–è¯‘æ—¶ç±»å‹)
    - [ç‰¹å®šç¯å¢ƒçš„æ–‡ä»¶](#ç‰¹å®šç¯å¢ƒçš„æ–‡ä»¶)
  - [ä¸å®‰å…¨çš„å†…å­˜æ“ä½œ](#ä¸å®‰å…¨çš„å†…å­˜æ“ä½œ)
  - [åŒ…å«å¼•ç”¨å­—æ®µçš„ç»“æ„ä½“](#åŒ…å«å¼•ç”¨å­—æ®µçš„ç»“æ„ä½“)
  - [sizeof å’Œ__offsetof](#sizeof-å’Œ__offsetof)
  - [æœ‰é™çš„æ“ä½œç¬¦é‡è½½](#æœ‰é™çš„æ“ä½œç¬¦é‡è½½)
  - [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
  - [åŸå­æ“ä½œ](#åŸå­æ“ä½œ)
  - [å…¨å±€å˜é‡](#å…¨å±€å˜é‡)
  - [äº¤å‰ç¼–è¯‘](#äº¤å‰ç¼–è¯‘)
  - è°ƒè¯•
    - [é»˜è®¤çš„ C åç«¯äºŒè¿›åˆ¶æ–‡ä»¶](#é»˜è®¤çš„-c-åç«¯äºŒè¿›åˆ¶æ–‡ä»¶)
    - [åŸç”Ÿåç«¯äºŒè¿›åˆ¶æ–‡ä»¶](#åŸç”Ÿåç«¯äºŒè¿›åˆ¶æ–‡ä»¶)
    - [Javascript åç«¯](#javascript-åç«¯)

</td><td valign=top>

- V å’Œ C
  - [åœ¨ V ä¸­è°ƒç”¨ C](#åœ¨-v-ä¸­è°ƒç”¨-c)
  - [åœ¨ C ä¸­è°ƒç”¨ V](#åœ¨-c-ä¸­è°ƒç”¨-v)
  - [ä¼ é€’ C ç¼–è¯‘æ ‡å¿—](#ä¼ é€’-c-ç¼–è¯‘æ ‡å¿—)
  - [#pkgconfig](#pkgconfig)
  - [åŒ…å« C ä»£ç ](#åŒ…å«-c-ä»£ç )
  - [C ç±»å‹](#c-ç±»å‹)
  - [C å£°æ˜](#c-å£°æ˜)
  - [å¯¼å‡ºåˆ°å…±äº«åº“](#å¯¼å‡ºåˆ°å…±äº«åº“)
  - [å°† C è½¬æ¢ä¸º V](#å°†-c-è½¬æ¢ä¸º-v)
  - [è§£å†³ C é—®é¢˜](#è§£å†³-c-é—®é¢˜)
- V çš„å…¶ä»–ç‰¹æ€§
  - [å†…è”æ±‡ç¼–](#å†…è”æ±‡ç¼–)
  - [çƒ­ä»£ç é‡è½½](#çƒ­ä»£ç é‡è½½)
  - [V ä¸­çš„è·¨å¹³å° shell è„šæœ¬](#v-ä¸­çš„è·¨å¹³å°-shell-è„šæœ¬)
  - [æ— æ‰©å±•åçš„ Vsh è„šæœ¬](#æ— æ‰©å±•åçš„-vsh-è„šæœ¬)
- é™„å½•
  - [é™„å½•ä¸€ï¼šå…³é”®å­—](#é™„å½•ä¸€ï¼šå…³é”®å­—)
  - [é™„å½•äºŒï¼šæ“ä½œç¬¦](#é™„å½•äºŒï¼šæ“ä½œç¬¦)

</td></tr> </table> 

<!-- æ³¨:åœ¨ä»£ç æ …æ åé¢å¯ä»¥ä½¿ç”¨å‡ ä¸ªç‰¹æ®Šå…³é”®å­—: compileã€cgenã€liveã€ignoreã€failcompileã€okfmtã€oksyntaxã€badsyntaxã€wipã€nofmt æ›´å¤šè¯¦æƒ…,è¯·æ‰§è¡Œ:`v check-md` -->

## Hello World

```v
fn main() {
	println('hello world')
}
```

å°†ä»¥ä¸Šä»£ç ä¿å­˜åˆ° `hello.v` æ–‡ä»¶ä¸­ã€‚ç„¶åæ‰§è¡Œ:`v run hello.v`ã€‚

> è¿™æ˜¯å‡è®¾ä½ å·²ç»æŒ‰[è¿™é‡Œ](https://github.com/vlang/v/blob/master/README.md#symlinking)æ‰€è¿°,ä¸º V å»ºç«‹äº†ç¬¦å·é“¾æ¥ã€‚ å¦‚æœä½ è¿˜æ²¡æœ‰å»ºç«‹ç¬¦å·é“¾æ¥,åˆ™éœ€è¦æ‰‹åŠ¨è¾“å…¥ V çš„è·¯å¾„ã€‚

æ­å–œä½ ,åˆšåˆšç¼–å†™å¹¶è¿è¡Œäº†ç¬¬ä¸€ä¸ª V ç¨‹åº!

ä½ å¯ä»¥ç”¨ `v hello.v` ç¼–è¯‘ç¨‹åº,è€Œä¸æ‰§è¡Œå®ƒã€‚ æœ‰å…³æ”¯æŒçš„æ‰€æœ‰å‘½ä»¤,è¯·æŸ¥çœ‹ `v help`ã€‚

ä»ä¸Šé¢çš„ä¾‹å­å¯ä»¥çœ‹å‡º,å‡½æ•°æ˜¯é€šè¿‡ `fn` å…³é”®å­—å£°æ˜çš„ã€‚ è¿”å›ç±»å‹åœ¨å‡½æ•°åä¹‹åæŒ‡å®šã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­,`main` ä¸è¿”å›ä»»ä½•å†…å®¹,æ‰€ä»¥æ²¡æœ‰è¿”å›ç±»å‹ã€‚

å’Œ Cã€Go ä»¥åŠ Rust ä¸€æ ·,`main` æ˜¯ç¨‹åºçš„å…¥å£ç‚¹ã€‚

[`println`](#println) æ˜¯å°‘æ•°çš„[å†…ç½®å‡½æ•°](#å†…ç½®å‡½æ•°)ä¹‹ä¸€ã€‚ å®ƒä¼šå°†ä¼ é€’ç»™å®ƒçš„å€¼æ‰“å°åˆ°æ ‡å‡†è¾“å‡ºã€‚

å¯¹äºå•æ–‡ä»¶çš„ç¨‹åº,å¯ä»¥çœç•¥ `fn main()` å£°æ˜ã€‚è¿™åœ¨ç¼–å†™å°ç¨‹åºã€"è„šæœ¬"æˆ–åˆšå­¦ä¹ è¯­è¨€æ—¶å¾ˆæœ‰ç”¨ã€‚ ä¸ºäº†ç®€æ´èµ·è§,æœ¬æ•™ç¨‹å°†è·³è¿‡ `fn main()`ã€‚

è¿™æ„å‘³ç€ V ä¸­çš„ä¸€ä¸ªâ€œHello Worldâ€ç¨‹åºå¯ä»¥ç®€å•åˆ°åªæœ‰:

```v
println('hello world')
```

> **æ³¨æ„** å¦‚æœä½ æ²¡æœ‰æ˜ç¡®ä½¿ç”¨ `fn main() {}`,åˆ™éœ€è¦ç¡®ä¿åœ¨ç¬¬ä¸€ä¸ªå˜é‡èµ‹å€¼è¯­å¥æˆ–é¡¶å±‚å‡½æ•°è°ƒç”¨ä¹‹å‰å£°æ˜æ‰€æœ‰é¡¹, å› ä¸º V ä¼šå°†ç¬¬ä¸€ä¸ªèµ‹å€¼/å‡½æ•°è°ƒç”¨ä¹‹åçš„æ‰€æœ‰å†…å®¹è§†ä¸ºéšå¼ main å‡½æ•°çš„ä¸€éƒ¨åˆ†ã€‚

## è¿è¡ŒåŒ…å«å¤šä¸ªæ–‡ä»¶çš„é¡¹ç›®æ–‡ä»¶å¤¹

å‡è®¾ä½ æœ‰ä¸€ä¸ªåŒ…å«å¤šä¸ª .v æ–‡ä»¶çš„æ–‡ä»¶å¤¹,å…¶ä¸­ä¸€ä¸ªæ–‡ä»¶åŒ…å«ä½ çš„ `main()` å‡½æ•°, å…¶ä»–æ–‡ä»¶åŒ…å«è¾…åŠ©å‡½æ•°ã€‚å®ƒä»¬å¯èƒ½æŒ‰ä¸»é¢˜ç»„ç»‡,ä½†ä»ç„¶*å°šæœª*è¶³å¤Ÿç»“æ„åŒ–åˆ°å¯ä»¥ä½œä¸ºç‹¬ç«‹çš„å¯é‡ç”¨æ¨¡å—, ä½ æƒ³å°†å®ƒä»¬å…¨éƒ¨ç¼–è¯‘åˆ°ä¸€ä¸ªç¨‹åºä¸­ã€‚

åœ¨å…¶ä»–è¯­è¨€ä¸­,ä½ éœ€è¦ä½¿ç”¨åŒ…å«æˆ–æ„å»ºç³»ç»Ÿæ¥æšä¸¾æ‰€æœ‰æ–‡ä»¶,å°†å®ƒä»¬åˆ†åˆ«ç¼–è¯‘æˆç›®æ ‡æ–‡ä»¶, ç„¶åé“¾æ¥åˆ°ä¸€ä¸ªæœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚

ç„¶è€Œ,åœ¨ V ä¸­ä½ å¯ä»¥ä¸€æ¬¡ç¼–è¯‘å’Œè¿è¡Œæ•´ä¸ªåŒ…å« .v æ–‡ä»¶çš„æ–‡ä»¶å¤¹, åªéœ€ä½¿ç”¨ `v run .`ã€‚ä¼ é€’å‚æ•°ä¹Ÿå¯ä»¥å·¥ä½œ,æ‰€ä»¥ä½ å¯ä»¥ æ‰§è¡Œ:

`v run . --yourparam some_other_stuff`

ä¸Šè¿°æ“ä½œé¦–å…ˆä¼šç¼–è¯‘æ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶åˆ°ä¸€ä¸ªç¨‹åº(ä»¥ä½ çš„æ–‡ä»¶å¤¹/é¡¹ç›®å‘½å),ç„¶åä»¥ `--yourparam some_other_stuff` ä½œä¸º CLI å‚æ•°æ‰§è¡Œè¯¥ç¨‹åºã€‚

ç„¶å,ä½ çš„ç¨‹åºå¯ä»¥åƒè¿™æ ·ä½¿ç”¨ CLI å‚æ•°:

```v
import os

println(os.args)
```

> **æ³¨æ„**
>  æˆåŠŸè¿è¡Œå,V ä¼šåˆ é™¤ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚ å¦‚æœæƒ³ä¿ç•™å®ƒ,è¯·ä½¿ç”¨ `v -keepc run .`,æˆ–è€…åªæ‰‹åŠ¨ç¼–è¯‘ with `v .`ã€‚

> **æ³¨æ„** 
>
> ä»»ä½• V ç¼–è¯‘å™¨æ ‡å¿—éƒ½åº”è¯¥åœ¨ `run` å‘½ä»¤*ä¹‹å‰*ä¼ å…¥ã€‚ æºæ–‡ä»¶/æ–‡ä»¶å¤¹ä¹‹åçš„æ‰€æœ‰å†…å®¹å°†æŒ‰åŸæ ·ä¼ é€’ç»™ç¨‹åº - V ä¸ä¼šå¯¹å…¶è¿›è¡Œå¤„ç†ã€‚

## æ³¨é‡Š

```v
// è¿™æ˜¯å•è¡Œæ³¨é‡Š
/*
è¿™æ˜¯å¤šè¡Œæ³¨é‡Š
  /* å®ƒå¯ä»¥åµŒå¥— */  
*/
```

## å‡½æ•°

```v
fn main() {
	println(add(77, 33))
	println(sub(100, 50))
}

fn add(x int, y int) int {
	return x + y
}

fn sub(x int, y int) int {
	return x - y
}
```

å‚æ•°ååœ¨ç±»å‹ä¹‹åã€‚è¿™ä¸€ç‚¹ä¸å…¶ä»–å¤§å¤šæ•°è¯­è¨€ç±»ä¼¼ã€‚

å’Œ Go ä»¥åŠ C ä¸€æ ·,å‡½æ•°ä¸èƒ½é‡è½½ã€‚è¿™ç®€åŒ–äº†ä»£ç ,æé«˜äº†å¯ç»´æŠ¤æ€§å’Œå¯è¯»æ€§ã€‚

### æå‡å£°æ˜

å‡½æ•°å¯ä»¥åœ¨å£°æ˜ä¹‹å‰ä½¿ç”¨: `add` å’Œ `sub` åœ¨ `main` ä¹‹åå£°æ˜,ä½†å¯ä»¥åœ¨ `main` ä¸­è°ƒç”¨ã€‚ è¿™é€‚ç”¨äº V ä¸­çš„æ‰€æœ‰å£°æ˜,æ¶ˆé™¤äº†å¤´æ–‡ä»¶çš„éœ€è¦ æˆ–å…³å¿ƒæ–‡ä»¶å’Œå£°æ˜çš„é¡ºåºã€‚

### è¿”å›å¤šä¸ªå€¼

```v
fn foo() (int, int) {
	return 2, 3 
}

a, b := foo()
println(a) // 2
println(b) // 3
c, _ := foo() // ç”¨ `_` å¿½ç•¥å€¼
```

## ç¬¦å·å¯è§æ€§

```v
pub fn public_function() {
}

fn private_function() {
}
```

å‡½æ•°é»˜è®¤æ˜¯ç§æœ‰çš„(ä¸å¯¼å‡º)ã€‚è¦è®©å…¶ä»–[æ¨¡å—](#æ¨¡å—å¯¼å…¥)å¯ä»¥ä½¿ç”¨å®ƒä»¬,åœ¨å‰é¢åŠ ä¸Š `pub`ã€‚ è¿™åŒæ ·é€‚ç”¨äº[ç»“æ„ä½“](#ç»“æ„ä½“)ã€[å¸¸é‡](#å¸¸é‡)å’Œ[ç±»å‹](#ç±»å‹å£°æ˜)ã€‚

> **æ³¨æ„** 
>
> `pub` åªèƒ½åœ¨å‘½åæ¨¡å—ä¸­ä½¿ç”¨ã€‚å…³äºåˆ›å»ºæ¨¡å—çš„ä¿¡æ¯,è¯·å‚é˜…[æ¨¡å—](#æ¨¡å—)ã€‚

## å˜é‡

```v
name := 'Bob'
age := 20
large_number := i64(9999999999)
println(name)
println(age)
println(large_number)
```

å˜é‡ä½¿ç”¨ `:=` å£°æ˜å’Œåˆå§‹åŒ–ã€‚è¿™æ˜¯åœ¨ V ä¸­å£°æ˜å˜é‡çš„æƒŸä¸€æ–¹å¼ã€‚ è¿™æ„å‘³ç€å˜é‡å§‹ç»ˆæœ‰ä¸€ä¸ªåˆå§‹å€¼ã€‚

å³ä¾§çš„å€¼æ¨æ–­å‡ºå˜é‡çš„ç±»å‹ã€‚è¦é€‰æ‹©ä¸åŒçš„ç±»å‹,è¯·ä½¿ç”¨ç±»å‹è½¬æ¢: è¡¨è¾¾å¼ `T(v)` å°†å€¼ `v` è½¬æ¢ä¸ºç±»å‹ `T`ã€‚

ä¸å¤§å¤šæ•°å…¶ä»–è¯­è¨€ä¸åŒ,V åªå…è®¸åœ¨å‡½æ•°ä¸­å®šä¹‰å˜é‡ã€‚

é»˜è®¤ä¸å…è®¸**å…¨å±€å˜é‡**ã€‚æœ‰å…³è¯¦ç»†ä¿¡æ¯,è¯·å‚é˜…[å…¨å±€å˜é‡](#å…¨å±€å˜é‡)ã€‚

ä¸ºäº†åœ¨ä¸åŒä»£ç åº“ä¹‹é—´ä¿æŒä¸€è‡´æ€§,æ‰€æœ‰å˜é‡å’Œå‡½æ•°åç§°å¿…é¡»ä½¿ç”¨ `snake_case` é£æ ¼,ä¸ç±»å‹åç§°ä¸åŒ,ç±»å‹åç§°å¿…é¡»ä½¿ç”¨ `PascalCase`ã€‚

> **æ³¨æ„** ç„¶è€Œï¼ŒV ä¸æ˜¯ä¸€é—¨çº¯å‡½æ•°å¼è¯­è¨€ã€‚

æœ‰ä¸€ä¸ªç¼–è¯‘å™¨æ ‡å¿—å¯ä»¥å¯ç”¨å…¨å±€å˜é‡(`-enable-globals`),ä½†è¿™æ˜¯é¢å‘ä½çº§åº”ç”¨ç¨‹åºçš„,å¦‚å†…æ ¸å’Œé©±åŠ¨ç¨‹åºã€‚

### å¯å˜å˜é‡

```v
mut age := 20
println(age)
age = 21
println(age)
```

è¦æ”¹å˜å˜é‡çš„å€¼,è¯·ä½¿ç”¨ `=`ã€‚åœ¨ V ä¸­,å˜é‡é»˜è®¤æ˜¯ä¸å¯å˜çš„ã€‚
 è¦èƒ½å¤Ÿæ”¹å˜å˜é‡çš„å€¼,å¿…é¡»ç”¨ `mut` å£°æ˜å®ƒã€‚

å°è¯•åœ¨ç¬¬ä¸€è¡Œåˆ é™¤ `mut` ç„¶åç¼–è¯‘è¯¥ç¨‹åºã€‚

### åˆå§‹åŒ– vs èµ‹å€¼

è¯·æ³¨æ„åˆå§‹åŒ– `:=` å’Œèµ‹å€¼ `=` ä¹‹é—´çš„åŒºåˆ«éå¸¸é‡è¦ã€‚ `:=` ç”¨äºå£°æ˜å’Œåˆå§‹åŒ–,`=` ç”¨äºèµ‹å€¼ã€‚

```v
fn main() {
	age = 21 // é”™è¯¯:æœªå£°æ˜ `age`
}
```

è¿™æ®µä»£ç æ— æ³•ç¼–è¯‘,å› ä¸ºå˜é‡ `age` æœªè¢«å£°æ˜ã€‚ åœ¨ V ä¸­,æ‰€æœ‰å˜é‡éƒ½éœ€è¦å£°æ˜ã€‚

```v
fn main() {
	age := 21
}
```

å¯ä»¥åœ¨ä¸€è¡Œä¸­æ”¹å˜å¤šä¸ªå˜é‡çš„å€¼ã€‚ è¿™æ ·å¯ä»¥ä¸ä½¿ç”¨ä¸­é—´å˜é‡äº¤æ¢å€¼ã€‚

```v
mut a := 0
mut b := 1
println('${a}, ${b}') // 0, 1
a, b = b, a
println('${a}, ${b}') // 1, 0
```

### å£°æ˜é”™è¯¯

åœ¨å¼€å‘æ¨¡å¼ä¸‹,ç¼–è¯‘å™¨ä¼šè­¦å‘Šä½ æ²¡æœ‰ä½¿ç”¨è¯¥å˜é‡ (ä½ ä¼šå¾—åˆ°ä¸€ä¸ªâ€œæœªä½¿ç”¨çš„å˜é‡â€è­¦å‘Š)ã€‚ åœ¨ç”Ÿäº§æ¨¡å¼ä¸‹(é€šè¿‡ `-prod` æ ‡å¿—è¿è¡Œ V:`v -prod foo.v`), å®ƒæ ¹æœ¬ä¸ä¼šç¼–è¯‘ã€‚

```v
fn main() {
	a := 10
	if true {
		a := 20 // é”™è¯¯:é‡å¤å®šä¹‰ `a`
	}
	// è­¦å‘Š:æœªä½¿ç”¨çš„å˜é‡ `a`
}
```

ä¸å¤§å¤šæ•°è¯­è¨€ä¸åŒ,V ä¸å…è®¸å˜é‡é®è”½ã€‚åœ¨çˆ¶ä½œç”¨åŸŸä¸­å·²ç»ä½¿ç”¨çš„åç§°å£°æ˜å˜é‡ä¼šå¯¼è‡´ç¼–è¯‘é”™è¯¯ã€‚

## V ç±»å‹

### åŸºæœ¬ç±»å‹

```v
bool

string

i8    i16  int  i64      i128 (soon)  
u8    u16  u32  u64      u128 (soon)

rune // è¡¨ç¤ºä¸€ä¸ª Unicode ä»£ç ç‚¹  

f32 f64

isize, usize // å¹³å°ç›¸å…³,è¡¨ç¤ºå¼•ç”¨å†…å­˜ä¸­ä»»æ„ä½ç½®æ‰€éœ€çš„å­—èŠ‚æ•°

voidptr // è¿™ä¸»è¦ç”¨äº [C äº’æ“ä½œæ€§](#v-å’Œ-c)  

any // ç±»ä¼¼äº C çš„ void* å’Œ Go çš„ interface{}
```

> **æ³¨æ„** ä¸ C å’Œ Go ä¸åŒ,`int` å§‹ç»ˆæ˜¯ä¸€ä¸ª 32 ä½æ•´æ•°ã€‚

è¿™é‡Œæœ‰ä¸€ä¸ªä¾‹å¤–æƒ…å†µ:å½“ä¸€ä¸ªæ“ä½œæ•°æ˜¯å¦ä¸€ä¸ªæ“ä½œæ•°æ•°æ®èŒƒå›´å†…çš„å°æ•´æ•°ç±»å‹æ—¶,å¯ä»¥è‡ªåŠ¨è¿›è¡Œæå‡ã€‚ è¿™äº›æ˜¯å…è®¸çš„å¯èƒ½æ€§:

```
   i8 â†’ i16 â†’ int â†’ i64
                  â†˜     â†˜
                    f32 â†’ f64
                  â†—     â†—
   u8 â†’ u16 â†’ u32 â†’ u64 â¬
      â†˜     â†˜     â†˜      ptr
   i8 â†’ i16 â†’ int â†’ i64 â¬
```

ä¾‹å¦‚ä¸€ä¸ª `int` å€¼å¯ä»¥è‡ªåŠ¨è½¬æ¢ä¸º `f64` æˆ– `i64`,ä½†ä¸èƒ½è½¬æ¢ä¸º `u32` (å› ä¸ºå¯¹äºè´Ÿå€¼æ¥è¯´,`u32` ä¼šä¸¢å¤±ç¬¦å·ä¿¡æ¯)ã€‚
 ä½†æ˜¯,ä» `int` åˆ° `f32` çš„è½¬æ¢ç›®å‰ä¼šè‡ªåŠ¨è¿›è¡Œ(å°½ç®¡å¯¹äºå¤§å€¼å¯èƒ½ä¼šä¸¢å¤±ç²¾åº¦)ã€‚

åƒ `123` æˆ– `4.56` è¿™æ ·çš„å­—é¢é‡å…·æœ‰ç‰¹æ®Šçš„å¤„ç†æ–¹å¼ã€‚å®ƒä»¬ä¸ä¼šå¯¼è‡´ç±»å‹æå‡, ä½†æ˜¯é»˜è®¤åˆ†åˆ«ä¸º `int` å’Œ `f64`,å½“å¿…é¡»å†³å®šå…¶ç±»å‹æ—¶:

```v
u := u16(12)
v := 13 + u    // v çš„ç±»å‹ä¸º `u16` - æ²¡æœ‰æå‡  
x := f32(45.6)
y := x + 3.14  // y çš„ç±»å‹ä¸º `f32` - æ²¡æœ‰æå‡
a := 75        // a çš„ç±»å‹ä¸º `int` - int å­—é¢é‡çš„é»˜è®¤ç±»å‹
b := 14.7      // b çš„ç±»å‹ä¸º `f64` - float å­—é¢é‡çš„é»˜è®¤ç±»å‹
c := u + a     // c çš„ç±»å‹ä¸º `int` - è‡ªåŠ¨æå‡ `u` çš„å€¼
d := b + x     // d çš„ç±»å‹ä¸º `f64` - è‡ªåŠ¨æå‡ `x` çš„å€¼
```

### å­—ç¬¦ä¸²

```v
name := 'Bob'  
assert name.len == 3       // æ‰“å°å‡º 3
assert name[0] == u8(66) // ç´¢å¼•è·å¾—ä¸€ä¸ªå­—èŠ‚,u8(66) == `B`
assert name[1..3] == 'ob'  // åˆ‡ç‰‡è·å¾—å­—ç¬¦ä¸² 'ob'

// è½¬ä¹‰ä»£ç 
windows_newline := '\r\n'      // åƒ C è¯­è¨€ä¸€æ ·è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦  
assert windows_newline.len == 2

// ä½¿ç”¨ `\x##` è¡¨ç¤ºæ³•ç›´æ¥æŒ‡å®šä»»æ„å­—èŠ‚,`#` æ˜¯åå…­è¿›åˆ¶æ•°å­—
// aardvark_str := '\x61ardvark' 
// assert aardvark_str == 'aardvark'
assert '\xc0'[0] == u8(0xc0) 

// æˆ–ä½¿ç”¨å…«è¿›åˆ¶è½¬ä¹‰ `\###` è¡¨ç¤ºæ³•,`#` æ˜¯å…«è¿›åˆ¶æ•°å­—
aardvark_str2 := '\141ardvark'
assert aardvark_str2 == 'aardvark'

// Unicode å¯ä»¥ç›´æ¥æŒ‡å®šä¸º `\u####`,`#` æ˜¯åå…­è¿›åˆ¶æ•°å­—
// å¹¶åœ¨å†…éƒ¨è½¬æ¢ä¸º UTF-8 è¡¨ç¤º  
star_str := '\u2605' // â˜…
assert star_str == 'â˜…'
assert star_str == '\xe2\x98\x85' // UTF-8 ä¹Ÿå¯ä»¥è¿™æ ·æŒ‡å®š
```

åœ¨ V ä¸­,å­—ç¬¦ä¸²æ˜¯ä¸€ä¸ªåªè¯»çš„å­—èŠ‚æ•°ç»„ã€‚æ‰€æœ‰ Unicode å­—ç¬¦éƒ½ä½¿ç”¨ UTF-8 ç¼–ç :

```v
s := 'hello ğŸŒ' // è¡¨æƒ…ç¬¦å·å ç”¨ 4 ä¸ªå­—èŠ‚
assert s.len == 10  

arr := s.bytes() // å°† `string` è½¬æ¢ä¸º `[]u8`
assert arr.len == 10

s2 := arr.bytestr() // å°† `[]u8` è½¬æ¢ä¸º `string`
assert s2 == s
```

å­—ç¬¦ä¸²å€¼æ˜¯ä¸å¯å˜çš„ã€‚ä½ ä¸èƒ½ä¿®æ”¹å…ƒç´ :

```v
mut s := 'hello ğŸŒ'
s[0] = `H` // ä¸å…è®¸
```

> é”™è¯¯:å› ä¸º V å­—ç¬¦ä¸²æ˜¯ä¸å¯å˜çš„,æ‰€ä»¥ä¸èƒ½ç»™ s[i] èµ‹å€¼

è¯·æ³¨æ„,ç´¢å¼•å­—ç¬¦ä¸²ä¼šäº§ç”Ÿä¸€ä¸ª `u8`(å­—èŠ‚),è€Œä¸æ˜¯ä¸€ä¸ª `rune` æˆ–å¦ä¸€ä¸ª `string`ã€‚ ç´¢å¼•å¯¹åº”å­—ç¬¦ä¸²ä¸­çš„*å­—èŠ‚*,è€Œä¸æ˜¯ Unicode ä»£ç ç‚¹ã€‚å¦‚æœä½ æƒ³å°† `u8` è½¬æ¢ä¸º `string`,å¯ä»¥åœ¨ `u8` ä¸Šä½¿ç”¨ `.ascii_str()` æ–¹æ³•:

```v
country := 'Netherlands'
println(country[0]) // è¾“å‡º: 78
println(country[0].ascii_str()) // è¾“å‡º: N
```

å•å¼•å·å’ŒåŒå¼•å·éƒ½å¯ä»¥ç”¨æ¥è¡¨ç¤ºå­—ç¬¦ä¸²ã€‚ä¸ºäº†ç»Ÿä¸€èµ·è§,`vfmt` ä¼šå°†åŒå¼•å·è½¬æ¢ä¸ºå•å¼•å·,é™¤éå­—ç¬¦ä¸²æœ¬èº«åŒ…å«å•å¼•å·ã€‚

å¯¹äºåŸå§‹å­—ç¬¦ä¸²,åœ¨å‰é¢åŠ ä¸Š `r`ã€‚è½¬ä¹‰å¤„ç†ä¸ä¼šåº”ç”¨äºåŸå§‹å­—ç¬¦ä¸²:

```v
s := r'hello\nworld' // `\n` å°†ä½œä¸ºä¸¤ä¸ªå­—ç¬¦ä¿ç•™
println(s) // "hello\nworld"
```

å­—ç¬¦ä¸²å¯ä»¥è½»æ¾è½¬æ¢ä¸ºæ•´æ•°:

```v
s := '42'
n := s.int() // 42

// æ‰€æœ‰ int å­—é¢é‡éƒ½æ”¯æŒ  
assert '0xc3'.int() == 195
assert '0o10'.int() == 8 
assert '0b1111_0000_1010'.int() == 3850
assert '-0b1111_0000_1010'.int() == -3850
```

æ›´é«˜çº§çš„å­—ç¬¦ä¸²å¤„ç†å’Œè½¬æ¢,è¯·å‚è€ƒ [vlib/strconv](https://modules.vlang.io/strconv.html) æ¨¡å—ã€‚

#### å­—ç¬¦ä¸²æ’å€¼

åŸºæœ¬çš„æ’å€¼è¯­æ³•éå¸¸ç®€å• - åœ¨å˜é‡åå‰ä½¿ç”¨ `${`,åé¢ä½¿ç”¨`}`ã€‚å˜é‡ä¼šè¢«è½¬æ¢ä¸ºå­—ç¬¦ä¸²å¹¶åµŒå…¥å­—é¢é‡ä¸­:

```v
name := 'Bob'
println('Hello, ${name}!') // Hello, Bob!
```

å®ƒä¹Ÿå¯ä»¥å’Œå­—æ®µä¸€èµ·ä½¿ç”¨:`'age = ${user.age}'`ã€‚ä½ è¿˜å¯ä»¥ä½¿ç”¨æ›´å¤æ‚çš„è¡¨è¾¾å¼:`'can register = ${user.age > 13}'`ã€‚

æ”¯æŒç±»ä¼¼ C `printf()` çš„æ ¼å¼è¯´æ˜ç¬¦ã€‚`f`ã€`g`ã€`x`ã€`o`ã€`b` ç­‰æ˜¯å¯é€‰çš„,ç”¨äºæŒ‡å®šè¾“å‡ºæ ¼å¼ã€‚ç¼–è¯‘å™¨ä¼šè´Ÿè´£å­˜å‚¨å¤§å°,æ‰€ä»¥ä¸éœ€è¦ `hd` æˆ– `llu`ã€‚

éµå¾ªæ­¤æ¨¡å¼ä½¿ç”¨æ ¼å¼è¯´æ˜ç¬¦:

```v
${varname:[flags][width][.precision][type]}
```

- flags:å¯ä»¥æ˜¯ä»¥ä¸‹é›¶ä¸ªæˆ–å¤šä¸ª:- è¡¨ç¤ºåœ¨å­—æ®µå†…å·¦å¯¹é½è¾“å‡º,0 è¡¨ç¤ºä½¿ç”¨ `0` ä½œä¸ºå¡«å……å­—ç¬¦,è€Œä¸æ˜¯é»˜è®¤çš„ `ç©ºæ ¼` å­—ç¬¦ã€‚

  > **æ³¨æ„**
  >  V ç›®å‰ä¸æ”¯æŒ `'` æˆ– `#` ä½œä¸ºæ ¼å¼æ ‡å¿—,å¹¶ä¸” V æ”¯æŒä½†ä¸éœ€è¦ `+` æ¥å³å¯¹é½,å› ä¸ºè¿™æ˜¯é»˜è®¤æƒ…å†µã€‚

- width:å¯ä»¥æ˜¯æ•´æ•°å€¼,æè¿°è¾“å‡ºçš„æœ€å°å­—æ®µå®½åº¦ã€‚

- precision: `.` åè·Ÿæ•´æ•°å€¼,ä¿è¯å°æ•°ç‚¹åçš„æ•°å­—ç²¾åº¦(å¦‚æœè¾“å…¥å˜é‡æ˜¯æµ®ç‚¹æ•°)ã€‚å¦‚æœå˜é‡æ˜¯æ•´æ•°åˆ™å¿½ç•¥ã€‚

- type: `f` å’Œ `F` æŒ‡å®šè¾“å…¥ä¸ºæµ®ç‚¹æ•°,åº”æ¸²æŸ“ä¸ºæµ®ç‚¹æ•°,`e` å’Œ `E` æŒ‡å®šè¾“å…¥ä¸ºæµ®ç‚¹æ•°,åº”æ¸²æŸ“ä¸ºæŒ‡æ•°å½¢å¼(éƒ¨åˆ†æŸå)ã€‚`g` å’Œ `G` æŒ‡å®šè¾“å…¥ä¸ºæµ®ç‚¹æ•° â€” æ¸²æŸ“å™¨å°†å¯¹å°å€¼ä½¿ç”¨æµ®ç‚¹æ•°è¡¨ç¤ºæ³•,å¯¹å¤§å€¼ä½¿ç”¨æŒ‡æ•°è¡¨ç¤ºæ³•ã€‚`d` æŒ‡å®šè¾“å…¥ä¸ºæ•´æ•°,åº”ä»¥åè¿›åˆ¶æ•°å­—æ¸²æŸ“ã€‚`x` å’Œ `X` è¦æ±‚æ•´æ•°,å¹¶ä»¥åå…­è¿›åˆ¶æ•°å­—æ¸²æŸ“ã€‚`o` è¦æ±‚æ•´æ•°,å¹¶ä»¥å…«è¿›åˆ¶æ•°å­—æ¸²æŸ“ã€‚`b` è¦æ±‚æ•´æ•°,å¹¶ä»¥äºŒè¿›åˆ¶æ•°å­—æ¸²æŸ“ã€‚`s` è¦æ±‚å­—ç¬¦ä¸²(å‡ ä¹ä»ä¸ä½¿ç”¨)ã€‚

  > **æ³¨æ„**
  >  å½“æ•°å­—ç±»å‹å¯ä»¥æ¸²æŸ“å­—æ¯æ—¶,å¦‚åå…­è¿›åˆ¶å­—ç¬¦ä¸²æˆ–ç‰¹æ®Šå€¼åƒ `infinity`,å°å†™ç±»å‹å¼ºåˆ¶ä½¿ç”¨å°å†™å­—æ¯,å¤§å†™ç±»å‹å¼ºåˆ¶ä½¿ç”¨å¤§å†™å­—æ¯ã€‚

  > **æ³¨æ„** åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹,æœ€å¥½ç•™ç©ºæ ¼å¼ç±»å‹ã€‚é»˜è®¤æƒ…å†µä¸‹,æµ®ç‚¹æ•°å°†æ¸²æŸ“ä¸º `g`,æ•´æ•°å°†æ¸²æŸ“ä¸º `d`,`s` å‡ ä¹æ€»æ˜¯å†—ä½™çš„ã€‚ æœ‰ä¸‰ç§æƒ…å†µå»ºè®®æŒ‡å®šç±»å‹:

  - æ ¼å¼å­—ç¬¦ä¸²åœ¨ç¼–è¯‘æ—¶è§£æ,å› æ­¤æŒ‡å®šç±»å‹æœ‰åŠ©äºæ£€æµ‹é”™è¯¯
  - æ ¼å¼å­—ç¬¦ä¸²é»˜è®¤ä½¿ç”¨å°å†™å­—æ¯è¡¨ç¤ºåå…­è¿›åˆ¶æ•°å­—å’Œ `e` æŒ‡æ•°ã€‚ä½¿ç”¨å¤§å†™ç±»å‹å¼ºåˆ¶ä½¿ç”¨å¤§å†™åå…­è¿›åˆ¶æ•°å­—å’Œå¤§å†™æŒ‡æ•° `E`ã€‚
  - æ ¼å¼å­—ç¬¦ä¸²æ˜¯ä»æ•´æ•°è·å–åå…­è¿›åˆ¶ã€äºŒè¿›åˆ¶æˆ–å…«è¿›åˆ¶å­—ç¬¦ä¸²çš„æœ€æ–¹ä¾¿çš„æ–¹æ³•ã€‚

æ›´å¤šä¿¡æ¯,è¯·å‚é˜… [æ ¼å¼å ä½ç¬¦è§„èŒƒ](https://en.wikipedia.org/wiki/Printf_format_string#Format_placeholder_specification)ã€‚

```v
x := 123.4567
println('[${x:.2}]') // å››èˆäº”å…¥åˆ°å°æ•°ç‚¹åä¸¤ä½ => [123.46]  
println('[${x:10}]') // ç”¨ç©ºæ ¼å·¦å¯¹é½ => [   123.457]
println('[${int(x):-10}]') // ç”¨ç©ºæ ¼å³å¯¹é½ => [123       ] 
println('[${int(x):010}]') // å·¦ä¾§ç”¨ 0 å¡«å…… => [0000000123]
println('[${int(x):b}]') // ä»¥äºŒè¿›åˆ¶è¾“å‡º => [1111011]
println('[${int(x):o}]') // ä»¥å…«è¿›åˆ¶è¾“å‡º => [173]  
println('[${int(x):X}]') // ä»¥å¤§å†™åå…­è¿›åˆ¶è¾“å‡º => [7B]

println('[${10.0000:.2}]') // å»é™¤æœ«å°¾æ— æ„ä¹‰çš„ 0 => [10]
println('[${10.0000:.2f}]') // æ˜¾ç¤ºæœ«å°¾ 0,å³ä½¿å®ƒä»¬ä¸æ”¹å˜æ•°å­— => [10.00]
```

#### å­—ç¬¦ä¸²æ“ä½œç¬¦

```v
name := 'Bob'
bobby := name + 'by' // + ç”¨äºè¿æ¥å­—ç¬¦ä¸²
println(bobby) // "Bobby"
mut s := 'hello '  
s += 'world' // `+=` ç”¨äºè¿½åŠ å­—ç¬¦ä¸²
println(s) // "hello world"
```

V ä¸­çš„æ‰€æœ‰æ“ä½œç¬¦ä¸¤ä¸ªæ“ä½œæ•°å¿…é¡»ä¸ºç›¸åŒç±»å‹ã€‚ä¸èƒ½å°†æ•´æ•°è¿æ¥åˆ°å­—ç¬¦ä¸²:

```v
age := 10
println('age = ' + age) // ä¸å…è®¸
```

> é”™è¯¯:ä¸­ç¼€è¡¨è¾¾å¼:ä¸èƒ½å°† `int`(å³è¡¨è¾¾å¼)ç”¨ä½œ `string`

æˆ‘ä»¬éœ€è¦ either æŠŠ `age` è½¬æ¢ä¸º `string`:

```v
age := 11  
println('age = ' + age.str())
```

æˆ–è€…ä½¿ç”¨å­—ç¬¦ä¸²æ’å€¼(é¦–é€‰):

```v
age := 12
println('age = ${age}')
```

è¯·å‚é˜… [string](https://modules.vlang.io/index.html#string) çš„æ‰€æœ‰æ–¹æ³•, ä»¥åŠç›¸å…³æ¨¡å— [strings](https://modules.vlang.io/strings.html)ã€ [strconv](https://modules.vlang.io/strconv.html)ã€‚

### ç¬¦å·

ä¸€ä¸ª `rune` è¡¨ç¤ºä¸€ä¸ª Unicode å­—ç¬¦,æ˜¯ `u32` çš„åˆ«åã€‚ ä½¿ç”¨ <code>`</code> (åå¼•å·)è¡¨ç¤º:

```v
rocket := `ğŸš€`
```

å¯ä»¥ä½¿ç”¨ `.str()` æ–¹æ³•å°† `rune` è½¬æ¢ä¸º UTF-8 å­—ç¬¦ä¸²ã€‚

```v
rocket := `ğŸš€`
assert rocket.str() == 'ğŸš€'
```

å¯ä»¥ä½¿ç”¨ `.bytes()` æ–¹æ³•å°† `rune` è½¬æ¢ä¸º UTF-8 å­—èŠ‚ã€‚

```v
rocket := `ğŸš€`
assert rocket.bytes() == [u8(0xf0), 0x9f, 0x9a, 0x80]
```

åå…­è¿›åˆ¶ã€Unicode å’Œå…«è¿›åˆ¶è½¬ä¹‰åºåˆ—åœ¨ `rune` å­—é¢é‡ä¸­ä¹Ÿå¯ä»¥ä½¿ç”¨:

```v
assert `\x61` == `a`
assert `\141` == `a` 
assert `\u0061` == `a`

// å¤šå­—èŠ‚å­—é¢é‡ä¹Ÿå¯ä»¥ä½¿ç”¨
assert `\u2605` == `â˜…`
assert `\u2605`.bytes() == [u8(0xe2), 0x98, 0x85]
assert `\xe2\x98\x85`.bytes() == [u8(0xe2), 0x98, 0x85]
assert `\342\230\205`.bytes() == [u8(0xe2), 0x98, 0x85]
```

è¯·æ³¨æ„,`rune` å­—é¢é‡ä½¿ç”¨ä¸å­—ç¬¦ä¸²ç›¸åŒçš„è½¬ä¹‰è¯­æ³•,ä½†åªèƒ½åŒ…å«ä¸€ä¸ª Unicode å­—ç¬¦ã€‚ å› æ­¤,å¦‚æœä»£ç ä¸æŒ‡å®šå•ä¸ª Unicode å­—ç¬¦,å°†åœ¨ç¼–è¯‘æ—¶æ”¶åˆ°é”™è¯¯ã€‚

è¿˜è¦è®°ä½å­—ç¬¦ä¸²æŒ‰å­—èŠ‚ç´¢å¼•,è€Œä¸æ˜¯æŒ‰ rune ç´¢å¼•,æ‰€ä»¥è¦å½“å¿ƒ:

```v
rocket_string := 'ğŸš€'
assert rocket_string[0] != `ğŸš€`  
assert 'aloha!'[0] == `a`
```

å­—ç¬¦ä¸²å¯ä»¥é€šè¿‡' .runes() 'æ–¹æ³•è½¬æ¢ä¸ºç¬¦å·ã€‚

```v
hello := 'Hello World ğŸ‘‹'
hello_runes := hello.runes() // [`H`, `e`, `l`, `l`, `o`, ` `, `W`, `o`, `r`, `l`, `d`, ` `, `ğŸ‘‹`]
assert hello_runes.string() == hello
```

### æ•°å­—

```v
a := 123
```

This will assign the value of 123 to `a`. By default `a` will have the
type `int`.

You can also use hexadecimal, binary or octal notation for integer literals:

```v
a := 0x7B
b := 0b01111011
c := 0o173
```

All of these will be assigned the same value, 123. They will all have type
`int`, no matter what notation you used.

V also supports writing numbers with `_` as separator:

```v
num := 1_000_000 // same as 1000000
three := 0b0_11 // same as 0b11
float_num := 3_122.55 // same as 3122.55
hexa := 0xF_F // same as 255
oct := 0o17_3 // same as 0o173
```

If you want a different type of integer, you can use casting:

```v
a := i64(123)
b := u8(42)
c := i16(12345)
```

Assigning floating point numbers works the same way:

```v
f := 1.0
f1 := f64(3.14)
f2 := f32(3.14)
```

If you do not specify the type explicitly, by default float literals
will have the type of `f64`.

Float literals can also be declared as a power of ten:

```v
f0 := 42e1 // 420
f1 := 123e-2 // 1.23
f2 := 456e+2 // 45600
```

### æ•°ç»„


æ•°ç»„æ˜¯å…·æœ‰ç›¸åŒç±»å‹çš„æ•°æ®å…ƒç´ çš„é›†åˆã€‚æ•°ç»„å­—é¢é‡æ˜¯ç”¨æ–¹æ‹¬å·æ‹¬èµ·æ¥çš„è¡¨è¾¾å¼åˆ—è¡¨ã€‚å•ä¸ªå…ƒç´ å¯ä»¥ä½¿ç”¨ *index* è¡¨è¾¾å¼è®¿é—®ã€‚ç´¢å¼•ä» 0 å¼€å§‹:

```v
mut nums := [1, 2, 3]
println(nums) // `[1, 2, 3]`
println(nums[0]) // `1`
println(nums[1]) // `2`

nums[1] = 5
println(nums) // `[1, 5, 3]`
```

<a id='array-operations'></a>

An element can be appended to the end of an array using the push operator `<<`.
It can also append an entire array.

```v
mut nums := [1, 2, 3]
nums << 4
println(nums) // "[1, 2, 3, 4]"

// append array
nums << [5, 6, 7]
println(nums) // "[1, 2, 3, 4, 5, 6, 7]"
```

```v
mut names := ['John']
names << 'Peter'
names << 'Sam'
// names << 10  <-- This will not compile. `names` is an array of strings.
```

`val in array` returns true if the array contains `val`. See [`in` operator](#in-operator).

```v
names := ['John', 'Peter', 'Sam']
println('Alex' in names) // "false"
```

#### æ•°ç»„å­—æ®µ

æ•°ç»„æœ‰ä¸¤ä¸ªå­—æ®µç”¨äºæ§åˆ¶å…¶"å¤§å°"ï¼š

- `len`ï¼š*é•¿åº¦* - æ•°ç»„ä¸­é¢„åˆ†é…å¹¶åˆå§‹åŒ–çš„å…ƒç´ æ•°é‡ã€‚
- `cap`ï¼š*å®¹é‡* - ä¸ºå…ƒç´ ä¿ç•™çš„å†…å­˜ç©ºé—´é‡ï¼Œä½†å°šæœªåˆå§‹åŒ–æˆ–è®¡ç®—ä¸ºå…ƒç´ ã€‚æ•°ç»„å¯ä»¥å¢é•¿åˆ°è¿™ä¸ªå¤§å°ï¼Œè€Œæ— éœ€é‡æ–°åˆ†é…å†…å­˜ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼ŒVä¼šè‡ªåŠ¨å¤„ç†è¿™ä¸ªå­—æ®µï¼Œä½†ä¹Ÿæœ‰ä¸€äº›æƒ…å†µä¸‹ç”¨æˆ·å¯èƒ½å¸Œæœ›è¿›è¡Œæ‰‹åŠ¨ä¼˜åŒ–ï¼ˆå‚è§[ä¸‹æ–‡](https://chat.openai.com/?model=text-davinci-002-render-sha#array-initialization)ï¼‰ã€‚

```v
mut nums := [1, 2, 3]
println(nums.len) // è¾“å‡º "3"
println(nums.cap) // è¾“å‡º "3" æˆ–æ›´å¤§
nums = [] // æ•°ç»„ç°åœ¨ä¸ºç©º
println(nums.len) // è¾“å‡º "0"
```

`data` æ˜¯ä¸€ä¸ªå­—æ®µï¼ˆç±»å‹ä¸º `voidptr`ï¼‰ï¼Œå­˜å‚¨äº†ç¬¬ä¸€ä¸ªå…ƒç´ çš„åœ°å€ã€‚è¿™æ˜¯ç”¨äºä½çº§åˆ«çš„[`unsafe`](https://chat.openai.com/?model=text-davinci-002-render-sha#memory-unsafe-code)ä»£ç ã€‚

> **æ³¨æ„** 
>
> å­—æ®µæ˜¯åªè¯»çš„ï¼Œä¸èƒ½è¢«ç”¨æˆ·ä¿®æ”¹ã€‚

#### æ•°ç»„åˆå§‹åŒ–

æ•°ç»„çš„ç±»å‹ç”±ç¬¬ä¸€ä¸ªå…ƒç´ å†³å®šï¼š

- `[1, 2, 3]` æ˜¯ä¸€ä¸ªæ•´æ•°æ•°ç»„ (`[]int`)ã€‚
- `['a', 'b']` æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ (`[]string`)ã€‚

ç”¨æˆ·å¯ä»¥æ˜¾å¼åœ°ä¸ºç¬¬ä¸€ä¸ªå…ƒç´ æŒ‡å®šç±»å‹ï¼š`[u8(16), 32, 64, 128]`ã€‚ Væ•°ç»„æ˜¯åŒè´¨çš„ï¼ˆæ‰€æœ‰å…ƒç´ å¿…é¡»å…·æœ‰ç›¸åŒçš„ç±»å‹ï¼‰ã€‚ è¿™æ„å‘³ç€åƒ `[1, 'a']` è¿™æ ·çš„ä»£ç å°†æ— æ³•ç¼–è¯‘ã€‚

ä¸Šè¿°è¯­æ³•å¯¹äºå·²çŸ¥å…ƒç´ æ•°é‡è¾ƒå°çš„æƒ…å†µæ˜¯å¯ä»¥çš„ï¼Œä½†å¯¹äºéå¸¸å¤§æˆ–ç©ºçš„æ•°ç»„ï¼Œæœ‰ç¬¬äºŒç§åˆå§‹åŒ–è¯­æ³•ï¼š

```v
mut a := []int{len: 10000, cap: 30000, init: 3}
```

è¿™å°†åˆ›å»ºä¸€ä¸ªåŒ…å«10000ä¸ªåˆå§‹åŒ–ä¸º`3`çš„`int`å…ƒç´ çš„æ•°ç»„ã€‚ä¸º30000ä¸ªå…ƒç´ é¢„ç•™äº†å†…å­˜ç©ºé—´ã€‚å‚æ•° `len`ã€`cap` å’Œ `init` æ˜¯å¯é€‰çš„ï¼› `len` é»˜è®¤ä¸º `0`ï¼Œ`init` é»˜è®¤ä¸ºå…ƒç´ ç±»å‹çš„é»˜è®¤åˆå§‹åŒ–å€¼ï¼ˆå¯¹äºæ•°å­—ç±»å‹ä¸º `0`ï¼Œå¯¹äº `string` ç­‰ä¸º `''`ï¼‰ã€‚è¿è¡Œæ—¶ç³»ç»Ÿç¡®ä¿å®¹é‡ä¸å°äº `len`ï¼ˆå³ä½¿æ˜ç¡®æŒ‡å®šäº†ä¸€ä¸ªæ›´å°çš„å€¼ï¼‰ï¼š

```v
arr := []int{len: 5, init: -1}
// `arr == [-1, -1, -1, -1, -1]`, arr.cap == 5

// å£°æ˜ä¸€ä¸ªç©ºæ•°ç»„ï¼š
users := []int{}
```

è®¾ç½®å®¹é‡å¯ä»¥æé«˜å‘æ•°ç»„ä¸­æ·»åŠ å…ƒç´ çš„æ€§èƒ½ï¼Œå› ä¸ºå¯ä»¥é¿å…é‡æ–°åˆ†é…ï¼š

```v
mut numbers := []int{cap: 1000}
println(numbers.len) // è¾“å‡º 0
// ç°åœ¨æ·»åŠ å…ƒç´ å°†ä¸ä¼šé‡æ–°åˆ†é…
for i in 0 .. 1000 {
	numbers << i
}
```

> **æ³¨æ„** 
>
> ä¸Šè¿°ä»£ç ä½¿ç”¨äº†ä¸€ä¸ª[èŒƒå›´ `for` å¾ªç¯](https://chat.openai.com/?model=text-davinci-002-render-sha#range-for)è¯­å¥ã€‚

ä½ å¯ä»¥é€šè¿‡è®¿é—® `index` å˜é‡æ¥åˆå§‹åŒ–æ•°ç»„ï¼Œå®ƒä¼šç»™å‡ºå¦‚ä¸‹æ‰€ç¤ºçš„ç´¢å¼•ï¼š

```v
count := []int{len: 4, init: index}
assert count == [0, 1, 2, 3]

mut square := []int{len: 6, init: index * index}
// square == [0, 1, 4, 9, 16, 25]
```

#### æ•°ç»„ç±»å‹

ä¸€ä¸ªæ•°ç»„å¯ä»¥æ˜¯ä»¥ä¸‹ç±»å‹ä¹‹ä¸€ï¼š

| ç±»å‹         | ç¤ºä¾‹å®šä¹‰                             |
| ------------ | ------------------------------------ |
| æ•°å­—         | `[]int,[]i64`                        |
| å­—ç¬¦ä¸²       | `[]string`                           |
| ç¬¦æ–‡ï¼ˆå­—ç¬¦ï¼‰ | `[]rune`                             |
| å¸ƒå°”å€¼       | `[]bool`                             |
| æ•°ç»„         | `[][]int`                            |
| ç»“æ„ä½“       | `[]MyStructName`                     |
| é€šé“         | `[]chan f64`                         |
| å‡½æ•°         | `[]MyFunctionType` `[]fn (int) bool` |
| æ¥å£         | `[]MyInterfaceName`                  |
| åˆæˆç±»å‹     | `[]MySumTypeName`                    |
| æ³›å‹ç±»å‹     | `[]T`                                |
| æ˜ å°„ï¼ˆå­—å…¸ï¼‰ | `[]map[string]f64`                   |
| æšä¸¾         | `[]MyEnumType`                       |
| åˆ«å         | `[]MyAliasTypeName`                  |
| çº¿ç¨‹         | `[]thread int`                       |
| å¼•ç”¨         | `[]&f64`                             |
| å…±äº«         | `[]shared MyStructType`              |

**ç¤ºä¾‹ä»£ç :**

æ­¤ç¤ºä¾‹ä½¿ç”¨[ç»“æ„ä½“](#ç»“æ„ä½“)å’Œ[åˆæˆç±»å‹](#Sum Types (åˆæˆç±»å‹))æ¥åˆ›å»ºä¸€ä¸ªæ•°ç»„ï¼Œå¯ä»¥å¤„ç†ä¸åŒç±»å‹ï¼ˆä¾‹å¦‚ï¼Œç‚¹å’Œçº¿ï¼‰çš„æ•°æ®å…ƒç´ ã€‚

```v
struct Point {
	x int
	y int
}

struct Line {
	p1 Point
	p2 Point
}

type ObjectSumType = Line | Point

mut object_list := []ObjectSumType{}
object_list << Point{1, 1}
object_list << Line{
	p1: Point{3, 3}
	p2: Point{4, 4}
}
dump(object_list)
/*
object_list: [ObjectSumType(Point{
    x: 1
    y: 1
}), ObjectSumType(Line{
    p1: Point{
        x: 3
        y: 3
    }
    p2: Point{
        x: 4
        y: 4
    }
})]
*/
```

#### å¤šç»´æ•°ç»„

#### å¤šç»´æ•°ç»„

2ç»´æ•°ç»„ç¤ºä¾‹ï¼š

```v
mut a := [][]int{len: 2, init: []int{len: 3}}
a[0][1] = 2
println(a) // [[0, 2, 0], [0, 0, 0]]
```

3ç»´æ•°ç»„ç¤ºä¾‹ï¼š

```v
mut a := [][][]int{len: 2, init: [][]int{len: 3, init: []int{len: 2}}}
a[0][1][1] = 2
println(a) // [[[0, 0], [0, 2], [0, 0]], [[0, 0], [0, 0], [0, 0]]]
```

#### æ•°ç»„æ–¹æ³•

æ‰€æœ‰æ•°ç»„å¯ä»¥é€šè¿‡ `println(arr)` è½»æ¾æ‰“å°ï¼Œå¹¶å¯ä»¥é€šè¿‡ `s := arr.str()` è½¬æ¢ä¸ºå­—ç¬¦ä¸²ã€‚

ä½¿ç”¨ `.clone()` å¯ä»¥å¤åˆ¶æ•°ç»„ä¸­çš„æ•°æ®ï¼š

```v
nums := [1, 2, 3]
nums_copy := nums.clone()
```

æ•°ç»„å¯ä»¥é€šè¿‡ `.filter()` å’Œ `.map()` æ–¹æ³•é«˜æ•ˆåœ°è¿›è¡Œç­›é€‰å’Œæ˜ å°„ï¼š

```v
nums := [1, 2, 3, 4, 5, 6]
even := nums.filter(it % 2 == 0)
println(even) // [2, 4, 6]
// filterå¯ä»¥æ¥å—åŒ¿åå‡½æ•°
even_fn := nums.filter(fn (x int) bool {
	return x % 2 == 0
})
println(even_fn)
vCopy codewords := ['hello', 'world']
upper := words.map(it.to_upper())
println(upper) // ['HELLO', 'WORLD']
// mapä¹Ÿå¯ä»¥æ¥å—åŒ¿åå‡½æ•°
upper_fn := words.map(fn (w string) string {
	return w.to_upper()
})
println(upper_fn) // ['HELLO', 'WORLD']
```

`it` æ˜¯ä¸€ä¸ªå†…ç½®å˜é‡ï¼Œç”¨äºå¼•ç”¨å½“å‰åœ¨filter/mapæ–¹æ³•ä¸­å¤„ç†çš„å…ƒç´ ã€‚

æ­¤å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ `.any()` å’Œ `.all()` æ–¹æ³•æ–¹ä¾¿åœ°æµ‹è¯•æ»¡è¶³æ¡ä»¶çš„å…ƒç´ ã€‚

```v
nums := [1, 2, 3]
println(nums.any(it == 2)) // true
println(nums.all(it >= 2)) // false
```

è¿˜æœ‰ä¸€äº›ç”¨äºæ•°ç»„çš„å†…ç½®æ–¹æ³•ï¼š

- `a.repeat(n)` å°†æ•°ç»„å…ƒç´ é‡å¤ `n` æ¬¡
- `a.insert(i, val)` åœ¨ç´¢å¼• `i` å¤„æ’å…¥ä¸€ä¸ªæ–°å…ƒç´  `val`ï¼Œå¹¶å°†æ‰€æœ‰åç»­å…ƒç´ å‘å³ç§»åŠ¨
- `a.insert(i, [3, 4, 5])` æ’å…¥å¤šä¸ªå…ƒç´ 
- `a.prepend(val)` åœ¨å¼€å¤´æ’å…¥ä¸€ä¸ªå€¼ï¼Œç­‰æ•ˆäº `a.insert(0, val)`
- `a.prepend(arr)` åœ¨å¼€å¤´æ’å…¥æ•°ç»„ `arr` çš„å…ƒç´ 
- `a.trim(new_len)` æˆªæ–­é•¿åº¦ï¼ˆå¦‚æœ `new_length < a.len`ï¼Œå¦åˆ™ä»€ä¹ˆä¹Ÿä¸åšï¼‰
- `a.clear()` æ¸…ç©ºæ•°ç»„ä½†ä¸æ›´æ”¹ `cap`ï¼ˆç­‰æ•ˆäº `a.trim(0)`ï¼‰
- `a.delete_many(start, size)` ä»ç´¢å¼• `start` å¤„ç§»é™¤ `size` ä¸ªè¿ç»­å…ƒç´  - è§¦å‘é‡æ–°åˆ†é…
- `a.delete(index)` ç­‰æ•ˆäº `a.delete_many(index, 1)`
- `a.delete_last()` ç§»é™¤æœ€åä¸€ä¸ªå…ƒç´ 
- `a.first()` ç­‰æ•ˆäº `a[0]`
- `a.last()` ç­‰æ•ˆäº `a[a.len - 1]`
- `a.pop()` ç§»é™¤å¹¶è¿”å›æœ€åä¸€ä¸ªå…ƒç´ 
- `a.reverse()` ç”Ÿæˆä¸€ä¸ªä»¥ç›¸åé¡ºåºæ’åˆ—çš„æ–°æ•°ç»„
- `a.reverse_in_place()` é¢ å€’æ•°ç»„ä¸­å…ƒç´ çš„é¡ºåº
- `a.join(joiner)` å°†å­—ç¬¦ä¸²æ•°ç»„è¿æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä½¿ç”¨ `joiner` ä½œä¸ºåˆ†éš”ç¬¦

æŸ¥çœ‹ [array](https://modules.vlang.io/index.html#array) çš„æ‰€æœ‰æ–¹æ³•ã€‚

å¦è¯·å‚é˜… [vlib/arrays](https://modules.vlang.io/arrays.html)ã€‚

#### æ•°ç»„æ’åº

å¯¹æ‰€æœ‰ç±»å‹çš„æ•°ç»„è¿›è¡Œæ’åºéå¸¸ç®€å•ç›´è§‚ã€‚ç‰¹æ®Šå˜é‡ `a` å’Œ `b` åœ¨æä¾›è‡ªå®šä¹‰æ’åºæ¡ä»¶æ—¶ä¼šè¢«ä½¿ç”¨ã€‚

```v
mut numbers := [1, 3, 2]
numbers.sort() // 1, 2, 3
numbers.sort(a > b) // 3, 2, 1
vCopy codestruct User {
	age  int
	name string
}

mut users := [User{21, 'Bob'}, User{20, 'Zarkon'}, User{25, 'Alice'}]
users.sort(a.age < b.age) // æŒ‰ User.age int å­—æ®µæ’åº
users.sort(a.name > b.name) // æŒ‰ User.name string å­—æ®µåå‘æ’åº
```

Vè¿˜æ”¯æŒè‡ªå®šä¹‰æ’åºï¼Œé€šè¿‡ `sort_with_compare` æ•°ç»„æ–¹æ³•ã€‚å®ƒæœŸæœ›ä¸€ä¸ªæ¯”è¾ƒå‡½æ•°æ¥å®šä¹‰æ’åºé¡ºåºã€‚å¯ä»¥ç”¨äºæ ¹æ®è‡ªå®šä¹‰æ’åºè§„åˆ™åŒæ—¶åœ¨å¤šä¸ªå­—æ®µä¸Šè¿›è¡Œæ’åºã€‚ ä¸‹é¢çš„ä»£ç å¯¹æ•°ç»„æŒ‰ `name` å‡åºå’Œ `age` é™åºæ’åºã€‚

```v
struct User {
	age  int
	name string
}

mut users := [User{21, 'Bob'}, User{65, 'Bob'}, User{25, 'Alice'}]

custom_sort_fn := fn (a &User, b &User) int {
	// å½“ a åœ¨ b å‰é¢æ—¶è¿”å› -1
	// å½“ä¸¤è€…å¤„äºç›¸åŒé¡ºåºæ—¶è¿”å› 0
	// å½“ b åœ¨ a å‰é¢æ—¶è¿”å› 1
	if a.name == b.name {
		if a.age < b.age {
			return 1
		}
		if a.age > b.age {
			return -1
		}
		return 0
	}
	if a.name < b.name {
		return -1
	} else if a.name > b.name {
		return 1
	}
	return 0
}
users.sort_with_compare(custom_sort_fn)
```

#### æ•°ç»„åˆ‡ç‰‡

åˆ‡ç‰‡æ˜¯çˆ¶æ•°ç»„çš„ä¸€éƒ¨åˆ†ã€‚åˆå§‹æ—¶å®ƒæŒ‡å‘ç”± `..` è¿ç®—ç¬¦åˆ†éš”çš„ä¸¤ä¸ªç´¢å¼•ä¹‹é—´çš„å…ƒç´ ã€‚å³ä¾§ç´¢å¼•å¿…é¡»å¤§äºæˆ–ç­‰äºå·¦ä¾§ç´¢å¼•ã€‚

å¦‚æœå³ä¾§ç´¢å¼•ç¼ºå¤±ï¼Œå°†å‡å®šä¸ºæ•°ç»„é•¿åº¦ã€‚å¦‚æœå·¦ä¾§ç´¢å¼•ç¼ºå¤±ï¼Œåˆ™å‡å®šä¸º0ã€‚

```v
nums := [0, 10, 20, 30, 40]
println(nums[1..4]) // [10, 20, 30]
println(nums[..4]) // [0, 10, 20, 30]
println(nums[1..]) // [10, 20, 30, 40]
```

åœ¨Vä¸­ï¼Œåˆ‡ç‰‡æœ¬èº«ä¹Ÿæ˜¯æ•°ç»„ï¼ˆå®ƒä»¬ä¸æ˜¯ä¸åŒçš„ç±»å‹ï¼‰ã€‚å› æ­¤ï¼Œå¯ä»¥åœ¨å®ƒä»¬ä¸Šæ‰§è¡Œæ‰€æœ‰æ•°ç»„æ“ä½œã€‚ä¾‹å¦‚ï¼Œå®ƒä»¬å¯ä»¥æ¨é€åˆ°å…·æœ‰ç›¸åŒç±»å‹çš„æ•°ç»„ï¼š

```v
array_1 := [3, 5, 4, 7, 6]
mut array_2 := [0, 1]
array_2 << array_1[..3]
println(array_2) // `[0, 1, 3, 5, 4]`
```

åˆ‡ç‰‡æ€»æ˜¯ä½¿ç”¨æœ€å°å¯èƒ½çš„å®¹é‡åˆ›å»º `cap == len`ï¼ˆå‚è§[ä¸Šæ–‡](https://chat.openai.com/?model=text-davinci-002-render-sha#array-initialization)ä¸­çš„ `cap`ï¼‰ï¼Œ æ— è®ºçˆ¶æ•°ç»„çš„å®¹é‡æˆ–é•¿åº¦å¦‚ä½•ã€‚å› æ­¤ï¼Œå½“å¤§å°å¢åŠ æ—¶ï¼Œå®ƒå°†ç«‹å³é‡æ–°åˆ†é…å¹¶å¤åˆ¶åˆ°å¦ä¸€ä¸ªå†…å­˜ä½ç½®ï¼Œä»è€Œå˜å¾—ç‹¬ç«‹äºçˆ¶æ•°ç»„ï¼ˆ*åœ¨å¢é•¿æ—¶å¤åˆ¶*ï¼‰ã€‚ç‰¹åˆ«æ˜¯å‘åˆ‡ç‰‡ä¸­æ·»åŠ å…ƒç´ å¹¶ä¸ä¼šæ”¹å˜çˆ¶æ•°ç»„ï¼š

```v
mut a := [0, 1, 2, 3, 4, 5]
mut b := a[2..4]
b[0] = 7 // `b[0]` æŒ‡å‘ `a[2]`
println(a) // `[0, 1, 7, 3, 4, 5]`
b << 9
// `b` å·²ç»é‡æ–°åˆ†é…ï¼Œå¹¶ä¸”ç°åœ¨ç‹¬ç«‹äº `a`
println(a) // `[0, 1, 7, 3, 4, 5]` - æ²¡æœ‰å˜åŒ–
println(b) // `[7, 3, 9]`
```

å‘çˆ¶æ•°ç»„æ·»åŠ å…ƒç´ å¯èƒ½ä¼šä½¿å…¶ä¸å…¶å­åˆ‡ç‰‡ä¹‹é—´ç‹¬ç«‹æˆ–ä¸ç‹¬ç«‹ã€‚è¡Œä¸ºå–å†³äºçˆ¶æ•°ç»„çš„å®¹é‡ï¼Œå¹¶ä¸”æ˜¯å¯ä»¥é¢„æµ‹çš„ï¼š

```v
mut a := []int{len: 5, cap: 6, init: 2}
mut b := unsafe { a[1..4] }
a << 3
// ä¸ä¼šé‡æ–°åˆ†é… - é€‚åˆäº `cap`
b[2] = 13 // ä¿®æ”¹äº† `a[3]`
a << 4
// a å·²ç»é‡æ–°åˆ†é…ï¼Œç°åœ¨ä¸ `b` ç‹¬ç«‹ï¼ˆè¶…å‡ºäº† `cap`ï¼‰
b[1] = 3 // åœ¨ `a` ä¸­æ²¡æœ‰å˜åŒ–
println(a) // `[2, 2, 2, 13, 2, 3, 4]`
println(b) // `[2, 3, 13]`
```

å¦‚æœä½ æƒ³ç«‹å³è·å¾—ä¸€ä¸ªç‹¬ç«‹çš„å‰¯æœ¬ï¼Œä½ å¯ä»¥åœ¨åˆ‡ç‰‡ä¸Šè°ƒç”¨ `.clone()`ï¼š

```v
mut a := [0, 1, 2, 3, 4, 5]
mut b := a[2..4].clone()
b[0] = 7 // æ³¨æ„ï¼š`b[0]` ä¸æ˜¯æŒ‡å‘ `a[2]`ï¼Œå› ä¸ºæ²¡æœ‰ä½¿ç”¨ .clone() çš„è¯ï¼Œå®ƒå°†ä¼šæŒ‡å‘ a[2]
println(a) // [0, 1, 2, 3, 4, 5]
println(b) // [7, 3]
```

##### å¸¦æœ‰è´Ÿç´¢å¼•çš„åˆ‡ç‰‡

#### æ”¯æŒè´Ÿç´¢å¼•çš„æ•°ç»„å’Œå­—ç¬¦ä¸²åˆ‡ç‰‡

Væ”¯æŒå¸¦æœ‰è´Ÿç´¢å¼•çš„æ•°ç»„å’Œå­—ç¬¦ä¸²åˆ‡ç‰‡ã€‚ è´Ÿç´¢å¼•ä»æ•°ç»„çš„æœ«å°¾å‘å¼€å§‹è®¡ç®—ï¼Œä¾‹å¦‚ `-3` ç­‰åŒäº `array.len - 3`ã€‚ è´Ÿåˆ‡ç‰‡ä¸æ­£å¸¸åˆ‡ç‰‡å…·æœ‰ä¸åŒçš„è¯­æ³•ï¼Œå³ä½ éœ€è¦åœ¨æ•°ç»„åç§°å’Œæ–¹æ‹¬å·ä¹‹é—´æ·»åŠ ä¸€ä¸ª `gate`ï¼š`a#[..-3]`ã€‚ `gate` æŒ‡å®šè¿™æ˜¯ä¸€ç§ä¸åŒç±»å‹çš„åˆ‡ç‰‡ï¼Œå¹¶è®°ä½è¿”å›çš„åˆ‡ç‰‡ "é”å®š" åœ¨æ•°ç»„å†…ã€‚ è¿”å›çš„åˆ‡ç‰‡å§‹ç»ˆæ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„æ•°ç»„ï¼Œå°½ç®¡å¯èƒ½ä¸ºç©ºï¼š

```v
a := [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
println(a#[-3..]) // [7, 8, 9]
println(a#[-20..]) // [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
println(a#[-20..-8]) // [0, 1]
println(a#[..-3]) // [0, 1, 2, 3, 4, 5, 6]

// ç©ºæ•°ç»„
println(a#[-20..-10]) // []
println(a#[20..10]) // []
println(a#[20..30]) // []
```

#### æ•°ç»„æ–¹æ³•é“¾å¼è°ƒç”¨

ä½ å¯ä»¥é“¾å¼è°ƒç”¨æ•°ç»„æ–¹æ³•ï¼Œå¦‚ `.filter()` å’Œ `.map()`ï¼Œå¹¶ä½¿ç”¨å†…ç½®å˜é‡ `it` æ¥å®ç°ç»å…¸çš„ `map/filter` å‡½æ•°å¼ç¼–ç¨‹èŒƒå¼ï¼š

```v
// ä½¿ç”¨ filterã€map å’Œè´Ÿæ•°æ•°ç»„åˆ‡ç‰‡
files := ['pippo.jpg', '01.bmp', '_v.txt', 'img_02.jpg', 'img_01.JPG']
filtered := files.filter(it#[-4..].to_lower() == '.jpg').map(it.to_upper())
// ['PIPPO.JPG', 'IMG_02.JPG', 'IMG_01.JPG']
```

### å›ºå®šå¤§å°æ•°ç»„

Vè¿˜æ”¯æŒå…·æœ‰å›ºå®šå¤§å°çš„æ•°ç»„ã€‚ä¸æ™®é€šæ•°ç»„ä¸åŒï¼Œå®ƒä»¬çš„é•¿åº¦æ˜¯æ’å®šçš„ã€‚ä½ ä¸èƒ½å‘å®ƒä»¬æ·»åŠ å…ƒç´ ï¼Œä¹Ÿä¸èƒ½ç¼©å°å®ƒä»¬ã€‚ä½ åªèƒ½åœ¨åŸåœ°ä¿®æ”¹å®ƒä»¬çš„å…ƒç´ ã€‚

ç„¶è€Œï¼Œè®¿é—®å›ºå®šå¤§å°æ•°ç»„çš„å…ƒç´ æ›´é«˜æ•ˆï¼Œå®ƒä»¬éœ€è¦çš„å†…å­˜æ¯”æ™®é€šæ•°ç»„å°‘ï¼Œå¹¶ä¸”ä¸æ™®é€šæ•°ç»„ä¸åŒï¼Œå®ƒä»¬çš„æ•°æ®ä½äºå †æ ˆä¸Šï¼Œå› æ­¤å¦‚æœä½ ä¸æƒ³è¿›è¡Œé¢å¤–çš„å †åˆ†é…ï¼Œå¯ä»¥å°†å®ƒä»¬ç”¨ä½œç¼“å†²åŒºã€‚

å¤§å¤šæ•°æ–¹æ³•è¢«å®šä¹‰ä¸ºåœ¨æ™®é€šæ•°ç»„ä¸Šå·¥ä½œï¼Œè€Œä¸æ˜¯åœ¨å›ºå®šå¤§å°æ•°ç»„ä¸Šå·¥ä½œã€‚ ä½ å¯ä»¥ä½¿ç”¨åˆ‡ç‰‡å°†å›ºå®šå¤§å°æ•°ç»„è½¬æ¢ä¸ºæ™®é€šæ•°ç»„ï¼š

```v
mut fnums := [3]int{} // fnums æ˜¯ä¸€ä¸ªå…·æœ‰3ä¸ªå…ƒç´ çš„å›ºå®šå¤§å°æ•°ç»„ã€‚
fnums[0] = 1
fnums[1] = 10
fnums[2] = 100
println(fnums) // => [1, 10, 100]
println(typeof(fnums).name) // => [3]int

fnums2 := [1, 10, 100]! // æ‰§è¡Œç›¸åŒæ“ä½œçš„ç®€çŸ­åˆå§‹åŒ–è¯­æ³•ï¼ˆè¯¥è¯­æ³•å¯èƒ½ä¼šæ›´æ”¹ï¼‰

anums := fnums[..] // ä¸ `anums := fnums[0..fnums.len]` ç›¸åŒ
println(anums) // => [1, 10, 100]
println(typeof(anums).name) // => []int
```

è¯·æ³¨æ„ï¼Œåˆ‡ç‰‡å°†å¯¼è‡´å›ºå®šå¤§å°æ•°ç»„çš„æ•°æ®è¢«å¤åˆ¶åˆ°æ–°åˆ›å»ºçš„æ™®é€šæ•°ç»„ä¸­ã€‚

### Maps

```v
mut m := map[string]int{} // ä¸€ä¸ªé”®ä¸º `string` ç±»å‹ï¼Œå€¼ä¸º `int` ç±»å‹çš„æ˜ å°„
m['one'] = 1
m['two'] = 2
println(m['one']) // "1"
println(m['bad_key']) // "0"
println('bad_key' in m) // ä½¿ç”¨ `in` æ¥æ£€æµ‹æ˜¯å¦å­˜åœ¨è¯¥é”®
println(m.keys()) // ['one', 'two']
m.delete('two')
```

æ˜ å°„å¯ä»¥æ‹¥æœ‰ `string`ã€`rune`ã€æ•´æ•°ã€æµ®ç‚¹æ•°æˆ– `voidptr` ç±»å‹çš„é”®ã€‚

å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ç®€çŸ­çš„è¯­æ³•æ¥åˆå§‹åŒ–æ•´ä¸ªæ˜ å°„ï¼š

```v
numbers := {
	'one': 1
	'two': 2
}
println(numbers)
```

å¦‚æœæ‰¾ä¸åˆ°é”®ï¼Œåˆ™é»˜è®¤è¿”å›é›¶å€¼ï¼š

```v
sm := {
	'abc': 'xyz'
}
val := sm['bad_key']
println(val) // ''
```

```v
intm := {
	1: 1234
	2: 5678
}
s := intm[3]
println(s) // 0
```

è¿˜å¯ä»¥ä½¿ç”¨ `or {}` å—æ¥å¤„ç†ä¸å­˜åœ¨çš„é”®ï¼š

```v
mm := map[string]int{}
val := mm['bad_key'] or { panic('key not found') }
```

ä½ è¿˜å¯ä»¥ä¸€æ¬¡æ€§æ£€æŸ¥é”®æ˜¯å¦å­˜åœ¨ï¼Œå¹¶åœ¨é”®å­˜åœ¨æ—¶è·å–å…¶å€¼ï¼š

```v
m := {
	'abc': 'def'
}
if v := m['abc'] {
	println('è¯¥é”®çš„æ˜ å°„å€¼æ˜¯: ${v}')
}
```

ç›¸åŒçš„é€‰é¡¹æ£€æŸ¥ä¹Ÿé€‚ç”¨äºæ•°ç»„ï¼š

```v
arr := [1, 2, 3]
large_index := 999
val := arr[large_index] or { panic('out of bounds') }
println(val)
// å¦‚æœä½ æƒ³*ä¼ æ’­*è®¿é—®é”™è¯¯ï¼Œä¹Ÿå¯ä»¥è¿™æ ·åšï¼š
val2 := arr[333]!
println(val2)
```

Vè¿˜æ”¯æŒåµŒå¥—æ˜ å°„ï¼š

```v
mut m := map[string]map[string]int{}
m['greet'] = {
	'Hello': 1
}
m['place'] = {
	'world': 2
}
m['code']['orange'] = 123
print(m)
```

æ˜ å°„æ˜¯æŒ‰æ’å…¥é¡ºåºæ’åºçš„ï¼Œç±»ä¼¼äºPythonä¸­çš„å­—å…¸ã€‚è¿™æ˜¯ä¸€ç§ä¿è¯çš„è¯­è¨€ç‰¹æ€§ï¼Œä½†å°†æ¥å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚

æŸ¥çœ‹æ‰€æœ‰[æ˜ å°„çš„æ–¹æ³•](https://modules.vlang.io/index.html#map)å’Œ[maps](https://modules.vlang.io/maps.html)ã€‚

## æ¨¡å—å¯¼å…¥

æœ‰å…³åˆ›å»ºæ¨¡å—çš„ä¿¡æ¯ï¼Œè¯·å‚é˜…[æ¨¡å—](#modules)ã€‚

å¯ä»¥ä½¿ç”¨ `import` å…³é”®å­—å¯¼å…¥æ¨¡å—ï¼š

```v
import os

fn main() {
	// ä»stdinè¯»å–æ–‡æœ¬
	name := os.input('è¯·è¾“å…¥æ‚¨çš„å§“åï¼š')
	println('ä½ å¥½ï¼Œ${name}ï¼')
}
```

è¿™ä¸ªç¨‹åºå¯ä»¥ä½¿ç”¨ `os` æ¨¡å—ä¸­çš„ä»»ä½•å…¬å…±å®šä¹‰ï¼Œæ¯”å¦‚ `input` å‡½æ•°ã€‚è¯·å‚é˜…[æ ‡å‡†åº“](https://modules.vlang.io/)æ–‡æ¡£ä»¥è·å–å¸¸è§æ¨¡å—åŠå…¶å…¬å…±ç¬¦å·çš„åˆ—è¡¨ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯æ¬¡è°ƒç”¨å¤–éƒ¨å‡½æ•°æ—¶éƒ½å¿…é¡»æŒ‡å®šæ¨¡å—å‰ç¼€ã€‚èµ·åˆå¯èƒ½ä¼šæ˜¾å¾—å†—é•¿ï¼Œä½†è¿™ä½¿å¾—ä»£ç æ›´æ˜“è¯»å’Œç†è§£ - æ€»æ˜¯æ¸…æ¥šåœ°çŸ¥é“æ­£åœ¨è°ƒç”¨å“ªä¸ªæ¨¡å—ä¸­çš„å“ªä¸ªå‡½æ•°ã€‚è¿™åœ¨å¤§å‹ä»£ç åº“ä¸­ç‰¹åˆ«æœ‰ç”¨ã€‚

ä¸å…è®¸å¾ªç¯å¯¼å…¥æ¨¡å—ï¼Œä¸Goè¯­è¨€ç±»ä¼¼ã€‚

### é€‰æ‹©æ€§å¯¼å…¥

æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥ä»æ¨¡å—ä¸­å¯¼å…¥ç‰¹å®šçš„å‡½æ•°å’Œç±»å‹ï¼š

```v
import os { input }

fn main() {
	// ä»stdinè¯»å–æ–‡æœ¬
	name := input('è¯·è¾“å…¥æ‚¨çš„å§“åï¼š')
	println('ä½ å¥½ï¼Œ${name}ï¼')
}
```

> **æ³¨æ„**
> è¿™ä¹Ÿå°†å¯¼å…¥æ¨¡å—æœ¬èº«ã€‚æ­¤å¤–ï¼Œä¸èƒ½ç”¨äºå¸¸é‡ - å®ƒä»¬å¿…é¡»å§‹ç»ˆå¸¦æœ‰å‰ç¼€ã€‚

æ‚¨å¯ä»¥ä¸€æ¬¡å¯¼å…¥å¤šä¸ªç‰¹å®šç¬¦å·ï¼š

```v
import os { input, user_os }

name := input('è¯·è¾“å…¥æ‚¨çš„å§“åï¼š')
println('å§“åï¼š${name}')
current_os := user_os()
println('æ‚¨çš„æ“ä½œç³»ç»Ÿæ˜¯${current_os}ã€‚')
```

### æ¨¡å—å¯¼å…¥åˆ«å

å¯ä»¥ä½¿ç”¨ `as` å…³é”®å­—å¯¹ä»»ä½•å¯¼å…¥çš„æ¨¡å—åç§°è¿›è¡Œåˆ«åï¼š

> **æ³¨æ„**
> é™¤éæ‚¨å·²åˆ›å»ºäº† `mymod/sha256.v`ï¼Œå¦åˆ™æ­¤ç¤ºä¾‹å°†æ— æ³•ç¼–è¯‘ã€‚

```v failcompile
import crypto.sha256
import mymod.sha256 as mysha256

fn main() {
	v_hash := sha256.sum('hi'.bytes()).hex()
	my_hash := mysha256.sum('hi'.bytes()).hex()
	assert my_hash == v_hash
}
```

æ‚¨ä¸èƒ½ä¸ºå¯¼å…¥çš„å‡½æ•°æˆ–ç±»å‹è®¾ç½®åˆ«åã€‚ä½†æ˜¯ï¼Œæ‚¨å¯ä»¥é‡æ–°å£°æ˜ç±»å‹ã€‚

```v
import time
import math

type MyTime = time.Time

fn (mut t MyTime) century() int {
	return int(1.0 + math.trunc(f64(t.year) * 0.009999794661191))
}

fn main() {
	mut my_time := MyTime{
		year: 2020
		month: 12
		day: 25
	}
	println(time.new_time(my_time).utc_string())
	println('Century: ${my_time.century()}')
}
```

## è¯­å¥å’Œè¡¨è¾¾å¼

### If

```v
a := 10
b := 20
if a < b {
	println('${a} < ${b}')
} else if a > b {
	println('${a} > ${b}')
} else {
	println('${a} == ${b}')
}
```

`if` è¯­å¥éå¸¸ç›´è§‚ï¼Œä¸å¤§å¤šæ•°å…¶ä»–è¯­è¨€ç±»ä¼¼ã€‚ä¸å…¶ä»–ç±»ä¼¼Cçš„è¯­è¨€ä¸åŒï¼Œæ¡ä»¶å‘¨å›´æ²¡æœ‰æ‹¬å·ï¼Œå¤§æ‹¬å·å§‹ç»ˆæ˜¯å¿…éœ€çš„ã€‚

`if` å¯ä»¥ç”¨ä½œè¡¨è¾¾å¼ï¼š

```v
num := 777
s := if num % 2 == 0 { 'even' } else { 'odd' }
println(s)
// "odd"
```

æ‚¨å¯ä»¥åœ¨ä»»ä½•å¯ä»¥ä½¿ç”¨ `or {}` çš„åœ°æ–¹ä½¿ç”¨â€œifè§£åŒ…â€ã€‚è¿™ä¼šå°†è¡¨è¾¾å¼çš„è§£åŒ…å€¼ç»‘å®šåˆ°ä¸€ä¸ªå˜é‡ï¼Œå½“è¯¥è¡¨è¾¾å¼æ—¢ä¸æ˜¯`none`ä¹Ÿä¸æ˜¯é”™è¯¯æ—¶ã€‚

```v
m := {
	'foo': 'bar'
}

// å¤„ç†ç¼ºå°‘çš„é”®
if v := m['foo'] {
	println(v) // bar
} else {
	println('not found')
}
```

```v
fn res() !int {
	return 42
}

// è¿”å›ç»“æœç±»å‹çš„å‡½æ•°
if v := res() {
	println(v)
}
```

```v
struct User {
	name string
}

arr := [User{'John'}]

// å¸¦æœ‰å˜é‡èµ‹å€¼çš„ if è§£åŒ…
u_name := if v := arr[0] {
	v.name
} else {
	'Unnamed'
}
println(u_name) // John
```

#### ç±»å‹æ£€æŸ¥å’Œç±»å‹è½¬æ¢

æ‚¨å¯ä»¥ä½¿ç”¨ `is` å’Œå…¶å¦å®šå½¢å¼ `!is` æ¥æ£€æŸ¥å’Œåˆ¤æ–­å½“å‰å’Œæ€»å’Œç±»å‹ã€‚

å¯ä»¥åœ¨ `if` ä¸­æ‰§è¡Œï¼š

```v cgen
struct Abc {
	val string
}

struct Xyz {
	foo string
}

type Alphabet = Abc | Xyz

x := Alphabet(Abc{'test'}) // æ€»å’Œç±»å‹
if x is Abc {
	// x ä¼šè‡ªåŠ¨è½¬ä¸º Abc ç±»å‹ï¼Œå¯ä»¥åœ¨è¿™é‡Œä½¿ç”¨
	println(x)
}
if x !is Abc {
	println('ä¸æ˜¯ Abc')
}
```

æˆ–ä½¿ç”¨ `match`ï¼š

```v oksyntax
match x {
	Abc {


		// x ä¼šè‡ªåŠ¨è½¬ä¸º Abc ç±»å‹ï¼Œå¯ä»¥åœ¨è¿™é‡Œä½¿ç”¨
		println(x)
	}
	Xyz {
		// x ä¼šè‡ªåŠ¨è½¬ä¸º Xyz ç±»å‹ï¼Œå¯ä»¥åœ¨è¿™é‡Œä½¿ç”¨
		println(x)
	}
}
```

è¿™ä¹Ÿé€‚ç”¨äºç»“æ„å­—æ®µï¼š

```v
struct MyStruct {
	x int
}

struct MyStruct2 {
	y string
}

type MySumType = MyStruct | MyStruct2

struct Abc {
	bar MySumType
}

x := Abc{
	bar: MyStruct{123} // MyStruct å°†è‡ªåŠ¨è½¬æ¢ä¸º MySumType ç±»å‹
}
if x.bar is MyStruct {
	// x.bar ä¼šè‡ªåŠ¨è½¬æ¢
	println(x.bar)
} else if x.bar is MyStruct2 {
	new_var := x.bar as MyStruct2
	// ... æˆ–è€…ä½ å¯ä»¥ä½¿ç”¨ `as` æ‰‹åŠ¨åˆ›å»ºç±»å‹è½¬æ¢çš„åˆ«åï¼š
	println(new_var)
}
match x.bar {
	MyStruct {
		// x.bar ä¼šè‡ªåŠ¨è½¬æ¢
		println(x.bar)
	}
	else {}
}
```

å¯å˜å˜é‡å¯ä»¥å‘ç”Ÿå˜åŒ–ï¼Œè¿›è¡Œç±»å‹è½¬æ¢å°†æ˜¯ä¸å®‰å…¨çš„ã€‚
ç„¶è€Œï¼Œæœ‰æ—¶å€™å°½ç®¡æ˜¯å¯å˜çš„ï¼Œç±»å‹è½¬æ¢ä¹Ÿæ˜¯æœ‰ç”¨çš„ã€‚
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¼€å‘äººå‘˜å¿…é¡»ä½¿ç”¨ `mut` å…³é”®å­—æ ‡è®°è¡¨è¾¾å¼ï¼Œ
ä»¥å‘Šè¯‰ç¼–è¯‘å™¨ä»–ä»¬çŸ¥é“è‡ªå·±åœ¨åšä»€ä¹ˆã€‚

å®ƒçš„å·¥ä½œåŸç†å¦‚ä¸‹ï¼š

```v oksyntax
mut x := MySumType(MyStruct{123})
if mut x is MyStruct {
	// å³ä½¿æ˜¯å¯å˜çš„ï¼Œx ä¹Ÿä¼šè½¬ä¸º MyStruct
	// æ²¡æœ‰ mut å…³é”®å­—å°±ä¸ä¼šç”Ÿæ•ˆ
	println(x)
}
// ä¸ match ç›¸åŒ
match mut x {
	MyStruct {
		// å³ä½¿æ˜¯å¯å˜çš„ï¼Œx ä¹Ÿä¼šè½¬ä¸º MyStruct
		// æ²¡æœ‰ mut å…³é”®å­—å°±ä¸ä¼šç”Ÿæ•ˆ
		println(x)
	}
}
```

### Match

```v
os := 'windows'
print('V is running on ')
match os {
	'darwin' { println('macOS.') }
	'linux' { println('Linux.') }
	else { println(os) }
}
```

A `match`è¯­å¥æ˜¯ä¸€ç§æ›´ç®€æ´çš„æ–¹å¼æ¥ç¼–å†™ä¸€ç³»åˆ—çš„`if - else`è¯­å¥ã€‚å½“åŒ¹é…åˆ°åŒ¹é…åˆ†æ”¯æ—¶ï¼Œå°†æ‰§è¡Œåç»­çš„è¯­å¥å—ã€‚å½“æ²¡æœ‰å…¶ä»–åˆ†æ”¯åŒ¹é…æ—¶ï¼Œå°†æ‰§è¡Œ`else`åˆ†æ”¯ã€‚

```v
number := 2
s := match number {
	1 { 'one' }
	2 { 'two' }
	else { 'many' }
}
```

`match`è¯­å¥è¿˜å¯ä»¥ç”¨ä½œ`if - else if - else`çš„æ›¿ä»£å½¢å¼ï¼š

```v
match true {
	2 > 4 { println('if') }
	3 == 4 { println('else if') }
	2 == 2 { println('else if2') }
	else { println('else') }
}
// åº”è¯¥æ‰“å°'else if2'
```

æˆ–ä½œä¸º`unless`çš„æ›¿ä»£å½¢å¼ï¼š[unless Ruby](https://www.tutorialspoint.com/ruby/ruby_if_else.htm)

```v
match false {
	2 > 4 { println('if') }
	3 == 4 { println('else if') }
	2 == 2 { println('else if2') }
	else { println('else') }
}
// åº”è¯¥æ‰“å°'if'
```

`match`è¡¨è¾¾å¼è¿”å›åŒ¹é…åˆ†æ”¯çš„æœ€ç»ˆè¡¨è¾¾å¼çš„å€¼ã€‚

```v
enum Color {
	red
	blue
	green
}

fn is_red_or_blue(c Color) bool {
	return match c {
		.red, .blue { true } // é€—å·å¯ä»¥ç”¨äºæµ‹è¯•å¤šä¸ªå€¼
		.green { false }
	}
}
```

`match`è¯­å¥è¿˜å¯ä»¥ç”¨äºåˆ†æ”¯`enum`çš„å˜ä½“ï¼Œä½¿ç”¨ç¼©å†™çš„`.variant_here`è¯­æ³•ã€‚å½“æ‰€æœ‰åˆ†æ”¯éƒ½æ˜¯è¯¦å°½æ— é—æ—¶ï¼Œä¸å…è®¸ä½¿ç”¨`else`åˆ†æ”¯ã€‚

```v
c := `v`
typ := match c {
	`0`...`9` { 'digit' }
	`A`...`Z` { 'uppercase' }
	`a`...`z` { 'lowercase' }
	else { 'other' }
}
println(typ)
// 'lowercase'
```

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨èŒƒå›´ä½œä¸º`match`æ¨¡å¼ã€‚å¦‚æœå€¼è½åœ¨åˆ†æ”¯èŒƒå›´å†…ï¼Œå°†æ‰§è¡Œè¯¥åˆ†æ”¯ã€‚

è¯·æ³¨æ„ï¼ŒèŒƒå›´ä½¿ç”¨`...`ï¼ˆä¸‰ä¸ªç‚¹ï¼‰è€Œä¸æ˜¯`..`ï¼ˆä¸¤ä¸ªç‚¹ï¼‰ã€‚è¿™æ˜¯å› ä¸ºèŒƒå›´*åŒ…å«*æœ€åä¸€ä¸ªå…ƒç´ ï¼Œè€Œä¸æ˜¯æ’é™¤ï¼ˆå¦‚`..`èŒƒå›´ä¸€æ ·ï¼‰ã€‚åœ¨`match`åˆ†æ”¯ä¸­ä½¿ç”¨`..`å°†å¼•å‘é”™è¯¯ã€‚

```v
const start = 1

const end = 10

c := 2
num := match c {
	start...end {
		1000
	}
	else {
		0
	}
}
println(num)
// 1000
```

å¸¸é‡ä¹Ÿå¯ä»¥åœ¨èŒƒå›´åˆ†æ”¯è¡¨è¾¾å¼ä¸­ä½¿ç”¨ã€‚

> **æ³¨æ„**
> ä½œä¸ºè¡¨è¾¾å¼çš„`match`åœ¨`for`å¾ªç¯å’Œ`if`è¯­å¥ä¸­æ— æ³•ä½¿ç”¨ã€‚

### In æ“ä½œç¬¦

`in`å…è®¸æ£€æŸ¥æ•°ç»„æˆ–æ˜ å°„æ˜¯å¦åŒ…å«å…ƒç´ ã€‚è¦æ‰§è¡Œç›¸åçš„æ“ä½œï¼Œè¯·ä½¿ç”¨`!in`ã€‚

```v
nums := [1, 2, 3]
println(1 in nums) // true
println(4 !in nums) // true
```

> **æ³¨æ„**
> `in`æ£€æŸ¥æ˜ å°„æ˜¯å¦åŒ…å«é”®ï¼Œè€Œä¸æ˜¯å€¼ã€‚

```v
m := {
	'one': 1
	'two': 2
}

println('one' in m) // true
println('three' !in m) // true
```

å®ƒè¿˜ç”¨äºç¼–å†™æ›´æ¸…æ™°å’Œæ›´ç´§å‡‘çš„å¸ƒå°”è¡¨è¾¾å¼ï¼š

```v
enum Token {
	plus
	minus
	div
	mult
}

struct Parser {
	token Token
}

parser := Parser{}
if parser.token == .plus || parser.token == .minus || parser.token == .div || parser.token == .mult {
	// ...
}
if parser.token in [.plus, .minus, .div, .mult] {
	// ...
}
```

Vä¼šä¼˜åŒ–è¿™ç§è¡¨è¾¾å¼ï¼Œå› æ­¤ä¸Šé¢çš„ä¸¤ä¸ª`if`è¯­å¥äº§ç”Ÿç›¸åŒçš„æœºå™¨ä»£ç ï¼Œä¸ä¼šåˆ›å»ºæ•°ç»„ã€‚

### For å¾ªç¯

Våªæœ‰ä¸€ä¸ªå¾ªç¯å…³é”®å­—ï¼š`for`ï¼Œæœ‰å‡ ç§å½¢å¼ã€‚

#### `for`/`in`

è¿™æ˜¯æœ€å¸¸è§çš„å½¢å¼ã€‚æ‚¨å¯ä»¥å°†å…¶ä¸æ•°ç»„ã€æ˜ å°„æˆ–æ•°å€¼èŒƒå›´ä¸€èµ·ä½¿ç”¨ã€‚

##### æ•°ç»„`for`

```v
numbers := [1, 2, 3, 4, 5]
for num in numbers {
	println(num)
}
names := ['Sam', 'Peter']
for i, name in names {
	println('${i}) ${name}')
	// è¾“å‡ºï¼š0) Sam
	//         1) Peter
}
```

`for value in arr`å½¢å¼ç”¨äºéå†æ•°ç»„çš„å…ƒç´ ã€‚å¦‚æœéœ€è¦ç´¢å¼•ï¼Œå¯ä»¥ä½¿ç”¨å¦ä¸€ç§å½¢å¼`for index, value in arr`ã€‚

è¯·æ³¨æ„ï¼Œè¯¥å€¼æ˜¯åªè¯»çš„ã€‚
å¦‚æœéœ€è¦åœ¨å¾ªç¯æ—¶ä¿®æ”¹æ•°ç»„ï¼Œåˆ™éœ€è¦å°†å…ƒç´ å£°æ˜ä¸ºå¯å˜çš„ï¼š

```v
mut numbers := [0, 1, 2]
for mut num in numbers {
	num++
}
println(numbers) // [1, 2, 3]
```

å½“æ ‡è¯†ç¬¦åªæ˜¯ä¸€ä¸ªä¸‹åˆ’çº¿æ—¶ï¼Œå®ƒå°†è¢«å¿½ç•¥ã€‚

##### è‡ªå®šä¹‰è¿­ä»£å™¨

å®ç°è¿”å›`Option`çš„`next`æ–¹æ³•çš„ç±»å‹å¯ä»¥ä½¿ç”¨`for`å¾ªç¯è¿›è¡Œè¿­ä»£ã€‚

```v
struct SquareIterator {
	arr []int
mut:
	idx int
}

fn (mut iter SquareIterator) next() ?int {
	if iter.idx >= iter.arr.len {
		return none
	}
	defer {
		iter.idx++
	}
	return iter.arr[iter.idx] * iter.arr[iter.idx]
}

nums := [1, 2, 3, 4, 5]
iter := SquareIterator{
	arr: nums
}
for squared in iter {
	println(squared)
}
```

ä¸Šé¢çš„ä»£ç æ‰“å°ï¼š

```
1
4
9
16
25
```

##### éå†Mapçš„ `for`

```v
m := {
	'one': 1
	'two': 2
}
for key, value in m {
	println('${key} -> ${value}')
	// è¾“å‡ºï¼šone -> 1
	//         two -> 2
}
```

é”®æˆ–å€¼å¯ä»¥ä½¿ç”¨å•ä¸ªä¸‹åˆ’çº¿ä½œä¸ºæ ‡è¯†ç¬¦æ¥å¿½ç•¥ã€‚

```v


m := {
	'one': 1
	'two': 2
}
// éå†é”®
for key, _ in m {
	println(key)
	// è¾“å‡ºï¼šone
	//         two
}
// éå†å€¼
for _, value in m {
	println(value)
	// è¾“å‡ºï¼š1
	//         2
}
```

##### èŒƒå›´`for`

```v
// æ‰“å°'01234'
for i in 0 .. 5 {
	print(i)
}
```

`low..high`è¡¨ç¤ºä¸€ä¸ª*ç‹¬å *èŒƒå›´ï¼Œè¡¨ç¤ºä»`low`åˆ°`high`ä¹‹é—´çš„æ‰€æœ‰å€¼ï¼Œä½†*ä¸åŒ…æ‹¬*`high`ã€‚

#### å¸¦æœ‰æ¡ä»¶çš„`for`

```v
mut sum := 0
mut i := 0
for i <= 100 {
	sum += i
	i++
}
println(sum) // "5050"
```

è¿™ç§å½¢å¼çš„å¾ªç¯ç±»ä¼¼äºå…¶ä»–è¯­è¨€ä¸­çš„`while`å¾ªç¯ã€‚ä¸€æ—¦å¸ƒå°”æ¡ä»¶è¯„ä¼°ä¸º`false`ï¼Œå¾ªç¯å°†åœæ­¢è¿­ä»£ã€‚å†æ¬¡å¼ºè°ƒï¼Œæ²¡æœ‰æ‹¬å·æ‹¬ä½æ¡ä»¶ï¼Œæ‹¬å·å§‹ç»ˆæ˜¯å¿…éœ€çš„ã€‚

#### ä¸å¸¦æœ‰æ¡ä»¶çš„`for`

```v
mut num := 0
for {
	num += 2
	if num >= 10 {
		break
	}
}
println(num) // "10"
```

æ¡ä»¶å¯ä»¥è¢«çœç•¥ï¼Œå¯¼è‡´ä¸€ä¸ªæ— é™å¾ªç¯ã€‚

#### Cé£æ ¼çš„`for`

```v
for i := 0; i < 10; i += 2 {
	// ä¸è¦æ‰“å°6
	if i == 6 {
		continue
	}
	println(i)
}
```

æœ€åï¼Œè¿˜æœ‰ä¼ ç»Ÿçš„Cæ ·å¼`for`å¾ªç¯ã€‚ä¸åè€…ç›¸æ¯”ï¼Œå®ƒæ›´å®‰å…¨ï¼Œå› ä¸ºå®¹æ˜“å¿˜è®°æ›´æ–°è®¡æ•°å™¨å¹¶é™·å…¥æ— é™å¾ªç¯ã€‚

åœ¨è¿™é‡Œï¼Œ`i`ä¸éœ€è¦ç”¨`mut`å£°æ˜ï¼Œå› ä¸ºæ ¹æ®å®šä¹‰ï¼Œå®ƒå°†å§‹ç»ˆæ˜¯å¯å˜çš„ã€‚

#### æ ‡è®°çš„breakå’Œcontinue

`break`å’Œ`continue`é»˜è®¤æ§åˆ¶æœ€å†…å±‚çš„`for`å¾ªç¯ã€‚æ‚¨è¿˜å¯ä»¥åœ¨`break`å’Œ`continue`åé¢åŠ ä¸Šä¸€ä¸ªæ ‡ç­¾åç§°ï¼Œä»¥å¼•ç”¨å¤–éƒ¨çš„`for`å¾ªç¯ï¼š

```v
outer: for i := 4; true; i++ {
	println(i)
	for {
		if i < 7 {
			continue outer
		} else {
			break outer
		}
	}
}
```

æ ‡ç­¾å¿…é¡»ç´§éšå¤–éƒ¨å¾ªç¯ä¹‹å‰ã€‚
ä¸Šé¢çš„ä»£ç ä¼šæ‰“å°ï¼š

```
4
5
6
7
```

### defer

å»¶è¿Ÿæ‰§è¡Œè¯­å¥å°†ä¸€ç»„è¯­å¥çš„æ‰§è¡Œæ¨è¿Ÿåˆ°åŒ…å›´å‡½æ•°è¿”å›ä¹‹å‰ã€‚

```v
import os

fn read_log() {
	mut ok := false
	mut f := os.open('log.txt') or { panic(err) }
	defer {
		f.close()
	}
	// ...
	if !ok {
		// åœ¨è¿™é‡Œå°†è°ƒç”¨å»¶è¿Ÿæ‰§è¡Œè¯­å¥ï¼Œæ–‡ä»¶å°†è¢«å…³é—­
		return
	}
	// ...
	// åœ¨è¿™é‡Œå°†è°ƒç”¨å»¶è¿Ÿæ‰§è¡Œè¯­å¥ï¼Œæ–‡ä»¶å°†è¢«å…³é—­
}
```

å¦‚æœå‡½æ•°è¿”å›ä¸€ä¸ªå€¼ï¼Œåˆ™åœ¨è¯„ä¼°è¿”å›è¡¨è¾¾å¼ä¹‹åæ‰§è¡Œ`defer`å—ï¼š

```v
import os

enum State {
	normal
	write_log
	return_error
}

// å†™æ—¥å¿—æ–‡ä»¶å¹¶è¿”å›å†™å…¥çš„å­—èŠ‚æ•°

fn write_log(s State) !int {
	mut f := os.create('log.txt')!
	defer {
		f.close()
	}
	if s == .write_log {
		// åœ¨æ‰§è¡Œ`f.write()`ä¹‹åä½†åœ¨æœ€ç»ˆè¿”å›å†™å…¥çš„å­—èŠ‚æ•°ä¹‹å‰å°†è°ƒç”¨`f.close()`
		return f.writeln('This is a log file')
	} else if s == .return_error {
		// åœ¨`error()`å‡½æ•°è¿”å›åï¼Œæ–‡ä»¶å°†è¢«å…³é—­ - å› æ­¤é”™è¯¯æ¶ˆæ¯ä»å°†æŠ¥å‘Š
		// å®ƒä¸ºæ‰“å¼€çŠ¶æ€
		return error('nothing written; file open: ${f.is_opened}')
	}
	// æ–‡ä»¶ä¹Ÿå°†åœ¨è¿™é‡Œå…³é—­
	return 0
}

fn main() {
	n := write_log(.return_error) or {
		println('Error: ${err}')
		0
	}
	println('${n} bytes written')
}
```

è¦åœ¨`defer`å—å†…è®¿é—®å‡½æ•°çš„ç»“æœï¼Œå¯ä»¥ä½¿ç”¨`$res()`è¡¨è¾¾å¼ã€‚
å½“è¿”å›å•ä¸ªå€¼æ—¶æ‰ä½¿ç”¨`$res()`ï¼Œè€Œåœ¨å¤šè¿”å›æƒ…å†µä¸‹ä½¿ç”¨`$res(idx)`æ˜¯æœ‰å‚æ•°çš„ã€‚

```v ignore
fn (mut app App) auth_middleware() bool {
	defer {
		if !$res() {
			app.response.status_code = 401
			app.response.body = 'Unauthorized'
		}
	}
	header := app.get_header('Authorization')
	if header == '' {
		return false
	}
	return true
}

fn (mut app App) auth_with_user_middleware() (bool, string) {
	defer {
		if !$res(0) {
			app.response.status_code = 401
			app.response.body = 'Unauthorized'
		} else {
			app.user = $res(1)
		}
	}
	header := app.get_header('Authorization')
	if header == '' {
		return false, ''
	}
	return true, 'TestUser'
}
```

### Goto

Vå…è®¸ä½¿ç”¨`goto`æ— æ¡ä»¶è·³è½¬åˆ°ä¸€ä¸ªæ ‡ç­¾ã€‚æ ‡ç­¾åç§°å¿…é¡»åŒ…å«åœ¨ä¸`goto`è¯­å¥ç›¸åŒçš„å‡½æ•°ä¸­ã€‚ç¨‹åºå¯ä»¥`goto`ä¸€ä¸ªè¶…å‡ºå½“å‰ä½œç”¨åŸŸæˆ–æ›´æ·±çš„æ ‡ç­¾ã€‚`goto`å…è®¸è·³è¿‡å˜é‡åˆå§‹åŒ–æˆ–è¿”å›åˆ°å·²ç»é‡Šæ”¾äº†å†…å­˜çš„ä»£ç ï¼Œå› æ­¤å®ƒéœ€è¦ä½¿ç”¨`unsafe`ã€‚

```v ignore
if x {
	// ...
	if y {
		unsafe {
			goto my_label
		}
	}
	// ...
}
my_label:
```

åº”è¯¥é¿å…ä½¿ç”¨`goto`ï¼Œç‰¹åˆ«æ˜¯å¯ä»¥ä½¿ç”¨`for`æ—¶ã€‚
[æ ‡è®°çš„break/continue](#labelled-break--continue)å¯ä»¥ç”¨äºè·³å‡ºåµŒå¥—å¾ªç¯ï¼Œè¿™æ ·å°±ä¸ä¼šæœ‰è¿åå†…å­˜å®‰å…¨æ€§çš„é£é™©ã€‚

## ç»“æ„ä½“

```v
struct Point {
	x int
	y int
}

mut p := Point{
	x: 10
	y: 20
}
println(p.x) // é€šè¿‡ç‚¹è¿ç®—ç¬¦è®¿é—®ç»“æ„ä½“å­—æ®µ
// å¦ä¸€ç§å­—é¢é‡è¯­æ³•
p = Point{10, 20}
assert p.x == 10
```

### å †ä¸Šçš„ç»“æ„ä½“

ç»“æ„ä½“åœ¨å †æ ˆä¸Šåˆ†é…ã€‚è¦åœ¨å †ä¸Šåˆ†é…ä¸€ä¸ªç»“æ„ä½“å¹¶è·å¾—ä¸€ä¸ª[å¼•ç”¨](#references)ï¼Œè¯·ä½¿ç”¨ `&` å‰ç¼€ï¼š

```v
struct Point {
	x int
	y int
}

p := &Point{10, 10}
// å¼•ç”¨çš„å­—æ®µè®¿é—®å…·æœ‰ç›¸åŒçš„è¯­æ³•
println(p.x)
```

`p` çš„ç±»å‹æ˜¯ `&Point`ã€‚å®ƒæ˜¯å¯¹ `Point` çš„[å¼•ç”¨](#å¼•ç”¨)ã€‚å¼•ç”¨ç±»ä¼¼äº Go ä¸­çš„æŒ‡é’ˆå’Œ C++ ä¸­çš„å¼•ç”¨ã€‚

```v
struct Foo {
mut:
	x int
}

fa := Foo{1}
mut a := fa
a.x = 2
assert fa.x == 1
assert a.x == 2

// fb := Foo{ 1 }
// mut b := &fb  // é”™è¯¯ï¼š`fb` æ˜¯ä¸å¯å˜çš„ï¼Œä¸èƒ½æœ‰ä¸€ä¸ªå¯¹å®ƒçš„å¯å˜å¼•ç”¨
// b.x = 2

mut fc := Foo{1}
mut c := &fc
c.x = 2
assert fc.x == 2
assert c.x == 2
println(fc) // Foo{ x: 2 }
println(c) // &Foo{ x: 2 } // æ³¨æ„å‰ç¼€ `&`ã€‚
```

å¦è§[æ ˆå’Œå †](#stack-and-heap)

### é»˜è®¤å­—æ®µå€¼

```v
struct Foo {
	n   int    // é»˜è®¤æƒ…å†µä¸‹ï¼Œn æ˜¯ 0
	s   string // é»˜è®¤æƒ…å†µä¸‹ï¼Œs æ˜¯ ''
	a   []int  // é»˜è®¤æƒ…å†µä¸‹ï¼Œa æ˜¯ `[]int{}` 
	pos int = -1 // è‡ªå®šä¹‰é»˜è®¤å€¼
}
```

åœ¨åˆ›å»ºç»“æ„ä½“æ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹æ‰€æœ‰ç»“æ„å­—æ®µéƒ½å°†è¢«æ¸…é›¶ã€‚æ•°ç»„å’Œæ˜ å°„å­—æ®µå°†è¢«åˆ†é…ç©ºé—´ã€‚å¯¹äºå¼•ç”¨å€¼ï¼Œè¯·å‚è§[è¿™é‡Œ](#structs-with-reference-fields)ã€‚

ä¹Ÿå¯ä»¥å®šä¹‰è‡ªå®šä¹‰é»˜è®¤å€¼ã€‚

### å¿…å¡«å­—æ®µ

```v
struct Foo {
	n int [required]
}
```

ä½ å¯ä»¥ç”¨ `[required]` [å±æ€§](#attributes) æ ‡è®°ä¸€ä¸ªç»“æ„å­—æ®µï¼Œå‘Šè¯‰ V åœ¨åˆ›å»ºè¯¥ç»“æ„ä½“çš„å®ä¾‹æ—¶å¿…é¡»å¯¹è¯¥å­—æ®µè¿›è¡Œåˆå§‹åŒ–ã€‚

ä¸‹é¢çš„ç¤ºä¾‹å°†æ— æ³•ç¼–è¯‘ï¼Œå› ä¸ºå­—æ®µ `n` æ²¡æœ‰æ˜ç¡®åˆå§‹åŒ–ï¼š

```v failcompile
_ = Foo{}
```

<a id='short-struct-initialization-syntax'></a>

### ç®€çŸ­çš„ç»“æ„å­—é¢é‡è¯­æ³•

```v
struct Point {
	x int
	y int
}

mut p := Point{
	x: 10
	y: 20
}
p = Point{
	x: 30
	y: 4
}
assert p.y == 4
//
// æ•°ç»„ï¼šç¬¬ä¸€ä¸ªå…ƒç´ å®šä¹‰äº†æ•°ç»„çš„ç±»å‹
points := [Point{10, 20}, Point{20, 30}, Point{40, 50}]
println(points) // [Point{x: 10, y: 20}, Point{x: 20, y: 30}, Point{x: 40,y: 50}]
```

çœç•¥ç»“æ„ä½“åç§°ä¹Ÿé€‚ç”¨äºè¿”å›ç»“æ„ä½“å­—é¢é‡æˆ–å°†å…¶ä½œä¸ºå‡½æ•°å‚æ•°ä¼ é€’ã€‚

### ç»“æ„ä½“æ›´æ–°è¯­æ³•

V ä½¿å¾—è¿”å›å¯¹è±¡çš„ä¿®æ”¹ç‰ˆæœ¬å˜å¾—å®¹æ˜“ï¼š

```v
struct User {
	name          string
	age           int
	is_registered bool
}

fn register(u User) User {
	return User{
		...u
		is_registered: true
	}
}

mut user := User{
	name: 'abc'
	age: 23
}
user = register(user)
println(user)
```

### å°¾éƒ¨ç»“æ„å­—é¢é‡å‚æ•°

V ä¸æ”¯æŒé»˜è®¤å‡½æ•°å‚æ•°æˆ–å‘½åå‚æ•°ï¼Œå¯ä»¥ä½¿ç”¨å°¾éƒ¨ç»“æ„å­—é¢é‡è¯­æ³•ï¼š

```v
[params]
struct ButtonConfig {
	text        string
	is_disabled bool
	width       int = 70
	height      int = 20
}

struct Button {
	text   string
	width  int
	height int
}

fn new_button(c ButtonConfig) &Button {
	return &Button{
		width: c.width
		height: c.height
		text: c.text
	}
}

button := new_button(text: 'Click me', width: 100)
// é«˜åº¦æœªè®¾ç½®ï¼Œå› æ­¤å®ƒçš„é»˜è®¤å€¼æ˜¯ 20
assert button.height == 20
```

å¦‚ä½ æ‰€è§ï¼Œç»“æ„ä½“åç§°å’Œå¤§æ‹¬å·éƒ½å¯ä»¥çœç•¥ï¼Œè€Œä¸æ˜¯ï¼š

```v oksyntax nofmt
new_button(ButtonConfig{text:'Click me', width:100})
```

è¿™ä»…é€‚ç”¨äºæœ€åä¸€ä¸ªå‚æ•°æ˜¯ç»“æ„ä½“çš„å‡½æ•°ã€‚

> æ³¨æ„ `[params]` æ ‡ç­¾ç”¨äºå‘Šè¯‰ Vï¼Œå°¾éƒ¨ç»“æ„å‚æ•°å¯ä»¥è¢«*å®Œå…¨*çœç•¥ï¼Œå› æ­¤ä½ å¯ä»¥å†™æˆ `button := new_button()`ã€‚
> å¦åˆ™ï¼Œä½ å¿…é¡»*è‡³å°‘*æŒ‡å®šä¸€ä¸ªå­—æ®µåï¼Œå³ä½¿å®ƒå…·æœ‰é»˜è®¤å€¼ï¼Œå¦åˆ™ç¼–è¯‘å™¨ä¼šäº§ç”Ÿä»¥ä¸‹é”™è¯¯æ¶ˆæ¯ï¼Œå½“ä½ åœ¨æ²¡æœ‰å‚æ•°çš„æƒ…å†µä¸‹è°ƒç”¨å‡½æ•°æ—¶ï¼š
> `error: é¢„æœŸ 1 ä¸ªå‚æ•°ï¼Œä½†å¾—åˆ°äº† 0 ä¸ª`ã€‚

### è®¿é—®ä¿®é¥°ç¬¦

é»˜è®¤æƒ…å†µä¸‹ï¼Œç»“æ„ä½“å­—æ®µæ˜¯ç§æœ‰ä¸”ä¸å¯å˜çš„ï¼ˆè¿™ä¹Ÿä½¿å¾—ç»“æ„ä½“æœ¬èº«ä¹Ÿæ˜¯ä¸å¯å˜çš„ï¼‰ã€‚
å®ƒä»¬çš„è®¿é—®ä¿®é¥°ç¬¦å¯ä»¥é€šè¿‡ `pub` å’Œ `mut` è¿›è¡Œæ›´æ”¹ã€‚æ€»å…±æœ‰ 5 ç§å¯èƒ½çš„é€‰é¡¹ï¼š

```v
struct Foo {
	a int // é»˜è®¤æƒ…å†µä¸‹æ˜¯ç§æœ‰ä¸”ä¸å¯å˜çš„
mut:
	b int // ç§æœ‰ä¸”å¯å˜çš„
	c int // (ä½ å¯ä»¥åˆ—å‡ºå¤šä¸ªå…·æœ‰ç›¸åŒè®¿é—®ä¿®é¥°ç¬¦çš„å­—æ®µ)
pub:
	d int // å…¬å…±å’Œä¸å¯å˜çš„ï¼ˆåªè¯»ï¼‰
pub mut:
	e int // åœ¨çˆ¶æ¨¡å—ä¸­å¯å…¬å¼€ï¼Œä½†åªèƒ½åœ¨çˆ¶æ¨¡å—ä¸­è¿›è¡Œä¿®æ”¹
__global:
	//ï¼ˆä¸å»ºè®®ä½¿ç”¨ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆâ€œglobalâ€å…³é”®å­—ä»¥ __ å¼€å¤´çš„åŸå› ï¼‰
	f int // åœ¨çˆ¶æ¨¡å—å†…å¤–éƒ½æ˜¯å…¬å…±ä¸”å¯å˜çš„
}
```

ç§æœ‰å­—æ®µä»…åœ¨

åŒä¸€[æ¨¡å—](#modules)å†…å¯ç”¨ï¼Œä»»ä½•ç›´æ¥å°è¯•ä»å¦ä¸€ä¸ªæ¨¡å—ä¸­è®¿é—®å®ƒä»¬éƒ½å°†åœ¨ç¼–è¯‘æœŸé—´å¼•å‘é”™è¯¯ã€‚å…¬å…±ä¸å¯å˜å­—æ®µåœ¨ä»»ä½•åœ°æ–¹éƒ½æ˜¯åªè¯»çš„ã€‚

### åŒ¿åç»“æ„ä½“

V æ”¯æŒåŒ¿åç»“æ„ä½“ï¼šæ— éœ€å•ç‹¬å£°æ˜ç»“æ„ä½“åç§°ã€‚

```v
struct Book {
	author struct {
		name string
		age  int
	}

	title string
}

book := Book{
	author: struct {
		name: 'Samantha Black'
		age: 24
	}
}
assert book.author.name == 'Samantha Black'
assert book.author.age == 24
```

### é™æ€ç±»å‹æ–¹æ³•

V ç°åœ¨æ”¯æŒé™æ€ç±»å‹æ–¹æ³•ï¼Œå¦‚ `User.new()`ã€‚å¯ä»¥é€šè¿‡ `fn [Type name].[function name]` åœ¨ç»“æ„ä½“ä¸Šå®šä¹‰è¿™äº›æ–¹æ³•ï¼Œä»¥ä¾¿ç»„ç»‡ä¸ç»“æ„ä½“ç›¸å…³çš„æ‰€æœ‰å‡½æ•°ï¼š

```v oksyntax
struct User {}

fn User.new() User {
	return User{}
}

user := User.new()
```

è¿™æ˜¯å·¥å‚å‡½æ•°çš„æ›¿ä»£æ–¹æ³•ï¼Œä¾‹å¦‚ `fn new_user() User {}`ï¼Œåº”è¯¥ä½¿ç”¨å®ƒæ¥ä»£æ›¿ã€‚

è¯·æ³¨æ„ï¼Œè¿™äº›ä¸æ˜¯æ„é€ å‡½æ•°ï¼Œè€Œæ˜¯ç®€å•çš„å‡½æ•°ã€‚V æ²¡æœ‰æ„é€ å‡½æ•°æˆ–ç±»ã€‚

### `[noinit]` ç»“æ„ä½“

V æ”¯æŒ `[noinit]` ç»“æ„ä½“ï¼Œè¿™äº›ç»“æ„ä½“ä¸èƒ½åœ¨å®šä¹‰å®ƒä»¬çš„æ¨¡å—ä¹‹å¤–è¿›è¡Œåˆå§‹åŒ–ã€‚å®ƒä»¬è¦ä¹ˆç”¨äºå†…éƒ¨ä½¿ç”¨ï¼Œè¦ä¹ˆå¯ä»¥é€šè¿‡*å·¥å‚å‡½æ•°*åœ¨å¤–éƒ¨ä½¿ç”¨ã€‚

ä¾‹å¦‚ï¼Œè€ƒè™‘åœ¨åä¸º `sample` çš„ç›®å½•ä¸­çš„ä»¥ä¸‹æºä»£ç ï¼š

```v oksyntax
module sample

[noinit]
pub struct Information {
pub:
	data string
}

pub fn new_information(data string) !Information {
	if data.len == 0 || data.len > 100 {
		return error('æ•°æ®å¿…é¡»åœ¨ 1 åˆ° 100 ä¸ªå­—ç¬¦ä¹‹é—´')
	}
	return Information{
		data: data
	}
}
```

è¯·æ³¨æ„ï¼Œ`new_information` æ˜¯ä¸€ä¸ª*å·¥å‚*å‡½æ•°ã€‚ç°åœ¨ï¼Œå½“æˆ‘ä»¬æƒ³åœ¨æ¨¡å—å¤–éƒ¨ä½¿ç”¨è¿™ä¸ªç»“æ„ä½“æ—¶ï¼š

```v okfmt
import sample

fn main() {
	// å½“ [noinit] å±æ€§å­˜åœ¨æ—¶ï¼Œè¿™å°†æ— æ³•å·¥ä½œï¼š
	// info := sample.Information{
	// 	data: 'ç¤ºä¾‹ä¿¡æ¯ã€‚'
	// }

	// ä½¿ç”¨è¿™ä¸ªä»£æ›¿ï¼š
	info := sample.new_information('ç¤ºä¾‹ä¿¡æ¯ã€‚')!

	println(info)
}
```

### æ–¹æ³•

```v
struct User {
	age int
}

fn (u User) can_register() bool {
	return u.age > 16
}

user := User{
	age: 10
}
println(user.can_register()) // "false"
user2 := User{
	age: 20
}
println(user2.can_register()) // "true"
```

V æ²¡æœ‰ç±»ï¼Œä½†ä½ å¯ä»¥åœ¨ç±»å‹ä¸Šå®šä¹‰æ–¹æ³•ã€‚æ–¹æ³•æ˜¯ä¸€ä¸ªå¸¦æœ‰ç‰¹æ®Šæ¥æ”¶å™¨å‚æ•°çš„å‡½æ•°ã€‚æ¥æ”¶å™¨å‡ºç°åœ¨ `fn` å…³é”®å­—å’Œæ–¹æ³•åç§°ä¹‹é—´çš„è‡ªå·±çš„å‚æ•°åˆ—è¡¨ä¸­ã€‚æ–¹æ³•å¿…é¡»åœ¨æ¥æ”¶å™¨ç±»å‹æ‰€åœ¨çš„æ¨¡å—ä¸­ã€‚

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œ`can_register` æ–¹æ³•çš„æ¥æ”¶å™¨ç±»å‹ä¸º `User`ï¼Œå‘½åä¸º `u`ã€‚çº¦å®šæ˜¯ä¸ä½¿ç”¨æ¥æ”¶å™¨åç§°å¦‚ `self` æˆ– `this`ï¼Œè€Œæ˜¯ä½¿ç”¨ä¸€ä¸ªç®€çŸ­çš„ã€æœ€å¥½æ˜¯ä¸€ä¸ªå­—æ¯é•¿çš„åç§°ã€‚

### åµŒå…¥å¼ç»“æ„ä½“

V æ”¯æŒåµŒå…¥å¼ç»“æ„ä½“ã€‚

```v
struct Size {
mut:
	width  int
	height int
}

fn (s &Size) area() int {
	return s.width * s.height
}

struct Button {
	Size
	title string
}
```

é€šè¿‡åµŒå…¥ï¼Œç»“æ„ä½“ `Button` å°†è‡ªåŠ¨è·å¾—æ¥è‡ªç»“æ„ä½“ `Size` çš„æ‰€æœ‰å­—æ®µå’Œæ–¹æ³•ï¼Œè¿™ä½¿å¾—ä½ å¯ä»¥è¿™æ ·åšï¼š

```v oksyntax
mut button := Button{
	title: 'ç‚¹å‡»æˆ‘'
	height: 2
}

button.width = 3
assert button.area() == 6
assert button.Size.area() == 6
print(button)
```

è¾“å‡ºï¼š

```
Button{
    Size: Size{
        width: 3
        height: 2
    }
    title: 'ç‚¹å‡»æˆ‘'
}
```

ä¸ç»§æ‰¿ä¸åŒï¼Œä½ ä¸èƒ½åœ¨ç»“æ„ä½“å’ŒåµŒå¥—çš„ç»“æ„ä½“ä¹‹é—´è¿›è¡Œç±»å‹è½¬æ¢ï¼ˆåµŒå¥—çš„ç»“æ„ä½“ä¹Ÿå¯ä»¥æœ‰è‡ªå·±çš„å­—æ®µï¼Œå®ƒä¹Ÿå¯ä»¥åµŒå¥—å¤šä¸ªç»“æ„ä½“ï¼‰ã€‚

å¦‚æœéœ€è¦ç›´æ¥è®¿é—®åµŒå…¥çš„ç»“æ„ä½“ï¼Œå¯ä»¥ä½¿ç”¨æ˜¾å¼å¼•ç”¨ï¼Œå¦‚ `button.Size`ã€‚

ä»æ¦‚å¿µä¸Šè®²ï¼ŒåµŒå…¥å¼ç»“æ„ä½“ç±»ä¼¼äºé¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­çš„[mixin](https://en.wikipedia.org/wiki/Mixin)ï¼Œè€Œä¸æ˜¯åŸºç±»ã€‚

ä½ ä¹Ÿå¯ä»¥åˆå§‹åŒ–åµŒå…¥çš„ç»“æ„ä½“ï¼š

```v oksyntax
mut button := Button{
	Size: Size{
		width: 3
		height: 2
	}
}
```

æˆ–è€…åˆ†é…å€¼ï¼š

```v oksyntax
button.Size = Size{
	width: 4
	height: 5
}
```

å¦‚æœå¤šä¸ªåµŒå…¥å¼ç»“æ„ä½“å…·æœ‰ç›¸åŒçš„åç§°æˆ–å¦‚æœåœ¨ç»“æ„ä½“ä¸­å®šä¹‰äº†å…·æœ‰ç›¸åŒåç§°çš„æ–¹æ³•æˆ–å­—æ®µï¼Œåˆ™å¯ä»¥åƒ `button.Size.area()` è¿™æ ·è°ƒç”¨åµŒå…¥å¼ç»“æ„ä½“ä¸­çš„æ–¹æ³•æˆ–èµ‹å€¼ç»™åµŒå…¥å¼ç»“æ„ä½“ä¸­çš„å˜é‡ã€‚å½“ä½ æ²¡æœ‰æŒ‡å®šåµŒå¥—çš„ç»“æ„ä½“åç§°æ—¶ï¼Œå°†é’ˆå¯¹æœ€å¤–å±‚çš„ç»“æ„ä½“çš„æ–¹æ³•ã€‚

## è”åˆä½“

ä¸ç»“æ„ä½“ç±»ä¼¼ï¼Œè”åˆä½“ä¹Ÿæ”¯æŒåµŒå…¥ã€‚

```v
struct Rgba32_Component {
	r u8
	g u8
	b u8
	a u8
}

union Rgba32 {
	Rgba32_Component
	value u32
}

clr1 := Rgba32{
	value: 0x008811FF
}

clr2 := Rgba32{
	Rgba32_Component: Rgba32_Component{
		a: 128
	}
}

sz := sizeof(Rgba32)
unsafe {
	println('Size: ${sz}B,clr1.b: ${clr1.b},clr2.b: ${clr2.b}')
}
```

è¾“å‡ºï¼š`Size: 4B, clr1.b: 136, clr2.b: 0`

å¿…é¡»åœ¨ `unsafe` å—ä¸­æ‰§è¡Œè”åˆä½“æˆå‘˜è®¿é—®ã€‚

> **æ³¨æ„**
> åµŒå…¥å¼ç»“æ„çš„å‚æ•°æœªå¿…æŒ‰ç…§åˆ—å‡ºçš„é¡ºåºå­˜å‚¨ã€‚

## å‡½æ•° 2

### é»˜è®¤æƒ…å†µä¸‹æ˜¯ä¸å¯å˜çš„å‡½æ•°å‚æ•°

åœ¨ V ä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå‡½æ•°å‚æ•°æ˜¯ä¸å¯å˜çš„ï¼Œå¯å˜å‚æ•°å¿…é¡»åœ¨è°ƒç”¨æ—¶åŠ ä¸Šæ ‡è®°ã€‚

ç”±äºä¹Ÿæ²¡æœ‰å…¨å±€å˜é‡ï¼Œè¿™æ„å‘³ç€å‡½æ•°çš„è¿”å›å€¼ä»…å–å†³äºå®ƒä»¬çš„å‚æ•°ï¼Œå¹¶ä¸”å®ƒä»¬çš„è¯„ä¼°æ²¡æœ‰å‰¯ä½œç”¨ï¼ˆé™¤éå‡½æ•°ä½¿ç”¨ I/Oï¼‰ã€‚

å³ä½¿ä¼ é€’äº† [å¼•ç”¨](#references)ï¼Œå‡½æ•°å‚æ•°åœ¨é»˜è®¤æƒ…å†µä¸‹ä¹Ÿæ˜¯ä¸å¯å˜çš„ã€‚

> **æ³¨æ„**
> ç„¶è€Œï¼ŒV ä¸æ˜¯ä¸€ç§çº¯å‡½æ•°å¼çš„è¯­è¨€ã€‚

å¯ä»¥é€šè¿‡ä½¿ç”¨ç¼–è¯‘å™¨æ ‡å¿—å¯ç”¨å…¨å±€å˜é‡(`-enable-globals`)ï¼Œä½†è¿™æ˜¯ä¸ºäº†ä½çº§åº”ç”¨ç¨‹åºå¦‚å†…æ ¸å’Œé©±åŠ¨ç¨‹åºã€‚

### å¯å˜å‚æ•°

é€šè¿‡ä½¿ç”¨å…³é”®å­— `mut` å£°æ˜å®ƒä»¬ï¼Œå¯ä»¥ä¿®æ”¹å‡½æ•°å‚æ•°ï¼š

```v
struct User {
	name string
mut:
	is_registered bool
}

fn (mut u User) register() {
	u.is_registered = true
}

mut user := User{}
println(user.is_registered) // "false"
user.register()
println(user.is_registered) // "true"
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæ¥æ”¶è€…ï¼ˆå³ç¬¬ä¸€ä¸ªå‚æ•°ï¼‰è¢«æ˜ç¡®æ ‡è®°ä¸ºå¯å˜çš„ï¼Œå› æ­¤ `register()` å¯ä»¥æ›´æ”¹ç”¨æˆ·å¯¹è±¡ã€‚å¯¹äºéæ¥æ”¶è€…å‚æ•°ï¼Œä¹ŸåŒæ ·é€‚ç”¨ï¼š

```v
fn multiply_by_2(mut arr []int) {
	for i in 0 .. arr.len {
		arr[i] *= 2
	}
}

mut nums := [1, 2, 3]
multiply_by_2(mut nums)
println(nums)
// "[2, 4, 6]"
```

è¯·æ³¨æ„ï¼Œåœ¨è°ƒç”¨æ­¤å‡½æ•°æ—¶ï¼Œå¿…é¡»åœ¨ `nums` å‰é¢åŠ ä¸Š `mut`ã€‚è¿™æ ·åšå¯ä»¥æ¸…æ¥šåœ°è¡¨æ˜è¢«è°ƒç”¨çš„å‡½æ•°å°†ä¿®æ”¹è¯¥å€¼ã€‚

æœ€å¥½è¿”å›å€¼è€Œä¸æ˜¯ä¿®æ”¹å‚æ•°ï¼Œä¾‹å¦‚ `user = register(user)`ï¼ˆæˆ– `user.register()`ï¼‰è€Œä¸æ˜¯ `register(mut user)`ã€‚åªåº”åœ¨åº”ç”¨ç¨‹åºçš„æ€§èƒ½å…³é”®éƒ¨åˆ†ä¸­ä¿®æ”¹å‚æ•°ï¼Œä»¥å‡å°‘åˆ†é…å’Œå¤åˆ¶ã€‚

å› æ­¤ï¼ŒV ä¸å…è®¸ä½¿ç”¨åŸå§‹ç±»å‹ï¼ˆä¾‹å¦‚æ•´æ•°ï¼‰ä¿®æ”¹å‚æ•°ã€‚åªæœ‰è¯¸å¦‚æ•°ç»„å’Œæ˜ å°„ä¹‹ç±»çš„æ›´å¤æ‚çš„ç±»å‹æ‰å¯ä»¥è¢«ä¿®æ”¹ã€‚

### å¯å˜æ•°é‡çš„å‚æ•°

V æ”¯æŒæ¥å—ä»»æ„æ•°é‡çš„å‚æ•°çš„å‡½æ•°ï¼Œç”¨ `...` å‰ç¼€è¡¨ç¤ºã€‚
ä¸‹é¢ï¼Œ`a ...int` è¡¨ç¤ºå°†ä»»æ„æ•°é‡çš„å‚æ•°æ”¶é›†åˆ°åä¸º `a` çš„æ•°ç»„ä¸­ã€‚

```v
fn sum(a ...int) int {
	mut total := 0
	for x in a {
		total += x
	}
	return total
}

println(sum()) // 0
println(sum(1)) // 1
println(sum(2, 3)) // 5
// ä½¿ç”¨æ•°ç»„è§£æ„
a := [2, 3, 4]
println(sum(...a)) // <-- åœ¨è¿™é‡Œä½¿ç”¨å‰ç¼€ ...ã€‚è¾“å‡ºï¼š9
b := [5, 6, 7]
println(sum(...b)) // è¾“å‡ºï¼š18
```

### åŒ¿åå’Œé«˜é˜¶å‡½æ•°

```v
fn sqr(n int) int {
	return n * n
}

fn cube(n int) int {
	return n * n * n
}

fn run(value int, op fn (int) int) int {
	return op(value)
}

fn main() {
	// å‡½æ•°å¯ä»¥ä¼ é€’ç»™å…¶ä»–å‡½æ•°
	println(run(5, sqr)) // "25"
	// å¯ä»¥åœ¨å…¶ä»–å‡½æ•°å†…éƒ¨å£°æ˜åŒ¿åå‡½æ•°ï¼š
	double_fn := fn (n int) int {
		return n + n
	}
	println(run(5, double_fn)) // "10"
	// å‡½æ•°å¯ä»¥åœ¨ä¸å°†å®ƒä»¬åˆ†é…ç»™å˜é‡çš„æƒ…å†µä¸‹ä¼ é€’ï¼š
	res := run(5, fn (n int) int {
		return n + n
	})
	println(res) // "10"
	// ç”šè‡³å¯ä»¥æ‹¥æœ‰ä¸€ä¸ªåŒ…å«å‡½æ•°çš„æ•°ç»„/æ˜ å°„ï¼š
	fns := [sqr, cube]
	println(fns[0](10)) // "100"
	fns_map := {
		'sqr':  sqr
		'cube': cube
	}
	println(fns_map['cube'](2)) // "8"
}
```

### é—­åŒ…

V ä¹Ÿæ”¯æŒé—­åŒ…ã€‚
è¿™æ„å‘³ç€åŒ¿åå‡½æ•°å¯ä»¥ç»§æ‰¿å®ƒä»¬è¢«åˆ›å»ºçš„èŒƒå›´ä¸­çš„å˜é‡ã€‚å®ƒä»¬å¿…é¡»é€šè¿‡åˆ—å‡ºæ‰€æœ‰è¦ç»§æ‰¿çš„å˜é‡æ¥æ˜¾å¼åœ°æ‰§è¡Œæ­¤æ“ä½œã€‚

```v oksyntax
my_int := 1
my_closure := fn [my_int] () {
	println(my_int)
}
my_closure() // è¾“å‡º 1
```

åœ¨åˆ›å»ºåŒ¿åå‡½æ•°æ—¶ï¼Œç»§æ‰¿çš„å˜é‡ä¼šè¢«å¤åˆ¶ã€‚
è¿™æ„å‘³ç€å¦‚æœåœ¨åˆ›å»ºå‡½æ•°ä¹‹åä¿®æ”¹åŸå§‹å˜é‡ï¼Œåˆ™ä¸ä¼šåœ¨å‡½æ•°ä¸­åæ˜ æ­¤ä¿®æ”¹ã€‚

```v oksyntax
mut i := 1
func := fn [i] () int {
	return i
}
println(func() == 1) // true
i = 123
println(func() == 1) // ä»ç„¶ä¸º true
```

ä½†æ˜¯ï¼Œåœ¨åŒ¿åå‡½æ•°å†…éƒ¨å¯ä»¥ä¿®æ”¹å˜é‡ã€‚
è¿™ä¸ªå˜åŒ–ä¸ä¼šåœ¨å¤–éƒ¨åæ˜ å‡ºæ¥ï¼Œä½†ä¼šåœ¨ä»¥åçš„å‡½æ•°è°ƒç”¨ä¸­åæ˜ å‡ºæ¥ã€‚

```v oksyntax
fn new_counter() fn () int {
	mut i := 0
	return fn [mut i] () int {
		i++
		return i
	}
}

c := new_counter()
println(c()) // 1
println(c()) // 2
println(c()) // 3
```

å¦‚æœéœ€è¦åœ¨å‡½æ•°å¤–éƒ¨ä¿®æ”¹å€¼ï¼Œè¯·ä½¿ç”¨å¼•ç”¨ã€‚

```v oksyntax
mut i := 0
mut ref := &i
print_counter := fn [ref] () {
	println(*ref)
}

print_counter() // 0
i = 10
print_counter() // 10
```

### å‚æ•°è¯„ä¼°é¡ºåº

å‡½æ•°è°ƒç”¨çš„å‚æ•°çš„è¯„ä¼°é¡ºåº *ä¸èƒ½* ä¿è¯ã€‚ä¾‹å¦‚ï¼Œè€ƒè™‘ä»¥ä¸‹ç¨‹åºï¼š

```v
fn f(a1 int, a2 int, a3 int) {
	dump(a1 + a2 + a3)
}

fn main() {
	f(dump(100), dump(200), dump(300))
}
```

V å½“å‰ä¸èƒ½ä¿è¯å®ƒä¼šæŒ‰ç…§ 100ã€200ã€300 çš„é¡ºåºæ‰“å°ã€‚å”¯ä¸€çš„ä¿è¯æ˜¯ 600ï¼ˆæ¥è‡ª`f` çš„ä¸»ä½“ï¼‰å°†åœ¨æ‰€æœ‰å®ƒä»¬ä¹‹åæ‰“å°ã€‚

è¿™ *å¯èƒ½* åœ¨ V 1.0 ä¸­å‘ç”Ÿå˜åŒ–ã€‚

## å¼•ç”¨

```v
struct Foo {}

fn (foo Foo) bar_method() {
	// ...
}

fn bar_function(foo Foo) {
	// ...
}
```

å¦‚æœä¸€ä¸ªå‡½æ•°å‚æ•°æ˜¯ä¸å¯å˜çš„ï¼ˆå°±åƒä¸Šé¢ç¤ºä¾‹ä¸­çš„ `foo` ä¸€æ ·ï¼‰ï¼ŒV å¯ä»¥é€šè¿‡å€¼æˆ–å¼•ç”¨ä¼ é€’å®ƒã€‚ç¼–è¯‘å™¨ä¼šå†³å®šï¼Œå¼€å‘è€…ä¸éœ€è¦è€ƒè™‘è¿™ä¸ªé—®é¢˜ã€‚

æ‚¨ä¸å†éœ€è¦è®°ä½æ˜¯åº”è¯¥æŒ‰å€¼ä¼ é€’ç»“æ„ä½“è¿˜æ˜¯æŒ‰å¼•ç”¨ä¼ é€’ã€‚

æ‚¨å¯ä»¥é€šè¿‡æ·»åŠ  `&` æ¥ç¡®ä¿ç»“æ„ä½“å§‹ç»ˆä»¥å¼•ç”¨çš„æ–¹å¼ä¼ é€’ï¼š

```v
struct Foo {
	abc int
}

fn (foo &Foo) bar() {
	println(foo.abc)
}
```

`foo` ä»ç„¶æ˜¯ä¸å¯å˜çš„ï¼Œä¸èƒ½è¢«æ›´æ”¹ã€‚ä¸ºæ­¤ï¼Œå¿…é¡»ä½¿ç”¨ `(mut foo Foo)`ã€‚

æ€»çš„æ¥è¯´ï¼ŒV çš„å¼•ç”¨ç±»ä¼¼äº Go çš„æŒ‡é’ˆå’Œ C++ çš„å¼•ç”¨ã€‚ä¾‹å¦‚ï¼Œé€šç”¨æ ‘ç»“æ„çš„å®šä¹‰çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š

```v
struct Node[T] {
	val   T
	left  &Node[T]
	right &Node[T]
}
```

è¦å–æ¶ˆå¼•ç”¨ï¼Œè¯·ä½¿ç”¨ `*` è¿ç®—ç¬¦ï¼Œå°±åƒåœ¨ C ä¸­ä¸€æ ·ã€‚

## å¸¸é‡

```v
const (
	pi    = 3.14
	world = 'ä¸–ç•Œ'
)

println(pi)
println(world)
```

å¸¸é‡æ˜¯ç”¨ `const` å£°æ˜çš„ã€‚å®ƒä»¬åªèƒ½åœ¨æ¨¡å—çº§åˆ«ï¼ˆåœ¨å‡½æ•°å¤–éƒ¨ï¼‰å®šä¹‰ã€‚
å¸¸é‡çš„å€¼æ°¸è¿œä¸èƒ½è¢«æ›´æ”¹ã€‚ä½ ä¹Ÿå¯ä»¥å•ç‹¬å£°æ˜ä¸€ä¸ªå¸¸é‡ï¼š

```v
const e = 2.71828
```

V çš„å¸¸é‡æ¯”å¤§å¤šæ•°è¯­è¨€æ›´çµæ´»ã€‚ä½ å¯ä»¥èµ‹äºˆæ›´å¤æ‚çš„å€¼ï¼š

```v
struct Color {
	r int
	g int
	b int
}

fn rgb(r int, g int, b int) Color {
	return Color{
		r: r
		g: g
		b: b
	}
}

const (
	numbers = [1, 2, 3]
	red     = Color{
		r: 255
		g: 0
		b: 0
	}
	// åœ¨ç¼–è¯‘æ—¶è¯„ä¼°å‡½æ•°è°ƒç”¨*
	blue = rgb(0, 0, 255)
)

println(numbers)
println(red)
println(blue)
```

\* WIP - ç›®å‰å‡½æ•°è°ƒç”¨åœ¨ç¨‹åºå¯åŠ¨æ—¶è¯„ä¼°

é€šå¸¸æƒ…å†µä¸‹ï¼Œå…¨å±€å˜é‡æ˜¯ä¸å…è®¸çš„ï¼Œæ‰€ä»¥è¿™å¯èƒ½éå¸¸æœ‰ç”¨ã€‚

**æ¨¡å—**

å¯ä»¥ä½¿ç”¨ `pub const` ä½¿å¸¸é‡å…¬å¼€ï¼š

```v oksyntax
module mymodule

pub const golden_ratio = 1.61803

fn calc() {
	println(mymodule.golden_ratio)
}
```

`pub` å…³é”®å­—åªå…è®¸åœ¨ `const` å…³é”®å­—ä¹‹å‰ä½¿ç”¨ï¼Œä¸èƒ½åœ¨ `const ( )` å—å†…ä½¿ç”¨ã€‚

åœ¨æ¨¡å—å¤–ï¼Œæ‰€æœ‰å¸¸é‡éƒ½éœ€è¦ä»¥æ¨¡å—åä½œä¸ºå‰ç¼€ã€‚

### éœ€è¦æ¨¡å—å‰ç¼€

åœ¨å‘½åå¸¸é‡æ—¶ï¼Œå¿…é¡»ä½¿ç”¨ `snake_case`ã€‚ä¸ºäº†åŒºåˆ†å¸¸é‡å’Œå±€éƒ¨å˜é‡ï¼Œå¿…é¡»æŒ‡å®šåˆ°å¸¸é‡çš„å®Œæ•´è·¯å¾„ã€‚ä¾‹å¦‚ï¼Œè¦è®¿é—® PI å¸¸é‡ï¼Œå¿…é¡»åœ¨ `math` æ¨¡å—å†…å¤–éƒ½ä½¿ç”¨å®Œæ•´çš„ `math.pi` åç§°ã€‚åªæœ‰åœ¨ `main` æ¨¡å—ï¼ˆåŒ…å«æ‚¨çš„ `fn main()` çš„æ¨¡å—ï¼‰ä¸­æ‰æ”¾æ¾äº†è¿™ä¸ªè§„åˆ™ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨åœ¨é‚£é‡Œå®šä¹‰çš„å¸¸é‡çš„æœªé™å®šåç§°ï¼Œå³ `numbers`ï¼Œè€Œä¸æ˜¯ `main.numbers`ã€‚

vfmt ä¼šå¤„ç†è¿™ä¸ªè§„åˆ™ï¼Œå› æ­¤æ‚¨å¯ä»¥åœ¨ `math` æ¨¡å—å†…è¾“å…¥ `println(pi)`ï¼Œvfmt å°†è‡ªåŠ¨å°†å…¶æ›´æ–°ä¸º `println(math.pi)`ã€‚

å¾ˆå¤šäººæ›´å–œæ¬¢å…¨å¤§å†™çš„å¸¸é‡ï¼Œæ¯”å¦‚ `TOP_CITIES`ã€‚ä½†åœ¨Vä¸­ï¼Œè¿™ç§æ–¹å¼ä¸æ˜¯å¾ˆåˆé€‚ï¼Œå› ä¸ºå¸¸é‡æ¯”å…¶ä»–è¯­è¨€ä¸­çš„å¸¸é‡æ›´ä¸ºå¼ºå¤§ã€‚å®ƒä»¬å¯ä»¥è¡¨ç¤ºå¤æ‚çš„ç»“æ„ï¼Œè€Œä¸”ç”±äºæ²¡æœ‰å…¨å±€å˜é‡ï¼Œè¿™ç§ç”¨æ³•éå¸¸å¸¸è§ï¼š

```v oksyntax
println('Top cities: ${top_cities.filter(.usa)}')
```

## å†…å»ºå‡½æ•°

Vè¯­è¨€ä¸­åŒ…å«ä¸€äº›å†…å»ºå‡½æ•°ï¼Œæ¯”å¦‚ `println`ã€‚ä»¥ä¸‹æ˜¯å®Œæ•´åˆ—è¡¨ï¼š

```v ignore
fn print(s string) // å°†ä»»ä½•å†…å®¹æ‰“å°åˆ°stdout
fn println(s string) // æ‰“å°ä»»ä½•å†…å®¹å¹¶åœ¨stdoutä¸Šæ¢è¡Œ

fn eprint(s string) // ä¸print()ç›¸åŒï¼Œä½†ä½¿ç”¨stderr
fn eprintln(s string) // ä¸println()ç›¸åŒï¼Œä½†ä½¿ç”¨stderr

fn exit(code int) // ä»¥è‡ªå®šä¹‰é”™è¯¯ä»£ç ç»ˆæ­¢ç¨‹åº
fn panic(s string) // åœ¨stderrä¸Šæ‰“å°ä¸€æ¡æ¶ˆæ¯å’Œå›æº¯ï¼Œå¹¶ä»¥é”™è¯¯ä»£ç 1ç»ˆæ­¢ç¨‹åº
fn print_backtrace() // åœ¨stderrä¸Šæ‰“å°å›æº¯
```

> **æ³¨æ„**
> è™½ç„¶ `print` å‡½æ•°æ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä½†Vè¿˜æ¥å—å…¶ä»–å¯æ‰“å°ç±»å‹ã€‚è¯¦æƒ…è¯·è§ä¸‹æ–‡ã€‚

è¿˜æœ‰ä¸€ä¸ªç‰¹æ®Šçš„å†…å»ºå‡½æ•°å«åš [`dump`](#åœ¨è¿è¡Œæ—¶å€™è½¬å‚¨è¡¨è¾¾å¼)ã€‚

### println

`println` æ˜¯ä¸€ä¸ªç®€å•ä½†åŠŸèƒ½å¼ºå¤§çš„å†…å»ºå‡½æ•°ï¼Œå¯ä»¥æ‰“å°ä»»ä½•ä¸œè¥¿ï¼šå­—ç¬¦ä¸²ã€æ•°å­—ã€æ•°ç»„ã€æ˜ å°„ã€ç»“æ„ä½“ç­‰ã€‚

```v
struct User {
	name string
	age  int
}

println(1) // "1"
println('hi') // "hi"
println([1, 2, 3]) // "[1, 2, 3]"
println(User{ name: 'Bob', age: 20 }) // "User{name:'Bob', age:20}"
```

å¦è¯·å‚é˜…[æ•°ç»„æ–¹æ³•](#æ•°ç»„æ–¹æ³•)ã€‚

<a id='è‡ªå®šä¹‰ç±»å‹çš„æ‰“å°'></a>

### æ‰“å°è‡ªå®šä¹‰ç±»å‹

å¦‚æœä½ æƒ³ä¸ºä½ çš„ç±»å‹å®šä¹‰ä¸€ä¸ªè‡ªå®šä¹‰çš„æ‰“å°å€¼ï¼Œåªéœ€å®šä¹‰ä¸€ä¸ª `str() string` æ–¹æ³•ï¼š

```v
struct Color {
	r int
	g int
	b int
}

pub fn (c Color) str() string {
	return '{${c.r}, ${c.g}, ${c.b}}'
}

red := Color{
	r: 255
	g: 0
	b: 0
}
println(red)
```

### åœ¨è¿è¡Œæ—¶å€™è½¬å‚¨è¡¨è¾¾å¼

ä½ å¯ä»¥ä½¿ç”¨ `dump(expr)` æ¥è½¬å‚¨/è·Ÿè¸ªä»»ä½•Vè¡¨è¾¾å¼çš„å€¼ã€‚ä¾‹å¦‚ï¼Œå°†ä»¥ä¸‹ä»£ç ç¤ºä¾‹ä¿å­˜ä¸º `factorial.v`ï¼Œç„¶åç”¨ `v run factorial.v` è¿è¡Œå®ƒï¼š

```v
fn factorial(n u32) u32 {
	if dump(n <= 1) {
		return dump(1)
	}
	return dump(n * factorial(n - 1))
}

fn main() {
	println(factorial(5))
}
```

ä½ ä¼šå¾—åˆ°ï¼š

```
[factorial.v:2] n <= 1: false
[factorial.v:2] n <= 1: false
[factorial.v:2] n <= 1: false
[factorial.v:2] n <= 1: false
[factorial.v:2] n <= 1: true
[factorial.v:3] 1: 1
[factorial.v:5] n * factorial(n - 1): 2
[factorial.v:5] n * factorial(n - 1): 6
[factorial.v:5] n * factorial(n - 1): 24
[factorial.v:5] n * factorial(n - 1): 120
120
```

è¯·æ³¨æ„ï¼Œ`dump(expr)` å°†è·Ÿè¸ªæºä½ç½®ã€è¡¨è¾¾å¼æœ¬èº«ä»¥åŠè¡¨è¾¾å¼çš„å€¼ã€‚

## æ¨¡å—

æ¯ä¸ªä½äºæ–‡ä»¶å¤¹æ ¹ç›®å½•çš„æ–‡ä»¶éƒ½å±äºåŒä¸€ä¸ªæ¨¡å—ã€‚ç®€å•çš„ç¨‹åºä¸éœ€è¦æŒ‡å®šæ¨¡å—åç§°ï¼Œé»˜è®¤ä¸º 'main'ã€‚

å‚è§[ç¬¦å·å¯è§æ€§](#ç¬¦å·å¯è§æ€§)ï¼Œ[è®¿é—®ä¿®é¥°ç¬¦](#è®¿é—®ä¿®é¥°ç¬¦)ã€‚

### åˆ›å»ºæ¨¡å—

Væ˜¯ä¸€é—¨éå¸¸æ¨¡å—åŒ–çš„è¯­è¨€ã€‚é¼“åŠ±åˆ›å»ºå¯é‡ç”¨çš„æ¨¡å—ï¼Œå¹¶ä¸”éå¸¸å®¹æ˜“å®ç°ã€‚
è¦åˆ›å»ºä¸€ä¸ªæ–°æ¨¡å—ï¼Œåˆ›å»ºä¸€ä¸ªåŒ…å«ä½ çš„æ¨¡å—åçš„ç›®å½•ï¼Œå…¶ä¸­åŒ…å«å…·æœ‰ä»£ç çš„.væ–‡ä»¶ï¼š

```shell
cd ~/code/modules
mkdir mymodule
vim mymodule/myfile.v
```

```v failcompile
// myfile.v
module mymodule

// è¦å¯¼å‡ºä¸€ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å¿…é¡»ä½¿ç”¨ `pub`
pub fn say_hi() {
	println('hello from mymodule!')
}
```

æ¨¡å—å†…çš„æ‰€æœ‰é¡¹ç›®éƒ½å¯ä»¥åœ¨æ¨¡å—çš„æ–‡ä»¶ä¹‹é—´ä½¿ç”¨ï¼Œæ— è®ºæ˜¯å¦ä»¥ `pub` å…³é”®å­—ä¸ºå‰ç¼€ã€‚

```v failcompile
// myfile2.v
module mymodule

pub fn say_hi_and_bye() {
	say_hi() // æ¥è‡ª myfile.v
	println('goodbye from mymodule')
}
```

ç°åœ¨ä½ å¯ä»¥åœ¨ä½ çš„ä»£ç ä¸­ä½¿ç”¨ `mymodule` äº†ï¼š

```v failcompile
import mymodule

fn main() {
	mymodule.say_hi()
	mymodule.say_hi_and_bye()
}
```

* æ¨¡å—ååº”è¯¥ç®€çŸ­ï¼Œä¸è¶…è¿‡10ä¸ªå­—ç¬¦ã€‚
* æ¨¡å—åå¿…é¡»ä½¿ç”¨ `snake_case`ã€‚
* ä¸å…è®¸å¾ªç¯å¯¼å…¥ã€‚
* ä½ å¯ä»¥åœ¨ä¸€ä¸ªæ¨¡å—ä¸­æ‹¥æœ‰ä»»æ„æ•°é‡çš„ .v æ–‡ä»¶ã€‚
* ä½ å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹åˆ›å»ºæ¨¡å—ã€‚
* æ‰€æœ‰æ¨¡å—éƒ½ä¼šé™æ€ç¼–è¯‘åˆ°ä¸€ä¸ªå•ç‹¬çš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­ã€‚

### `init` å‡½æ•°

å¦‚æœä½ å¸Œæœ›æ¨¡å—åœ¨å¯¼å…¥æ—¶è‡ªåŠ¨è°ƒç”¨ä¸€äº›è®¾ç½®/åˆå§‹åŒ–ä»£ç ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸€ä¸ªæ¨¡å— `init` å‡½æ•°ï¼š

```v
fn init() {
	// åœ¨è¿™é‡Œæ”¾ç½®ä½ çš„åˆå§‹åŒ–ä»£ç ...
}
```

`init` å‡½æ•°ä¸èƒ½æ˜¯å…¬å…±ï¼ˆpubï¼‰çš„ - å®ƒå°†è‡ªåŠ¨è°ƒç”¨ã€‚è¿™ä¸ªåŠŸèƒ½ç‰¹åˆ«é€‚ç”¨äºåˆå§‹åŒ–Cåº“ã€‚

## ç±»å‹å£°æ˜

### ç±»å‹åˆ«å

è¦å°†ä¸€ä¸ªæ–°ç±»å‹ `NewType` å®šä¹‰ä¸º `ExistingType` çš„åˆ«åï¼Œ
è¯·ä½¿ç”¨ `type NewType = ExistingType`ã€‚<br/>
è¿™æ˜¯[æ€»å’Œç±»å‹](#sum-types)å£°æ˜çš„ä¸€ç§ç‰¹æ®Šæƒ…å†µã€‚

### æšä¸¾

```v
enum Color as u8 {
	red
	green
	blue
}

mut color := Color.red
// V çŸ¥é“ `color` æ˜¯ä¸€ä¸ª `Color`ã€‚åœ¨è¿™é‡Œæ²¡æœ‰å¿…è¦ä½¿ç”¨ `color = Color.green`ã€‚
color = .green
println(color) // "green"
match color {
	.red { println('é¢œè‰²æ˜¯çº¢è‰²') }
	.green { println('é¢œè‰²æ˜¯ç»¿è‰²') }
	.blue { println('é¢œè‰²æ˜¯è“è‰²') }
}
```

æšä¸¾ç±»å‹å¯ä»¥æ˜¯ä»»ä½•æ•´æ•°ç±»å‹ï¼Œä½†å¦‚æœæ˜¯ `int` çš„è¯å¯ä»¥çœç•¥ï¼š`enum Color {`ã€‚

æšä¸¾åŒ¹é…å¿…é¡»æ˜¯å…¨é¢çš„ï¼Œæˆ–è€…å…·æœ‰ä¸€ä¸ª `else` åˆ†æ”¯ã€‚
è¿™å¯ä»¥ç¡®ä¿å¦‚æœæ·»åŠ äº†ä¸€ä¸ªæ–°çš„æšä¸¾å­—æ®µï¼Œå®ƒå°†åœ¨ä»£ç çš„æ‰€æœ‰åœ°æ–¹è¿›è¡Œå¤„ç†ã€‚

æšä¸¾å­—æ®µä¸èƒ½é‡ç”¨ä¿ç•™å…³é”®å­—ã€‚ä¸è¿‡ï¼Œä¿ç•™å…³é”®å­—å¯ä»¥ç”¨ @ ç¬¦å·è½¬ä¹‰ï¼š

```v
enum Color {
	@none
	red
	green
	blue
}

color := Color.@none
println(color)
```

æ•´æ•°å¯ä»¥èµ‹ç»™æšä¸¾å­—æ®µï¼š

```v
enum Grocery {
	apple
	orange = 5
	pear
}

g1 := int(Grocery.apple)
g2 := int(Grocery.orange)
g3 := int(Grocery.pear)
println('æ‚è´§ IDï¼š${g1}ï¼Œ${g2}ï¼Œ${g3}')
```

è¾“å‡ºï¼š`æ‚è´§ IDï¼š0ï¼Œ5ï¼Œ6`ã€‚

ä¸å…è®¸åœ¨æšä¸¾å˜é‡ä¸Šè¿›è¡Œæ“ä½œï¼›å®ƒä»¬å¿…é¡»æ˜¾å¼è½¬æ¢ä¸º `int`ã€‚

æšä¸¾å¯ä»¥åƒç»“æ„ä½“ä¸€æ ·æ‹¥æœ‰æ–¹æ³•ï¼š

```v
enum Cycle {
	one
	two
	three
}

fn (c Cycle) next() Cycle {
	match c {
		.one {
			return .two
		}
		.two {
			return .three
		}
		.three {
			return .one
		}
	}
}

mut c := Cycle.one
for _ in 0 .. 10 {
	println(c)
	c = c.next()
}
```

è¾“å‡ºï¼š

```
one
two
three
one
two
three
one
two
three
one
```

### å‡½æ•°ç±»å‹

ä½ å¯ä»¥ä½¿ç”¨ç±»å‹åˆ«åæ¥å‘½åç‰¹å®šçš„å‡½æ•°ç­¾åï¼Œä¾‹å¦‚ï¼š

```v
type Filter = fn (string) string
```

è¿™ä¸ä»»ä½•å…¶ä»–ç±»å‹ä¸€æ ·å·¥ä½œ - ä¾‹å¦‚ï¼Œä¸€ä¸ªå‡½æ•°å¯ä»¥æ¥å—ä¸€ä¸ªå‡½æ•°ç±»å‹çš„å‚æ•°ï¼š

```v
type Filter = fn (string) string

fn filter(s string, f Filter) string {
	return f(s)
}
```

V æ”¯æŒé¸­å­ç±»å‹ï¼Œå› æ­¤å‡½æ•°ä¸éœ€è¦å£°æ˜ä¸å‡½æ•°ç±»å‹çš„å…¼å®¹æ€§ - å®ƒä»¬åªéœ€è¦æ˜¯å…¼å®¹çš„ï¼š

```v
fn uppercase(s string) string {
	return s.to_upper()
}

// ç°åœ¨ `uppercase` å¯ä»¥åœ¨ä»»ä½•éœ€è¦ `Filter` çš„åœ°æ–¹ä½¿ç”¨
```

å…¼å®¹çš„å‡½æ•°ä¹Ÿå¯ä»¥æ˜¾å¼è½¬æ¢ä¸ºå‡½æ•°ç±»å‹ï¼š

```v oksyntax
my_filter := Filter(uppercase)
```

è¿™é‡Œçš„è½¬æ¢çº¯ç²¹æ˜¯ä¿¡æ¯æ€§çš„ - å†æ¬¡å¼ºè°ƒï¼Œé¸­å­ç±»å‹æ„å‘³ç€ç»“æœç±»å‹ä¸æ˜¾å¼è½¬æ¢æ—¶çš„ç±»å‹ç›¸åŒï¼š

```v oksyntax
my_filter := uppercase
```

ä½ å¯ä»¥å°†åˆ†é…çš„å‡½æ•°ä½œä¸ºå‚æ•°ä¼ é€’ï¼š

```v oksyntax
println(filter('Hello world', my_filter)) // è¾“å‡º `HELLO WORLD`
```

å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥ç›´æ¥ä¼ é€’å®ƒï¼Œè€Œä¸ä½¿ç”¨æœ¬åœ°å˜é‡ï¼š

```v oksyntax
println(filter('Hello world', uppercase))
```

åŒ¿åå‡½æ•°ä¹Ÿå¯ä»¥è¿™æ ·ä½¿ç”¨ï¼š

```v oksyntax
println(filter('Hello world', fn (s string) string {
	return s.to_upper()
}))
```

ä½ å¯ä»¥åœ¨[è¿™é‡Œ](https://github.com/vlang/v/tree/master/examples/function_types.v)æ‰¾åˆ°å®Œæ•´çš„ç¤ºä¾‹ã€‚

### æ¥å£

```v
// interface-example.1
struct Dog {
	breed string
}

fn (d Dog) speak() string {
	return 'æ±ªæ±ª'
}

struct Cat {
	breed string
}

fn (c Cat) speak() string {
	return 'å–µå–µ'
}

// ä¸åƒ Goï¼Œä½†ç±»ä¼¼ TypeScriptï¼ŒV çš„æ¥å£å¯ä»¥åŒæ—¶å®šä¹‰å­—æ®µå’Œæ–¹æ³•ã€‚
interface Speaker {
	breed string
	speak() string
}

fn main() {
	dog := Dog{'è±æ˜‚è´æ ¼çŠ¬'}
	cat := Cat{'æš¹ç½—çŒ«'}

	mut arr := []Speaker{}
	arr << dog
	arr << cat
	for item in arr {
		println('ä¸€åª ${item.breed} è¯´ï¼š${item.speak()}')
	}
}
```

#### å®ç°æ¥å£

ç±»å‹é€šè¿‡å®ç°å…¶æ–¹æ³•å’Œå­—æ®µæ¥å®ç°æ¥å£ã€‚
æ— éœ€æ˜¾å¼å£°æ˜æ„å›¾ï¼Œä¹Ÿæ— éœ€ "implements" å…³é”®å­—ã€‚

æ¥å£å¯ä»¥æœ‰ä¸€ä¸ª `mut:` éƒ¨åˆ†ã€‚å®ç°ç±»å‹

å°†éœ€è¦
å…·æœ‰æ¥å£ `mut:` éƒ¨åˆ†ä¸­å£°æ˜çš„æ–¹æ³•çš„ `mut` æ¥æ”¶å™¨ã€‚

```v
// interface-example.2
module main

interface Foo {
	write(string) string
}

// => å®ç°æ¥å£ Foo çš„ç±»å‹çš„æ–¹æ³•ç­¾ååº”è¯¥æ˜¯ï¼š
// `fn (s Type) write(a string) string`

interface Bar {
mut:
	write(string) string
}

// => å®ç°æ¥å£ Bar çš„ç±»å‹çš„æ–¹æ³•ç­¾ååº”è¯¥æ˜¯ï¼š
// `fn (mut s Type) write(a string) string`

struct MyStruct {}

// MyStruct å®ç°æ¥å£ Fooï¼Œä½† *ä¸* å®ç°æ¥å£ Bar
fn (s MyStruct) write(a string) string {
	return a
}

fn main() {
	s1 := MyStruct{}
	fn1(s1)
	// fn2(s1) -> ç¼–è¯‘é”™è¯¯ï¼Œå› ä¸º MyStruct æ²¡æœ‰å®ç° Bar
}

fn fn1(s Foo) {
	println(s.write('Foo'))
}

// fn fn2(s Bar) { // ä¸åŒ¹é…
//      println(s.write('Foo'))
// }
```

#### è½¬æ¢æ¥å£

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨åŠ¨æ€ç±»å‹è½¬æ¢è¿ç®—ç¬¦æ¥æµ‹è¯•æ¥å£çš„åº•å±‚ç±»å‹ã€‚

> **æ³¨æ„**
> åŠ¨æ€ç±»å‹è½¬æ¢å°†å˜é‡ `s` è½¬æ¢ä¸ºæŒ‡é’ˆï¼Œä½äºæœ¬ç¤ºä¾‹ä¸­çš„ `if` è¯­å¥å†…éƒ¨ï¼š

```v oksyntax
// interface-example.3 (ä» interface-example.1 ç»§ç»­)
interface Something {}

fn announce(s Something) {
	if s is Dog {
		println('ä¸€åª ${s.breed} ç‹—') // `s` è‡ªåŠ¨è½¬æ¢ä¸º `Dog` (æ™ºèƒ½è½¬æ¢)
	} else if s is Cat {
		println('ä¸€åªçŒ«è¯´ ${s.speak()}')
	} else {
		println('å…¶ä»–ä¸œè¥¿')
	}
}

fn main() {
	dog := Dog{'è±æ˜‚è´æ ¼çŠ¬'}
	cat := Cat{'æš¹ç½—çŒ«'}
	announce(dog)
	announce(cat)
}
```

```v
// interface-example.4
interface IFoo {
	foo()
}

interface IBar {
	bar()
}

// ä»…å®ç° IFoo
struct SFoo {}

fn (sf SFoo) foo() {}

// åŒæ—¶å®ç° IFoo å’Œ IBar
struct SFooBar {}

fn (sfb SFooBar) foo() {}

fn (sfb SFooBar) bar() {
	dump('è¿™å®ç°äº† IBar')
}

fn main() {
	mut arr := []IFoo{}
	arr << SFoo{}
	arr << SFooBar{}

	for a in arr {
		dump(a)
		// ä¸ºäº†æ‰§è¡Œå®ç°äº† IBar çš„å®ä¾‹ã€‚
		if a is IBar {
			a.bar()
		}
	}
}
```

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…[åŠ¨æ€ç±»å‹è½¬æ¢](#dynamic-casts)ã€‚

#### æ¥å£æ–¹æ³•å®šä¹‰

ä¹Ÿä¸åƒ Goï¼Œæ¥å£å¯ä»¥æ‹¥æœ‰è‡ªå·±çš„æ–¹æ³•ï¼Œç±»ä¼¼äºç»“æ„ä½“å¯ä»¥æ‹¥æœ‰è‡ªå·±çš„æ–¹æ³•ã€‚
è¿™äº› 'æ¥å£æ–¹æ³•' ä¸éœ€è¦è¢«å®ç°ï¼Œè€Œæ˜¯ç”±å®ç°è¯¥æ¥å£çš„ç»“æ„ä½“æ¥å®ç°ã€‚
å®ƒä»¬åªæ˜¯ä¸€ç§ä¾¿åˆ©çš„æ–¹å¼ï¼Œå¯ä»¥å†™æˆ `i.some_function()`ï¼Œè€Œä¸æ˜¯ `some_function(i)`ï¼Œç±»ä¼¼äºç»“æ„ä½“æ–¹æ³•å¯ä»¥è¢«çœ‹ä½œæ˜¯ `s.xyz()` çš„ä¸€ç§ä¾¿åˆ©æ–¹å¼ï¼Œè€Œä¸æ˜¯ `xyz(s)`ã€‚

> **æ³¨æ„**
> æ­¤åŠŸèƒ½ä¸åƒ C# ä¸­çš„ "é»˜è®¤å®ç°"ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªç»“æ„ä½“ `cat` è¢«åŒ…è£…åœ¨ä¸€ä¸ªæ¥å£ `a` ä¸­ï¼Œè¯¥æ¥å£å…·æœ‰ä¸ç»“æ„ä½“å®ç°çš„æ–¹æ³•åŒåçš„æ–¹æ³• `speak`ï¼Œå¹¶ä¸”ä½ è°ƒç”¨ `a.speak()`ï¼Œåªä¼šè°ƒç”¨æ¥å£æ–¹æ³•ï¼š

```v
interface Adoptable {}

fn (a Adoptable) speak() string {
	return 'è¯·æ”¶å…»æˆ‘ï¼'
}

struct Cat {}

fn (c Cat) speak() string {
	return 'å–µå–µï¼'
}

struct Dog {}

fn main() {
	cat := Cat{}
	assert dump(cat.speak()) == 'å–µå–µï¼'
	//
	a := Adoptable(cat)
	assert dump(a.speak()) == 'è¯·æ”¶å…»æˆ‘ï¼' // è°ƒç”¨ Adoptable çš„ `speak`
	if a is Cat {
		// ä½†æ˜¯ï¼Œåœ¨è¿™ä¸ª `if` ä¸­ï¼ŒV çŸ¥é“ `a` ä¸ä»…ä»…æ˜¯ä¸€ä¸ª Adoptableï¼Œè€Œæ˜¯ä¸€ä¸ªçœŸæ­£çš„ Catï¼Œæ‰€ä»¥å®ƒå°†ä½¿ç”¨ Cat çš„ `speak`ï¼Œè€Œä¸æ˜¯ Adoptable çš„ `speak`ï¼š
		dump(a.speak()) // å–µå–µï¼
	}
	//
	b := Adoptable(Dog{})
	assert dump(b.speak()) == 'è¯·æ”¶å…»æˆ‘ï¼' // è°ƒç”¨ Adoptable çš„ `speak`
	// if b is Dog {
	// 	dump(b.speak()) // é”™è¯¯ï¼šæœªçŸ¥çš„æ–¹æ³•æˆ–å­—æ®µï¼šDog.speak
	// }
}
```

#### åµŒå…¥å¼æ¥å£

æ¥å£æ”¯æŒåµŒå…¥ï¼Œå°±åƒç»“æ„ä½“ä¸€æ ·ï¼š

```v
pub interface Reader {
mut:
	read(mut buf []u8) ?int
}

pub interface Writer {
mut:
	write(buf []u8) ?int
}

// ReaderWriter åµŒå…¥äº† Reader å’Œ Writerã€‚
// æ•ˆæœä¸å°† Reader çš„æ‰€æœ‰æ–¹æ³•/å­—æ®µå’Œ Writer çš„æ‰€æœ‰æ–¹æ³•/å­—æ®µå¤åˆ¶/ç²˜è´´åˆ° ReaderWriter ä¸­ç›¸åŒã€‚
pub interface ReaderWriter {
	Reader
	Writer
}
```

### Sum Types (åˆæˆç±»å‹)

æ€»å’Œç±»å‹å®ä¾‹å¯ä»¥åŒ…å«å¤šç§ä¸åŒç±»å‹çš„å€¼ã€‚ä½¿ç”¨ `type` å…³é”®å­—å£°æ˜æ€»å’Œç±»å‹ï¼š

```v
struct Moon {}

struct Mars {}

struct Venus {}

type World = Mars | Moon | Venus

sum := World(Moon{})
assert sum.type_name() == 'Moon'
println(sum)
```

å†…å»ºæ–¹æ³• `type_name` è¿”å›å½“å‰æŒæœ‰ç±»å‹çš„åç§°ã€‚

åˆ©ç”¨æ€»å’Œç±»å‹ï¼Œä½ å¯ä»¥æ„å»ºé€’å½’ç»“æ„ï¼Œå¹¶åœ¨å…¶ä¸Šç¼–å†™ç®€æ´è€ŒåŠŸèƒ½å¼ºå¤§çš„ä»£ç ã€‚

```v
// V çš„äºŒå‰æ ‘
struct Empty {}

struct Node {
	value f64
	left  Tree
	right Tree
}

type Tree = Empty | Node

// å¯¹æ‰€æœ‰èŠ‚ç‚¹å€¼æ±‚å’Œ

fn sum(tree Tree) f64 {
	return match tree {
		Empty { 0 }
		Node { tree.value + sum(tree.left) + sum(tree.right) }
	}
}

fn main() {
	left := Node{0.2, Empty{}, Empty{}}
	right := Node{0.3, Empty{}, Node{0.4, Empty{}, Empty{}}}
	tree := Node{0.5, left, right}
	println(sum(tree)) // 0.2 + 0.3 + 0.4 + 0.5 = 1.4
}
```

#### åŠ¨æ€ç±»å‹è½¬æ¢

è¦æ£€æŸ¥æ€»å’Œç±»å‹å®ä¾‹æ˜¯å¦æŒæœ‰ç‰¹å®šç±»å‹ï¼Œè¯·ä½¿ç”¨ `sum is Type`ã€‚è¦å°†æ€»å’Œç±»å‹è½¬æ¢ä¸ºå…¶å˜ä½“ä¹‹ä¸€ï¼Œå¯ä»¥ä½¿ç”¨ `sum as Type`ï¼š

```v
struct Moon {}

struct Mars {}

struct Venus {}

type World = Mars | Moon | Venus

fn (m Mars) dust_storm() bool {
	return true
}

fn main() {
	mut w := World(Moon{})
	assert w is Moon
	w = Mars{}
	// ä½¿ç”¨ `as` è®¿é—® Mars å®ä¾‹
	mars := w as Mars
	if mars.dust_storm() {
		println('å¤©æ°”ä¸å¥½ï¼')
	}
}
```

å¦‚æœ `w` ä¸æŒæœ‰ `Mars` å®ä¾‹ï¼Œ`as` å°†æŠ›å‡ºä¸€ä¸ª panicã€‚æ›´å®‰å…¨çš„æ–¹æ³•æ˜¯ä½¿ç”¨æ™ºèƒ½è½¬æ¢ã€‚

#### æ™ºèƒ½è½¬æ¢

```v oksyntax
if w is Mars {
	assert typeof(w).name == 'Mars'
	if w.dust_storm() {
		println('å¤©æ°”ä¸å¥½ï¼')
	}
}
```

åœ¨ `if` è¯­å¥çš„ä»£ç å—ä¸­ï¼Œ`w` å…·æœ‰ç±»å‹ `Mars`ã€‚è¿™è¢«ç§°ä¸º*æµæ„ŸçŸ¥ç±»å‹*ã€‚
å¦‚æœ `w` æ˜¯ä¸€ä¸ªå¯å˜æ ‡è¯†ç¬¦ï¼Œé‚£ä¹ˆå¦‚æœç¼–è¯‘å™¨æ™ºèƒ½è½¬æ¢å®ƒè€Œæ²¡æœ‰è­¦å‘Šï¼Œé‚£å°†æ˜¯ä¸å®‰å…¨çš„ã€‚
è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨ `is` è¡¨è¾¾å¼ä¹‹å‰å¿…é¡»å£°æ˜ `mut` çš„åŸå› ï¼š

```v ignore
if mut w is Mars {
	assert typeof(w).name == 'Mars'
	if w.dust_storm() {
		println('å¤©æ°”ä¸å¥½ï¼')
	}
}
```

å¦åˆ™ï¼Œ`w` ä¼šä¿ç•™å…¶åŸå§‹ç±»å‹ã€‚

> è¿™å¯¹äºç®€å•å˜é‡å’Œåƒ `user.name` è¿™æ ·çš„å¤æ‚è¡¨è¾¾å¼éƒ½é€‚ç”¨ã€‚

#### åŒ¹é…æ€»å’Œç±»å‹

ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ `match` æ¥ç¡®å®šå˜ä½“ï¼š

```v
struct Moon {}

struct Mars {}

struct Venus {}

type World = Mars | Moon | Venus

fn open_parachutes(n int) {
	println(n)
}

fn land(w World) {
	match w {
		Moon {} // æ²¡æœ‰å¤§æ°”å±‚
		Mars {
			// è½»å¾®çš„å¤§æ°”å±‚
			open_parachutes(3)
		}
		Venus {
			// åšé‡çš„å¤§æ°”å±‚
			open_parachutes(1)
		}
	}
}
```

`match` å¿…é¡»å¯¹æ¯ä¸ªå˜ä½“éƒ½æœ‰ä¸€ä¸ªæ¨¡å¼ï¼Œæˆ–è€…æœ‰ä¸€ä¸ª `else` åˆ†æ”¯ã€‚

```v ignore
struct Moon {}
struct Mars {}
struct Venus {}

type World = Moon | Mars | Venus

fn (m Moon) moon_walk() {}
fn (m Mars) shiver() {}
fn (v Venus) sweat() {}

fn pass_time(w World) {
    match w {
        // ä½¿ç”¨è¢«é®è”½çš„ match å˜é‡ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹æ˜¯ `w` (æ™ºèƒ½è½¬æ¢)
        Moon { w.moon_walk() }
        Mars { w.shiver() }
        else {}
    }
}
```

### Option/Result ç±»å‹å’Œé”™è¯¯å¤„ç†

Option ç±»å‹ç”¨äºå¯èƒ½ä»£è¡¨ `none` çš„ç±»å‹ã€‚Result ç±»å‹å¯ä»¥ä»£è¡¨ä»å‡½æ•°è¿”å›çš„é”™è¯¯ã€‚

é€šè¿‡åœ¨ç±»å‹åç§°å‰é¢æ·»åŠ  `?` æ¥å£°æ˜ Option ç±»å‹ï¼š`?Type`ã€‚
Result ç±»å‹ä½¿ç”¨ `!`ï¼š`!Type`ã€‚

```v
struct User {
	id   int
	name string
}

struct Repo {
	users []User
}

fn (r Repo) find_user_by_id(id int) !User {
	for user in r.users {
		if user.id == id {
			// V ä¼šè‡ªåŠ¨å°†å…¶åŒ…è£…æˆ result æˆ– option ç±»å‹
			return user
		}
	}
	return error('æ‰¾ä¸åˆ°ç”¨æˆ· ${id}')
}

// ä½¿ç”¨ option ç‰ˆæœ¬çš„å‡½æ•°
fn (r Repo) find_user_by_id2(id int) ?User {
	for user in r.users {
		if user.id == id {
			return user
		}
	}
	return none
}

fn main() {
	repo := Repo{
		users: [User{1, 'Andrew'}, User{2, 'Bob'}, User{10, 'Charles'}]
	}
	user := repo.find_user_by_id(10) or { // option/result ç±»å‹å¿…é¡»åœ¨ `or` å—ä¸­å¤„ç†
		println(err)
		return
	}
	println(user.id) // "10"
	println(user.name) // "Charles"

	user2 := repo.find_user_by_id2(10) or { return }
}
```

V æ›¾ç»å°† `Option` å’Œ `Result` ç»“åˆæˆä¸€ä¸ªç±»å‹ï¼Œç°åœ¨å®ƒä»¬æ˜¯åˆ†å¼€çš„ã€‚

å°†å‡½æ•° "å‡çº§" ä¸º option/result å‡½æ•°æ‰€éœ€çš„å·¥ä½œé‡å¾ˆå°ï¼›
åªéœ€åœ¨è¿”å›ç±»å‹å‰æ·»åŠ  `?` æˆ– `!`ï¼Œå¹¶åœ¨å‘ç”Ÿé”™è¯¯æ—¶è¿”å› `none` æˆ–é”™è¯¯ï¼ˆåˆ†åˆ«ï¼‰ã€‚

è¿™æ˜¯ V ä¸­é”™è¯¯å¤„ç†çš„ä¸»è¦æœºåˆ¶ã€‚å®ƒä»¬ä»ç„¶æ˜¯å€¼ï¼Œå°±åƒåœ¨ Go ä¸­ä¸€æ ·ï¼Œ
ä½†ä¼˜ç‚¹æ˜¯é”™è¯¯ä¸èƒ½æœªç»å¤„ç†ï¼Œå¹¶ä¸”å¤„ç†å®ƒä»¬è¦ç®€æ´å¾—å¤šã€‚
ä¸å…¶ä»–è¯­è¨€ä¸åŒï¼ŒV ä¸ä½¿ç”¨ `throw/try/catch` å—æ¥å¤„ç†å¼‚å¸¸ã€‚

`err` åœ¨ `or` å—ä¸­å®šä¹‰ï¼Œå¹¶è¢«è®¾ç½®ä¸ºä¼ é€’ç»™ `error()` å‡½æ•°çš„å­—ç¬¦ä¸²æ¶ˆæ¯ã€‚



```v oksyntax
user := repo.find_user_by_id(7) or {
	println(err) // "æ‰¾ä¸åˆ°ç”¨æˆ· 7"
	return
}
```

#### å¤„ç† option/result

æœ‰å››ç§å¤„ç† option/result çš„æ–¹æ³•ã€‚ç¬¬ä¸€ç§æ–¹æ³•æ˜¯ä¼ æ’­é”™è¯¯ï¼š

```v
import net.http

fn f(url string) !string {
	resp := http.get(url)!
	return resp.body
}
```

`http.get` è¿”å› `!http.Response`ã€‚å› ä¸º `!` è·Ÿåœ¨è°ƒç”¨åé¢ï¼Œé”™è¯¯å°†ä¼ æ’­ç»™ `f` çš„è°ƒç”¨è€…ã€‚
å½“åœ¨äº§ç”Ÿ option çš„å‡½æ•°è°ƒç”¨åä½¿ç”¨ `?` æ—¶ï¼Œå°é—­å‡½æ•°å¿…é¡»è¿”å›ä¸€ä¸ª optionã€‚
å¦‚æœåœ¨ `main()` å‡½æ•°ä¸­ä½¿ç”¨é”™è¯¯ä¼ æ’­ï¼Œå®ƒå°†å¯¼è‡´ `panic`ï¼Œå› ä¸ºé”™è¯¯æ— æ³•è¿›ä¸€æ­¥ä¼ æ’­ã€‚

`f` çš„ä¸»ä½“æœ¬è´¨ä¸Šæ˜¯ä»¥ä¸‹ç‰ˆæœ¬çš„ç²¾ç®€ç‰ˆï¼š

```v ignore
    resp := http.get(url) or { return err }
    return resp.body
```

---

ç¬¬äºŒç§æ–¹æ³•æ˜¯æ—©æ—©åœ°åœæ­¢æ‰§è¡Œï¼š

```v oksyntax
user := repo.find_user_by_id(7) or { return }
```

åœ¨è¿™é‡Œï¼Œä½ å¯ä»¥è°ƒç”¨ `panic()` æˆ– `exit()`ï¼Œå®ƒå°†åœæ­¢æ•´ä¸ªç¨‹åºçš„æ‰§è¡Œï¼Œ
æˆ–è€…ä½¿ç”¨æ§åˆ¶æµè¯­å¥ï¼ˆ`return`ã€`break`ã€`continue` ç­‰ï¼‰æ¥ä¸­æ–­å½“å‰å—çš„æ‰§è¡Œã€‚

> **æ³¨æ„**
> `break` å’Œ `continue` åªèƒ½åœ¨ `for` å¾ªç¯å†…ä½¿ç”¨ã€‚

V æ²¡æœ‰ä¸€ç§å¼ºåˆ¶â€œå±•å¼€â€ option çš„æ–¹æ³•ï¼ˆå°±åƒå…¶ä»–è¯­è¨€ä¸€æ ·ï¼Œ
ä¾‹å¦‚ Rust çš„ `unwrap()` æˆ– Swift çš„ `!`ï¼‰ã€‚ä¸ºæ­¤ï¼Œè¯·æ”¹ç”¨ `or { panic(err) }`ã€‚

---

ç¬¬ä¸‰ç§æ–¹æ³•æ˜¯åœ¨ `or` å—çš„æœ«å°¾æä¾›ä¸€ä¸ªé»˜è®¤å€¼ã€‚
åœ¨å‘ç”Ÿé”™è¯¯çš„æƒ…å†µä¸‹ï¼Œè¯¥å€¼å°†è¢«åˆ†é…ï¼Œå› æ­¤å®ƒå¿…é¡»ä¸æ­£åœ¨å¤„ç†çš„ option çš„å†…å®¹å…·æœ‰ç›¸åŒçš„ç±»å‹ã€‚

```v
fn do_something(s string) !string {
	if s == 'foo' {
		return 'foo'
	}
	return error('æ— æ•ˆå­—ç¬¦ä¸²')
}

a := do_something('foo') or { 'é»˜è®¤å€¼' } // a å°†ä¸º 'foo'
b := do_something('bar') or { 'é»˜è®¤å€¼' } // b å°†ä¸º 'é»˜è®¤å€¼'
println(a)
println(b)
```

---

ç¬¬å››ç§æ–¹æ³•æ˜¯ä½¿ç”¨ `if` å±•å¼€ï¼š

```v
import net.http

if resp := http.get('https://google.com') {
	println(resp.body) // resp æ˜¯ä¸€ä¸ª http.Responseï¼Œè€Œä¸æ˜¯ option
} else {
	println(err)
}
```

ä¸Šé¢ï¼Œ`http.get` è¿”å›ä¸€ä¸ª `!http.Response`ã€‚`resp` ä»…åœ¨ç¬¬ä¸€ä¸ª
`if` åˆ†æ”¯çš„ä½œç”¨åŸŸå†…ã€‚`err` ä»…åœ¨ `else` åˆ†æ”¯çš„ä½œç”¨åŸŸå†…ã€‚

### è‡ªå®šä¹‰é”™è¯¯ç±»å‹

V å…è®¸ä½ é€šè¿‡ `IError` æ¥å£å®šä¹‰è‡ªå®šä¹‰é”™è¯¯ç±»å‹ã€‚è¯¥æ¥å£è¦æ±‚å®ç°ä¸¤ä¸ªæ–¹æ³•ï¼š`msg() string` å’Œ `code() int`ã€‚ä»»ä½•å®ç°äº†è¿™äº›æ–¹æ³•çš„ç±»å‹éƒ½å¯ä»¥ç”¨ä½œé”™è¯¯ã€‚

åœ¨å®šä¹‰è‡ªå®šä¹‰é”™è¯¯ç±»å‹æ—¶ï¼Œå»ºè®®åµŒå…¥å†…å»ºçš„ `Error` é»˜è®¤å®ç°ã€‚è¿™ä¸ºä¸¤ä¸ªæ‰€éœ€æ–¹æ³•æä¾›äº†ä¸€ä¸ªç©ºçš„é»˜è®¤å®ç°ï¼Œå› æ­¤ä½ åªéœ€è¦å®ç°ä½ çœŸæ­£éœ€è¦çš„éƒ¨åˆ†ï¼Œå¹¶ä¸”å¯ä»¥åœ¨å°†æ¥æä¾›é¢å¤–çš„å®ç”¨å‡½æ•°ã€‚

```v
struct PathError {
	Error
	path string
}

fn (err PathError) msg() string {
	return 'Failed to open path: ${err.path}'
}

fn try_open(path string) ! {
	// V ä¼šè‡ªåŠ¨å°†å…¶è½¬æ¢ä¸º IError
	return PathError{
		path: path
	}
}

fn main() {
	try_open('/tmp') or { panic(err) }
}
```

### æ³›å‹

```v wip
struct Repo[T] {
    db DB
}

struct User {
	id   int
	name string
}

struct Post {
	id   int
	user_id int
	title string
	body string
}

fn new_repo[T](db DB) Repo[T] {
    return Repo[T]{db: db}
}

// è¿™æ˜¯ä¸€ä¸ªæ³›å‹å‡½æ•°ã€‚V å°†ä¸ºå…¶åœ¨ä½¿ç”¨æ—¶çš„æ¯ç§ç±»å‹ç”Ÿæˆç›¸åº”çš„ç‰ˆæœ¬ã€‚
fn (r Repo[T]) find_by_id(id int) ?T {
    table_name := T.name // åœ¨æœ¬ä¾‹ä¸­ï¼Œè·å–ç±»å‹çš„åç§°å¯ä»¥å¾—åˆ°è¡¨å
    return r.db.query_one[T]('select * from ${table_name} where id = ?', id)
}

db := new_db()
users_repo := new_repo[User](db) // è¿”å› Repo[User]
posts_repo := new_repo[Post](db) // è¿”å› Repo[Post]
user := users_repo.find_by_id(1)? // find_by_id[User]
post := posts_repo.find_by_id(1)? // find_by_id[Post]
```

ç›®å‰ï¼Œæ³›å‹å‡½æ•°å®šä¹‰å¿…é¡»å£°æ˜å…¶ç±»å‹å‚æ•°ï¼Œä½†åœ¨å°†æ¥ï¼ŒV å°†ä»è¿è¡Œæ—¶å‚æ•°ç±»å‹çš„å•å­—æ¯ç±»å‹åç§°ä¸­æ¨æ–­å‡ºæ³›å‹ç±»å‹å‚æ•°ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ `find_by_id` å¯ä»¥çœç•¥ `[T]`ï¼Œå› ä¸ºæ¥æ”¶å™¨å‚æ•° `r` ä½¿ç”¨äº†æ³›å‹ç±»å‹ `T`ã€‚

å¦ä¸€ä¸ªç¤ºä¾‹ï¼š

```v
fn compare[T](a T, b T) int {
	if a < b {
		return -1
	}
	if a > b {
		return 1
	}
	return 0
}

// compare[int]
println(compare(1, 0)) // è¾“å‡ºï¼š1
println(compare(1, 1)) //          0
println(compare(1, 2)) //         -1
// compare[string]
println(compare('1', '0')) // è¾“å‡ºï¼š1
println(compare('1', '1')) //          0
println(compare('1', '2')) //         -1
// compare[f64]
println(compare(1.1, 1.0)) // è¾“å‡ºï¼š1
println(compare(1.1, 1.1)) //          0
println(compare(1.1, 1.2)) //         -1
```

## å¹¶å‘

### å¯åŠ¨å¹¶å‘ä»»åŠ¡

V çš„å¹¶å‘æ¨¡å‹ä¸ Go éå¸¸ç›¸ä¼¼ã€‚
ç›®å‰ï¼Œ`spawn foo()` ä¼šåœ¨ä¸åŒçº¿ç¨‹ä¸­å¹¶å‘åœ°è¿è¡Œ `foo()`ï¼š

```v
import math

fn p(a f64, b f64) { // æ™®é€šå‡½æ•°ï¼Œæ— è¿”å›å€¼
	c := math.sqrt(a * a + b * b)
	println(c)
}

fn main() {
	spawn p(3, 4)
	// p å°†åœ¨å¹¶è¡Œçº¿ç¨‹ä¸­è¿è¡Œ
	// ä¹Ÿå¯ä»¥å†™æˆä»¥ä¸‹å½¢å¼
	// spawn fn (a f64, b f64) {
	// 	c := math.sqrt(a * a + b * b)
	// 	println(c)
	// }(3, 4)
}
```

> **æ³¨æ„**
> çº¿ç¨‹ä¾èµ–äºè®¡ç®—æœºçš„ CPUï¼ˆæ ¸å¿ƒ/çº¿ç¨‹æ•°ï¼‰ã€‚
> è¯·æ³¨æ„ï¼Œä½¿ç”¨ `spawn` ç”Ÿæˆçš„ OS çº¿ç¨‹åœ¨å¹¶å‘æ€§æ–¹é¢æœ‰ä¸€äº›é™åˆ¶ï¼Œ
> åŒ…æ‹¬èµ„æºå¼€é”€å’Œå¯æ‰©å±•æ€§é—®é¢˜ï¼Œå¯èƒ½ä¼šå½±å“åœ¨é«˜çº¿ç¨‹è®¡æ•°æƒ…å†µä¸‹çš„æ€§èƒ½ã€‚

è¿˜æœ‰ä¸€ä¸ª `go` å…³é”®å­—ã€‚ç›®å‰ï¼Œ`go foo()` ä¼šè¢« `vfmt` è‡ªåŠ¨é‡å‘½åä¸º `spawn foo()`ï¼Œå¹¶ä¸”å°†ä¼šæœ‰ä¸€ç§æ–¹æ³•å¯ä»¥ä½¿ç”¨ `go` å¯åŠ¨ä¸€ä¸ªåç¨‹ï¼ˆç”±è¿è¡Œæ—¶ç®¡ç†çš„è½»é‡çº§çº¿ç¨‹ï¼‰ã€‚

æœ‰æ—¶éœ€è¦ç­‰å¾…ä¸€ä¸ªå¹¶è¡Œçº¿ç¨‹å®Œæˆã€‚è¿™å¯ä»¥é€šè¿‡ä¸ºå¯åŠ¨çš„çº¿ç¨‹åˆ†é…ä¸€ä¸ª *å¥æŸ„*ï¼Œç„¶åç¨åå¯¹è¯¥å¥æŸ„è°ƒç”¨ `wait()` æ–¹æ³•æ¥å®ç°ï¼š

```v
import math

fn p(a f64, b f64) { // æ™®é€šå‡½æ•°ï¼Œæ— è¿”å›å€¼
	c := math.sqrt(a * a + b * b)
	println(c) // è¾“å‡º `5`
}

fn main() {
	h := spawn p(3, 4)
	// p() åœ¨å¹¶è¡Œçº¿ç¨‹ä¸­è¿è¡Œ
	h.wait()
	// p() ä¸€å®šå·²ç»å®Œæˆ
}
```

è¿™ç§æ–¹æ³•è¿˜å¯ç”¨äºä»åœ¨å¹¶è¡Œçº¿ç¨‹ä¸­è¿è¡Œçš„å‡½æ•°ä¸­è·å–è¿”å›å€¼ã€‚æ— éœ€ä¿®æ”¹å‡½æ•°æœ¬èº«å³å¯è°ƒç”¨å®ƒä»¥å®ç°å¹¶å‘è°ƒç”¨ã€‚

```v
import math { sqrt }

fn get_hypot(a f64, b f64) f64 { // è¿”å›å€¼çš„æ™®é€šå‡½æ•°
	c := sqrt(a * a + b * b)
	return c
}

fn main() {
	g := spawn get_hypot(54.06, 2.08) // ç”Ÿæˆçº¿ç¨‹å¹¶è·å¾—å…¶å¥æŸ„
	h1 := get_hypot(2.32, 16.74) // åœ¨æ­¤å¤„æ‰§è¡Œå…¶ä»–è®¡ç®—
	h2 := g.wait() // è·å–ç”Ÿæˆçº¿ç¨‹çš„ç»“æœ
	println('ç»“æœï¼š${h1}, ${h2}') // è¾“å‡º `ç»“æœï¼š16.9, 54.1`
}
```

å¦‚æœå­˜åœ¨å¤§é‡çš„ä»»åŠ¡ï¼Œå¯èƒ½ä¼šæ›´å®¹æ˜“ä½¿ç”¨çº¿ç¨‹æ•°ç»„æ¥ç®¡ç†å®ƒä»¬ï¼š

```v
import time

fn task(id int, duration int) {
	println('ä»»åŠ¡ ${id} å¼€å§‹')
	time.sleep(duration * time.millisecond)
	println('ä»»åŠ¡ ${id} ç»“æŸ')
}

fn main() {
	mut threads := []thread{}
	threads << spawn task(1, 500)
	threads << spawn task(2, 900)
	threads << spawn task(3, 100)
	threads.wait()
	println('å®Œæˆ')
}

// è¾“å‡ºï¼š
// ä»»åŠ¡ 1 å¼€å§‹
// ä»»åŠ¡ 2 å¼€å§‹
// ä»»åŠ¡ 3 å¼€å§‹
// ä»»åŠ¡ 3 ç»“æŸ
// ä»»åŠ¡ 1 ç»“æŸ
// ä»»åŠ¡ 2 ç»“æŸ
// å®Œæˆ
```

å¦å¤–ï¼Œå¯¹äºè¿”å›ç›¸åŒç±»å‹çš„çº¿ç¨‹ï¼Œè°ƒç”¨çº¿ç¨‹æ•°ç»„çš„ `wait()`
å°†è¿”å›æ‰€æœ‰è®¡ç®—å‡ºçš„å€¼ã€‚

```v
fn expensive_computing(i int) int {
	return i * i
}

fn main() {
	mut threads := []thread int{}
	for i in 1 .. 10 {
		threads << spawn expensive_computing(i)
	}
	// Join all tasks
	r := threads.wait()
	println('æ‰€æœ‰ä½œä¸šå®Œæˆï¼š${r}')
}

// è¾“å‡ºï¼šæ‰€æœ‰ä½œä¸šå®Œæˆï¼š[1, 4, 9, 16, 25, 36, 49, 64, 81]
```

### é€šé“

é€šé“æ˜¯çº¿ç¨‹ä¹‹é—´è¿›è¡Œé€šä¿¡çš„é¦–é€‰æ–¹å¼ã€‚V çš„é€šé“åŸºæœ¬ä¸Šä¸ Go ä¸­çš„é€šé“ç›¸ä¼¼ã€‚ä½ å¯ä»¥å°†å¯¹è±¡æ¨å…¥é€šé“çš„ä¸€ç«¯ï¼Œå¹¶ä»å¦ä¸€ç«¯å¼¹å‡ºå¯¹è±¡ã€‚é€šé“å¯ä»¥æ˜¯æœ‰ç¼“å†²çš„æˆ–æ— ç¼“å†²çš„ï¼Œå¹¶ä¸”å¯ä»¥ä»å¤šä¸ªé€šé“ä¸­è¿›è¡Œ `select`ã€‚

#### è¯­æ³•å’Œç”¨æ³•

é€šé“çš„ç±»å‹ä¸º `chan objtype`ã€‚å¯ä»¥åœ¨å£°æ˜ä¸­æŒ‡å®šä¸€ä¸ªå¯é€‰çš„ç¼“å†²åŒºé•¿åº¦ä½œä¸º `cap` å­—æ®µï¼š

```v
ch := chan int{} // æ— ç¼“å†² - â€œåŒæ­¥â€
ch2 := chan f64{cap: 100} // ç¼“å†²åŒºé•¿åº¦ä¸º 100
```

é€šé“ä¸å¿…å£°æ˜ä¸º `mut`ã€‚ç¼“å†²åŒºé•¿åº¦ä¸æ˜¯ç±»å‹çš„ä¸€éƒ¨åˆ†ï¼Œè€Œæ˜¯ä¸ªä½“é€šé“å¯¹è±¡çš„å­—æ®µã€‚é€šé“å¯ä»¥åƒæ™®é€šå˜é‡ä¸€æ ·ä¼ é€’ç»™çº¿ç¨‹ï¼š

```v
fn f(ch chan int) {
	// ...
}

fn main() {
	ch := chan int{}
	spawn f(ch)
	// ...
}
```

å¯ä»¥ä½¿ç”¨ç®­å¤´è¿ç®—ç¬¦å°†å¯¹è±¡æ¨å…¥é€šé“ã€‚è¯¥è¿ç®—ç¬¦ä¹Ÿå¯ä»¥ç”¨äºä»å¦ä¸€ç«¯å¼¹å‡ºå¯¹è±¡ï¼š

```v
// åˆ›å»ºå¸¦æœ‰ç¼“å†²åŒºçš„é€šé“ï¼Œä»¥ä¾¿åœ¨ç¼“å†²åŒºæœ‰ç©ºé—´æ—¶æ¨é€ä¸ä¼šé˜»å¡
ch := chan int{cap: 1}
ch2 := chan f64{cap: 1}
n := 5
// æ¨é€
ch <- n
ch2 <- 7.3
mut y := f64(0.0)
m := <-ch // å¼¹å‡ºå¹¶åˆ›å»ºæ–°å˜é‡
y = <-ch2 // å¼¹å‡ºåˆ°ç°æœ‰å˜é‡
```

å¯ä»¥å…³é—­é€šé“ä»¥è¡¨ç¤ºä¸å†èƒ½å¤Ÿæ¨é€ä»»ä½•å¯¹è±¡ã€‚ä»»ä½•å°è¯•è¿™æ ·åšçš„ä¼å›¾éƒ½å°†å¯¼è‡´è¿è¡Œæ—¶ panicï¼ˆé™¤éæ˜¯ `select` å’Œ `try_push()` - å‚è§ä¸‹æ–‡ï¼‰ã€‚å°è¯•å¼¹å‡ºå°†ç«‹å³è¿”å›ï¼Œå¦‚æœå…³è”é€šé“å·²å…³é—­å¹¶ä¸”ç¼“å†²åŒºä¸ºç©ºã€‚å¯ä»¥ä½¿ç”¨ `or {}` å—æ¥å¤„ç†è¿™ç§æƒ…å†µï¼ˆå‚è§[å¤„ç†é€‰é¡¹/ç»“æœ](#handling-options

results)ï¼‰ã€‚

```v wip
ch := chan int{}
ch2 := chan f64{}
// ...
ch.close()
// ...
m := <-ch or {
    println('é€šé“å·²å…³é—­')
}

// ä¼ æ’­é”™è¯¯
y := <-ch2 ?
```

#### é€šé“é€‰æ‹©

`select` å‘½ä»¤å…è®¸åŒæ—¶ç›‘è§†å¤šä¸ªé€šé“ï¼Œè€Œä¸ä¼šäº§ç”Ÿæ˜æ˜¾çš„ CPU è´Ÿè½½ã€‚å®ƒç”±ä¸€ç»„å¯èƒ½çš„ä¼ è¾“å’Œç›¸å…³çš„è¯­å¥åˆ†æ”¯ç»„æˆ - ç±»ä¼¼äº [match](#match) å‘½ä»¤ï¼š

```v
import time

fn main() {
	ch := chan f64{}
	ch2 := chan f64{}
	ch3 := chan f64{}
	mut b := 0.0
	c := 1.0
	// ... è®¾ç½®ç”Ÿæˆçš„çº¿ç¨‹ï¼Œå®ƒä»¬å°†åœ¨ ch/ch2 ä¸Šå‘é€
	spawn fn (the_channel chan f64) {
		time.sleep(5 * time.millisecond)
		the_channel <- 1.0
	}(ch)
	spawn fn (the_channel chan f64) {
		time.sleep(1 * time.millisecond)
		the_channel <- 1.0
	}(ch2)
	spawn fn (the_channel chan f64) {
		_ := <-the_channel
	}(ch3)

	select {
		a := <-ch {
			// ä½¿ç”¨ `a` åšä¸€äº›äº‹æƒ…
			eprintln('> a: ${a}')
		}
		b = <-ch2 {
			// ä½¿ç”¨é¢„å…ˆå£°æ˜çš„å˜é‡ `b` åšä¸€äº›äº‹æƒ…
			eprintln('> b: ${b}')
		}
		ch3 <- c {
			// å¦‚æœå‘é€äº† `c`ï¼Œåˆ™åšä¸€äº›äº‹æƒ…
			time.sleep(5 * time.millisecond)
			eprintln('> c: ${c} å·²åœ¨é€šé“ ch3 ä¸Šå‘é€')
		}
		500 * time.millisecond {
			// å¦‚æœåœ¨ 0.5s å†…æ²¡æœ‰é€šé“å°±ç»ªï¼Œåˆ™åšä¸€äº›äº‹æƒ…
			eprintln('> è¶…è¿‡ 0.5s è€Œæ²¡æœ‰é€šé“å‡†å¤‡å°±ç»ª')
		}
	}
	eprintln('> å®Œæˆ')
}
```

è¶…æ—¶åˆ†æ”¯æ˜¯å¯é€‰çš„ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œ`select` å°†ç­‰å¾…æ— é™é•¿çš„æ—¶é—´ã€‚è¿˜å¯ä»¥é€šè¿‡æ·»åŠ  `else { ... }` åˆ†æ”¯ï¼Œåœ¨è°ƒç”¨ `select` æ—¶ç«‹å³è¿›è¡Œå¤„ç†ï¼Œå¦‚æœæ­¤æ—¶æ²¡æœ‰é€šé“å‡†å¤‡å°±ç»ªã€‚`else` å’Œ `<timeout>` æ˜¯äº’æ–¥çš„ã€‚

`select` å‘½ä»¤å¯ä»¥ç”¨ä½œç±»å‹ä¸º `bool` çš„ *è¡¨è¾¾å¼*ï¼Œå¦‚æœæ‰€æœ‰é€šé“éƒ½å…³é—­ï¼Œåˆ™è¿”å› `false`ï¼š

```v wip
if select {
    ch <- a {
        // ...
    }
} {
    // é€šé“å·²æ‰“å¼€
} else {
    // é€šé“å·²å…³é—­
}
```

#### ç‰¹æ®Šé€šé“åŠŸèƒ½

å¯¹äºç‰¹æ®Šç›®çš„ï¼Œæœ‰ä¸€äº›å†…å»ºå­—æ®µå’Œæ–¹æ³•ï¼š

```v
struct Abc {
	x int
}

a := 2.13
ch := chan f64{}
res := ch.try_push(a) // å°è¯•æ‰§è¡Œ `ch <- a`
println(res)
l := ch.len // é˜Ÿåˆ—ä¸­çš„å…ƒç´ æ•°
c := ch.cap // æœ€å¤§é˜Ÿåˆ—é•¿åº¦
is_closed := ch.closed // å¸ƒå°”æ ‡å¿— - é€šé“æ˜¯å¦å·²å…³é—­
println(l)
println(c)
mut b := Abc{}
ch2 := chan Abc{}
res2 := ch2.try_pop(mut b) // å°è¯•æ‰§è¡Œ `b = <-ch2`
```

`try_push/pop()` æ–¹æ³•å°†ç«‹å³è¿”å›ä»¥ä¸‹ç»“æœä¹‹ä¸€ `.success`ã€`.not_ready` æˆ– `.closed` - å–å†³äºæ˜¯å¦å·²ä¼ è¾“å¯¹è±¡æˆ–æ— æ³•ä¼ è¾“çš„åŸå› ã€‚ä¸å»ºè®®åœ¨ç”Ÿäº§ä¸­ä½¿ç”¨è¿™äº›æ–¹æ³•å’Œå­—æ®µ - åŸºäºå®ƒä»¬çš„ç®—æ³•ç»å¸¸å—åˆ°ç«æ€æ¡ä»¶çš„å½±å“ã€‚ç‰¹åˆ«æ˜¯ `.len` å’Œ `.closed` ä¸åº”ç”¨äºåšå‡ºå†³ç­–ã€‚è¯·æ”¹ç”¨ `or` åˆ†æ”¯ã€é”™è¯¯ä¼ æ’­æˆ– `select`ï¼ˆè¯·å‚è§[è¯­æ³•å’Œç”¨æ³•](#syntax-and-usage)å’Œ[é€šé“é€‰æ‹©](#channel-select)ï¼‰ã€‚

### å…±äº«å¯¹è±¡

æ•°æ®å¯ä»¥é€šè¿‡å…±äº«å˜é‡åœ¨çº¿ç¨‹å’Œè°ƒç”¨çº¿ç¨‹ä¹‹é—´è¿›è¡Œäº¤æ¢ã€‚
è¿™æ ·çš„å˜é‡åº”è¯¥è¢«åˆ›å»ºä¸º `shared`ï¼Œå¹¶ä¸”ä¹Ÿåº”è¯¥ä½œä¸º `shared` ä¼ é€’ç»™çº¿ç¨‹ã€‚
åº•å±‚çš„ `struct` åŒ…å«äº†ä¸€ä¸ªéšè—çš„ *äº’æ–¥é”*ï¼Œå®ƒå…è®¸ä½¿ç”¨ `rlock` è¿›è¡Œåªè¯»è®¿é—®ï¼Œä½¿ç”¨ `lock` è¿›è¡Œè¯»/å†™è®¿é—®ã€‚

```v
struct St {
mut:
	x int // è¦å…±äº«çš„æ•°æ®
}

fn (shared b St) g() {
	lock b {
		// è¯»å–/ä¿®æ”¹/å†™å…¥ b.x
	}
}

fn main() {
	shared a := St{
		x: 10
	}
	spawn a.g()
	// ...
	rlock a {
		// è¯»å– a.x
	}
}
```

å…±äº«å˜é‡å¿…é¡»æ˜¯ç»“æ„ä½“ã€æ•°ç»„æˆ–æ˜ å°„ã€‚

## JSON

ç”±äº JSON çš„æ™®åŠæ€§è´¨è´¨ï¼ŒV å¯¹å…¶æä¾›äº†ç›´æ¥æ”¯æŒã€‚

V ç”Ÿæˆäº†ç”¨äº JSON ç¼–ç å’Œè§£ç çš„ä»£ç ã€‚
å®ƒä¸ä½¿ç”¨è¿è¡Œæ—¶åå°„ï¼Œè¿™ä½¿å¾—æ€§èƒ½æ›´å¥½ã€‚

### è§£æ JSON

```v
import json

struct Foo {
	x int
}

struct User {
	// æ·»åŠ  [required] å±æ€§å°†åœ¨è¾“å…¥ä¸­ç¼ºå°‘è¯¥å­—æ®µæ—¶å¯¼è‡´è§£ç å¤±è´¥ã€‚
	// å¦‚æœå­—æ®µä¸æ˜¯ [required]ï¼Œä½†ç¼ºå°‘äº†ï¼Œé‚£ä¹ˆå®ƒå°†è¢«å‡å®šä¸ºå…·æœ‰é»˜è®¤å€¼ï¼Œå¦‚æ•°å­—ä¸º 0ï¼Œå­—ç¬¦ä¸²ä¸º ''ï¼Œ
	// å¹¶ä¸”è§£ç ä¸ä¼šå¤±è´¥ã€‚
	name string [required]
	age  int
	// ä½¿ç”¨ `skip` å±æ€§æ¥è·³è¿‡æŸäº›å­—æ®µ
	foo Foo [skip]
	// å¦‚æœ JSON ä¸­çš„å­—æ®µåä¸åŒï¼Œå¯ä»¥æŒ‡å®šå®ƒ
	last_name string [json: lastName]
}

data := '{ "name": "Frodo", "lastName": "Baggins", "age": 25 }'
user := json.decode(User, data) or {
	eprintln('è§£ç  JSON å¤±è´¥ï¼Œé”™è¯¯ï¼š${err}')
	return
}
println(user.name)
println(user.last_name)
println(user.age)
// ä¹Ÿå¯ä»¥è§£ç  JSON æ•°ç»„ï¼š
sfoos := '[{"x":123},{"x":456}]'
foos := json.decode([]Foo, sfoos)!
println(foos[0].x)
println(foos[1].x)
```

`json.decode` å‡½æ•°æ¥å—ä¸¤ä¸ªå‚æ•°ï¼š
ç¬¬ä¸€ä¸ªæ˜¯è¦è§£ç ä¸ºçš„ JSON å€¼çš„ç±»å‹ï¼Œç¬¬äºŒä¸ªæ˜¯åŒ…å« JSON æ•°æ®çš„å­—ç¬¦ä¸²ã€‚

### ç¼–ç  JSON

```v
import json

struct User {
	name  string
	score i64
}

mut data := map[string]int{}
user := &User{
	name: 'Pierre'
	score: 1024
}

data['x'] = 42
data['y'] = 360

println(json.encode(data)) // {"x":42,"y":360}
println(json.encode(user)) // {"name":"Pierre","score":1024}
```

json æ¨¡å—è¿˜æ”¯æŒåŒ¿åç»“æ„å­—æ®µï¼Œè¿™å¯¹äºå…·æœ‰è®¸å¤šå±‚çº§çš„å¤æ‚ JSON API å¾ˆæœ‰å¸®åŠ©ã€‚

## æµ‹è¯•

### æ–­è¨€

```v
fn foo(mut v []int) {
	v[0] = 1
}

mut v := [20]
foo(mut v)
assert v[0] < 4
```

`assert` è¯­å¥ç”¨äºæ£€æŸ¥å…¶è¡¨è¾¾å¼æ˜¯å¦è¯„ä¼°ä¸º `true`ã€‚å¦‚æœæ–­è¨€å¤±è´¥ï¼Œç¨‹åºé€šå¸¸ä¼šä¸­æ­¢ã€‚æ–­è¨€åº”è¯¥åªç”¨äºæ£€æµ‹ç¼–ç¨‹é”™è¯¯ã€‚å½“æ–­è¨€å¤±è´¥æ—¶ï¼Œä¼šå°†å…¶æŠ¥å‘Šç»™ *stderr*ï¼Œå¹¶åœ¨å¯èƒ½æ—¶æ‰“å°æ¯”è¾ƒè¿ç®—ç¬¦ï¼ˆå¦‚ `<`ã€`==`ï¼‰ä¸¤ä¾§çš„å€¼ã€‚è¿™å¯¹äºå¿«é€Ÿæ‰¾åˆ°æ„å¤–çš„å€¼éå¸¸æœ‰ç”¨ã€‚æ–­è¨€è¯­å¥å¯ä»¥ç”¨åœ¨ä»»ä½•å‡½æ•°ä¸­ï¼Œè€Œä¸ä»…ä»…æ˜¯æµ‹è¯•å‡½æ•°ï¼Œè¿™åœ¨å¼€å‘æ–°åŠŸèƒ½æ—¶éå¸¸æ–¹ä¾¿ï¼Œå¯ä»¥ä¿æŒä½ çš„ä¸å˜æ€§ã€‚

> **æ³¨æ„**
> å½“ä½¿ç”¨ `-prod` æ ‡å¿—ç¼–è¯‘ç¨‹åºæ—¶ï¼Œæ‰€æœ‰ `assert` è¯­å¥éƒ½ä¼šè¢« *ç§»é™¤*ã€‚

### å¸¦é¢å¤–æ¶ˆæ¯çš„æ–­è¨€

è¿™ç§å½¢å¼çš„ `assert` è¯­å¥åœ¨å¤±è´¥æ—¶ä¼šæ‰“å°é¢å¤–çš„æ¶ˆæ¯ã€‚è¯·æ³¨æ„ï¼Œä½ å¯ä»¥åœ¨é‚£é‡Œä½¿ç”¨ä»»ä½•å­—ç¬¦ä¸²è¡¨è¾¾å¼ - å­—ç¬¦ä¸²å­—é¢å€¼ã€è¿”å›å­—ç¬¦ä¸²çš„å‡½æ•°ã€æ’å€¼å˜é‡çš„å­—ç¬¦ä¸²ç­‰ã€‚

```v
fn test_assertion_with_extra_message_failure() {
	for i in 0 .. 100 {
		assert i * 2 - 45 < 75 + 10, 'æ–­è¨€å¤±è´¥ï¼Œi çš„å€¼ä¸ºï¼š${i}'
	}
}
```

### ä¸ä¸­æ­¢ç¨‹åºçš„æ–­è¨€

å½“æœ€åˆåŸå‹åŒ–åŠŸèƒ½å’Œæµ‹è¯•æ—¶ï¼Œæœ‰æ—¶å€™å¸Œæœ›æ–­è¨€ä¸ä¼šåœæ­¢ç¨‹åºï¼Œè€Œåªæ˜¯æ‰“å°å¤±è´¥æ¶ˆæ¯ã€‚å¯ä»¥é€šè¿‡ç»™åŒ…å«æ–­è¨€çš„å‡½æ•°æ·»åŠ  `[assert_continues]` æ ‡ç­¾æ¥å®ç°ï¼Œä¾‹å¦‚è¿è¡Œä»¥ä¸‹ç¨‹åºï¼š

```v
[assert_continues]
fn abc(ii int) {
	assert ii == 2
}

for i in 0 .. 4 {
	abc(i)
}
```

... å°†äº§ç”Ÿä»¥ä¸‹è¾“å‡ºï¼š

```
assert_continues_example.v:3: FAIL: fn main.abc: æ–­è¨€å¤±è´¥ï¼Œii çš„å€¼ä¸º 0
   å·¦ä¾§å€¼: ii = 0
   å³ä¾§å€¼: 2
assert_continues_example.v:3: FAIL: fn main.abc: æ–­è¨€å¤±è´¥ï¼Œii çš„å€¼ä¸º 1
  å·¦ä¾§å€¼: ii = 1
  å³ä¾§å€¼: 2
assert_continues_example.v:3: FAIL: fn main.abc: æ–­è¨€å¤±è´¥ï¼Œii çš„å€¼ä¸º 3
  å·¦ä¾§å€¼: ii = 3
  å³ä¾§å€¼: 2
```

> **æ³¨æ„**
> V ä¹Ÿæ”¯æŒä¸€ä¸ªå‘½ä»¤è¡Œæ ‡å¿— `-assert continues`ï¼Œå®ƒå°†å…¨å±€æ”¹å˜æ‰€æœ‰æ–­è¨€çš„è¡Œä¸ºï¼Œå°±å¥½åƒä½ ç»™æ¯ä¸ªå‡½æ•°éƒ½æ‰“ä¸Šäº† `[assert_continues]` æ ‡ç­¾ã€‚

### æµ‹è¯•æ–‡ä»¶

```v
// hello.v
module main

fn hello() string {
	return 'Hello world'
}

fn main() {
	println(hello())
}
```

```v failcompile
// hello_test.v
module main

fn test_hello() {
	assert hello() == 'Hello world'
}
```

è¦è¿è¡Œä¸Šé¢çš„æµ‹è¯•æ–‡ä»¶ï¼Œè¯·ä½¿ç”¨ `v hello_test.v`ã€‚è¿™å°†æ£€æŸ¥å‡½æ•° `hello` æ˜¯å¦äº§ç”Ÿäº†æ­£ç¡®çš„è¾“å‡ºã€‚V å°†æ‰§è¡Œæ–‡ä»¶ä¸­çš„æ‰€æœ‰æµ‹è¯•å‡½æ•°ã€‚

> **æ³¨æ„**
> æ‰€æœ‰ `_test.v` æ–‡ä»¶ï¼ˆå†…éƒ¨å’Œå¤–éƒ¨éƒ½æ˜¯å¦‚æ­¤ï¼‰éƒ½å°†ç¼–è¯‘ä¸º*ç‹¬ç«‹çš„ç¨‹åº*ã€‚æ¢å¥è¯è¯´ï¼Œä½ å¯ä»¥æ‹¥æœ‰å°½å¯èƒ½å¤šçš„ `_test.v` æ–‡ä»¶å’Œå…¶ä¸­çš„æµ‹è¯•ï¼Œå®ƒä»¬ä¸ä¼šå¯¹æ­£å¸¸çš„ `.v` æ–‡ä»¶çš„ç¼–è¯‘äº§ç”Ÿä»»ä½•å½±å“ï¼Œåªæœ‰å½“ä½ æ˜ç¡®åœ°è¿è¡Œ `v file_test.v` æˆ– `v test .` æ—¶æ‰ä¼šè¿è¡Œã€‚

* æ‰€æœ‰æµ‹è¯•å‡½æ•°å¿…é¡»ä½äºæ–‡ä»¶åä»¥ `_test.v` ç»“å°¾çš„æµ‹è¯•æ–‡ä»¶ä¸­ã€‚
* æµ‹è¯•å‡½æ•°çš„åç§°å¿…é¡»ä»¥ `test_` å¼€å¤´ä»¥æ ‡è®°å®ƒä»¬ä»¥ä¾›æ‰§è¡Œã€‚
* æ­£å¸¸çš„å‡½æ•°ä¹Ÿå¯ä»¥åœ¨æµ‹è¯•æ–‡ä»¶ä¸­å®šä¹‰ï¼Œå¹¶ä¸”åº”è¯¥æ‰‹åŠ¨è°ƒç”¨ã€‚å…¶ä»–ç¬¦å·ä¹Ÿå¯ä»¥åœ¨æµ‹è¯•æ–‡ä»¶ä¸­å®šä¹‰ï¼Œå¦‚ç±»å‹ã€‚
* æœ‰ä¸¤ç§ç±»å‹çš„æµ‹è¯•ï¼šå†…éƒ¨å’Œå¤–éƒ¨ã€‚
* å†…éƒ¨æµ‹è¯•å¿…é¡»åƒæ¥è‡ªåŒä¸€æ¨¡å—çš„æ‰€æœ‰å…¶ä»– .v æ–‡ä»¶ä¸€æ ·*å£°æ˜*å®ƒä»¬çš„æ¨¡å—ã€‚å†…éƒ¨æµ‹è¯•ç”šè‡³å¯ä»¥è°ƒç”¨åŒä¸€æ¨¡å—ä¸­çš„ç§æœ‰å‡½æ•°ã€‚
* å¤–éƒ¨æµ‹è¯•å¿…é¡»*å¯¼å…¥*å®ƒä»¬è¦æµ‹è¯•çš„æ¨¡å—ã€‚å®ƒä»¬æ— æ³•è®¿é—®æ¨¡å—çš„ç§æœ‰å‡½æ•°/ç±»å‹ã€‚å®ƒä»¬åªèƒ½æµ‹è¯•æ¨¡å—æä¾›çš„å¤–éƒ¨/å…¬å…± APIã€‚

åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œ`test_hello` æ˜¯ä¸€ä¸ªå†…éƒ¨æµ‹è¯•ï¼Œå¯ä»¥è°ƒç”¨ç§æœ‰å‡½æ•° `hello()`ï¼Œå› ä¸º `hello_test.v` å…·æœ‰ `module main`ï¼Œå°±åƒ `hello.v` ä¸€æ ·ï¼Œå³å®ƒä»¬éƒ½æ˜¯åŒä¸€ä¸ªæ¨¡å—çš„ä¸€éƒ¨åˆ†ã€‚è¿˜è¦æ³¨æ„ï¼Œç”±äº `module main` å°±åƒå…¶ä»–æ‰€æœ‰æ¨¡å—ä¸€æ ·ï¼Œå†…éƒ¨æµ‹è¯•ä¹Ÿå¯ä»¥ç”¨äºæµ‹è¯•ä¸»ç¨‹åº .v æ–‡ä»¶ä¸­çš„ç§æœ‰å‡½æ•°ã€‚

ä½ è¿˜å¯ä»¥åœ¨æµ‹è¯•æ–‡ä»¶ä¸­å®šä¹‰ä»¥ä¸‹ç‰¹æ®Šçš„æµ‹è¯•å‡½æ•°ï¼š

* `testsuite_begin`ï¼Œå®ƒå°†åœ¨æ‰€æœ‰å…¶ä»–æµ‹è¯•å‡½æ•°*ä¹‹å‰*è¿è¡Œã€‚
* `testsuite_end`ï¼Œå®ƒå°†åœ¨æ‰€æœ‰å…¶ä»–æµ‹è¯•å‡½æ•°*ä¹‹å*è¿è¡Œã€‚

å¦‚æœæµ‹è¯•å‡½æ•°å…·æœ‰é”™è¯¯è¿”å›ç±»å‹ï¼Œåˆ™ä¼ æ’­çš„ä»»ä½•é”™è¯¯å°†ä½¿æµ‹è¯•å¤±è´¥ï¼š

```v
import strconv

fn test_atoi() ! {
	assert strconv.atoi('1')! == 1
	assert strconv.atoi('one')! == 1 // æµ‹è¯•å°†å¤±è´¥
}
```

### è¿è¡Œæµ‹è¯•

è¦è¿è¡Œå•ä¸ªæµ‹è¯•æ–‡ä»¶ä¸­çš„æµ‹è¯•å‡½æ•°ï¼Œè¯·ä½¿ç”¨ `v foo_test.v`ã€‚

è¦æµ‹è¯•æ•´ä¸ªæ¨¡å—ï¼Œè¯·ä½¿ç”¨ `v test mymodule`ã€‚ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ `v test .` æ¥æµ‹è¯•å½“å‰æ–‡ä»¶å¤¹ï¼ˆåŠå…¶å­æ–‡ä»¶å¤¹ï¼‰ä¸­çš„æ‰€æœ‰å†…å®¹ã€‚ä½ å¯ä»¥ä¼ é€’ `-stats` é€‰é¡¹ä»¥æŸ¥çœ‹æœ‰å…³å•ä¸ªæµ‹è¯•è¿è¡Œçš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚

ä½ å¯ä»¥å°†å…¶ä»–æµ‹è¯•æ•°æ®æ”¾åœ¨ä¸€ä¸ªåä¸º `testdata` çš„æ–‡ä»¶å¤¹ä¸­ï¼Œè¯¥æ–‡ä»¶å¤¹ä¸ä½ çš„ `_test.v` æ–‡ä»¶ç´§é‚»ã€‚V çš„æµ‹è¯•æ¡†æ¶å°†*å¿½ç•¥*è¿™æ ·çš„æ–‡ä»¶å¤¹ï¼ŒåŒæ—¶åœ¨å¯»æ‰¾è¦è¿è¡Œçš„æµ‹è¯•æ—¶è¿›è¡Œæ‰«æã€‚è¿™å¾ˆæœ‰ç”¨ï¼Œå¦‚æœä½ æƒ³å°†å…·æœ‰æ— æ•ˆ V æºä»£ç æˆ–å…¶ä»–æµ‹è¯•çš„ .v æ–‡ä»¶æ”¾åœ¨ä¸€èµ·ï¼ŒåŒ…æ‹¬å·²çŸ¥çš„å¤±è´¥æµ‹è¯•ï¼Œè¿™äº›æµ‹è¯•åº”è¯¥ç”±çˆ¶çº§ `_test.v` æ–‡ä»¶ä»¥ç‰¹å®šçš„æ–¹å¼/é€‰é¡¹è¿è¡Œã€‚

> **æ³¨æ„**
> V ç¼–è¯‘å™¨çš„è·¯å¾„å¯é€šè¿‡ @VEXE è·å–ï¼Œå› æ­¤ `_test.v` æ–‡ä»¶å¯ä»¥åƒè¿™æ ·è½»æ¾åœ°è¿è¡Œ*å…¶ä»–*æµ‹è¯•æ–‡ä»¶ï¼š

```v oksyntax
import os

fn test_subtest() {
	res := os.execute('${os.quoted_path(@VEXE)} other_test.v')
	assert res.exit_code == 1
	assert res.output.contains('other_test.v does not exist')
}
```

## å†…å­˜ç®¡ç†

Vé€šè¿‡ä½¿ç”¨å€¼ç±»å‹ã€å­—ç¬¦ä¸²ç¼“å†²åŒºä»¥åŠæ¨å´‡ç®€å•ã€ä¸å«æŠ½è±¡çš„ä»£ç é£æ ¼æ¥é¿å…ä¸å¿…è¦çš„åˆ†é…ã€‚

åœ¨Vä¸­ï¼Œæœ‰å››ç§å†…å­˜ç®¡ç†æ–¹å¼ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼ŒVä½¿ç”¨ä¸€ä¸ªç²¾ç®€ä¸”æ€§èƒ½è‰¯å¥½çš„è¿½è¸ªåƒåœ¾æ”¶é›†å™¨ï¼ˆGCï¼‰ã€‚

ç¬¬äºŒç§æ–¹å¼æ˜¯è‡ªåŠ¨é‡Šæ”¾ï¼ˆautofreeï¼‰ï¼Œå¯ä»¥é€šè¿‡ `-autofree` å¼€å¯ã€‚å®ƒè´Ÿè´£å¤§éƒ¨åˆ†å¯¹è±¡ï¼ˆçº¦90-100%ï¼‰ï¼šç¼–è¯‘æœŸé—´ä¼šè‡ªåŠ¨æ’å…¥å¿…è¦çš„é‡Šæ”¾è°ƒç”¨ã€‚å‰©ä½™çš„å°éƒ¨åˆ†å¯¹è±¡é€šè¿‡GCé‡Šæ”¾ã€‚å¼€å‘è€…ä¸éœ€è¦åœ¨ä»£ç ä¸­åšä»»ä½•æ›´æ”¹ã€‚â€œå®ƒåªç®¡ç”¨â€ï¼Œå°±åƒPythonã€Goæˆ–Javaä¸€æ ·ï¼Œåªæ˜¯è¿™é‡Œæ²¡æœ‰ç¹é‡çš„åƒåœ¾å›æ”¶è¿½è¸ªä¸€åˆ‡æˆ–æ˜‚è´µçš„å¼•ç”¨è®¡æ•°ã€‚

å¯¹äºæ„¿æ„æ‹¥æœ‰æ›´ä½å±‚æ¬¡æ§åˆ¶çš„å¼€å‘è€…ï¼Œå¯ä»¥é€‰æ‹©ä½¿ç”¨ `-gc none` è¿›è¡Œæ‰‹åŠ¨å†…å­˜ç®¡ç†ã€‚

Arenaåˆ†é…å¯ä»¥é€šè¿‡ `v -prealloc` å®ç°ã€‚

### æ§åˆ¶

ä½ å¯ä»¥åˆ©ç”¨Vçš„è‡ªåŠ¨é‡Šæ”¾å¼•æ“ï¼Œåœ¨è‡ªå®šä¹‰æ•°æ®ç±»å‹ä¸Šå®šä¹‰ä¸€ä¸ª `free()` æ–¹æ³•ï¼š

```v
struct MyType {}

[unsafe]
fn (data &MyType) free() {
	// ...
}
```

å°±åƒç¼–è¯‘å™¨ä¸ºCæ•°æ®ç±»å‹é‡Šæ”¾å†…å­˜ä¸€æ ·ï¼Œå®ƒä¼šåœ¨æ¯ä¸ªå˜é‡çš„ç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶é™æ€åœ°æ’å…¥ `free()` è°ƒç”¨ã€‚

å¯ä»¥é€šè¿‡ä½¿ç”¨ `-autofree` æ ‡å¿—æ¥å¯ç”¨è‡ªåŠ¨é‡Šæ”¾ã€‚

å¯¹äºæ„¿æ„æ‹¥æœ‰æ›´ä½å±‚æ¬¡æ§åˆ¶çš„å¼€å‘è€…ï¼Œå¯ä»¥ä½¿ç”¨ `-manualfree` æ¥ç¦ç”¨è‡ªåŠ¨é‡Šæ”¾ï¼Œæˆ–è€…åœ¨æƒ³è¦æ‰‹åŠ¨ç®¡ç†å†…å­˜çš„æ¯ä¸ªå‡½æ•°ä¸Šæ·»åŠ  `[manualfree]` æ ‡ç­¾ï¼ˆå‚è§ [attributes](#attributes)ï¼‰ã€‚

> **æ³¨æ„**
> ç›®å‰ï¼ŒAutofreeä»ç„¶å¤„äºå¼€å‘ä¸­ã€‚åœ¨å®ƒç¨³å®šä¸‹æ¥å¹¶æˆä¸ºé»˜è®¤è®¾ç½®ä¹‹å‰ï¼Œè¯·é¿å…ä½¿ç”¨å®ƒã€‚ç›®å‰ï¼Œåˆ†é…ç”±ä¸€ä¸ªç²¾ç®€è€Œæ€§èƒ½è‰¯å¥½çš„GCå¤„ç†ï¼Œç›´åˆ°Vçš„è‡ªåŠ¨é‡Šæ”¾å¼•æ“å‡†å¤‡æŠ•å…¥ç”Ÿäº§ä½¿ç”¨ã€‚

**ç¤ºä¾‹**

```v
import strings

fn draw_text(s string, x int, y int) {
	// ...
}

fn draw_scene() {
	// ...
	name1 := 'abc'
	name2 := 'def ghi'
	draw_text('hello ${name1}', 10, 10)
	draw_text('hello ${name2}', 100, 10)
	draw_text(strings.repeat(`X`, 10000), 10, 50)
	// ...
}
```

è¿™é‡Œçš„å­—ç¬¦ä¸²æ²¡æœ‰åœ¨ `draw_text` ä¸­é€ƒé€¸ï¼Œå› æ­¤å®ƒä»¬åœ¨å‡½æ•°é€€å‡ºæ—¶è¢«æ¸…ç†ã€‚

å®é™…ä¸Šï¼Œä½¿ç”¨ `-prealloc` æ ‡å¿—ï¼Œå‰ä¸¤ä¸ªè°ƒç”¨æ ¹æœ¬ä¸ä¼šå¯¼è‡´ä»»ä½•åˆ†é…ã€‚è¿™ä¸¤ä¸ªå­—ç¬¦ä¸²å¾ˆå°ï¼Œæ‰€ä»¥Vå°†ä¸ºå®ƒä»¬ä½¿ç”¨ä¸€ä¸ªé¢„åˆ†é…çš„ç¼“å†²åŒºã€‚

```v
struct User {
	name string
}

fn test() []int {
	number := 7 // æ ˆå˜é‡
	user := User{} // åˆ†é…åœ¨æ ˆä¸Šçš„ç»“æ„ä½“
	numbers := [1, 2, 3] // åˆ†é…åœ¨å †ä¸Šçš„æ•°ç»„ï¼Œåœ¨å‡½æ•°é€€å‡ºæ—¶ä¼šè¢«é‡Šæ”¾
	println(number)
	println(user)
	println(numbers)
	numbers2 := [4, 5, 6] // è¢«è¿”å›çš„æ•°ç»„ï¼Œåœ¨è¿™é‡Œä¸ä¼šè¢«é‡Šæ”¾
	return numbers2
}
```

### æ ˆå’Œå †

#### æ ˆå’Œå †åŸºç¡€çŸ¥è¯†

ä¸å¤§å¤šæ•°å…¶ä»–ç¼–ç¨‹è¯­è¨€ä¸€æ ·ï¼Œæ•°æ®å¯ä»¥å­˜å‚¨åœ¨ä¸¤ä¸ªä½ç½®ï¼š

* æ ˆå…è®¸å¿«é€Ÿåˆ†é…ï¼Œå‡ ä¹æ²¡æœ‰ç®¡ç†å¼€é”€ã€‚æ ˆéšç€å‡½æ•°è°ƒç”¨æ·±åº¦çš„å¢åŠ å’Œå‡å°‘è€Œå¢é•¿å’Œç¼©å° - å› æ­¤æ¯ä¸ªè°ƒç”¨çš„å‡½æ•°éƒ½æœ‰å…¶ä¿æŒæœ‰æ•ˆçš„æ ˆæ®µï¼Œç›´åˆ°å‡½æ•°è¿”å›ã€‚ä¸éœ€è¦é‡Šæ”¾ï¼Œä½†è¿™ä¹Ÿæ„å‘³ç€å¯¹æ ˆå¯¹è±¡çš„å¼•ç”¨åœ¨å‡½æ•°è¿”å›æ—¶å°†å˜ä¸ºæ— æ•ˆã€‚æ­¤å¤–ï¼Œæ ˆç©ºé—´å—é™ï¼ˆé€šå¸¸æ¯ä¸ªçº¿ç¨‹åªæœ‰å‡ å…†å­—èŠ‚ï¼‰ã€‚
* å †æ˜¯ä¸€ä¸ªç”±æ“ä½œç³»ç»Ÿç®¡ç†çš„å¤§å†…å­˜åŒºåŸŸï¼ˆé€šå¸¸å‡ åäº¿å­—èŠ‚ï¼‰ã€‚å †å¯¹è±¡æ˜¯ç”±ç‰¹æ®Šçš„å‡½æ•°è°ƒç”¨åˆ†é…å’Œé‡Šæ”¾çš„ï¼Œè¿™äº›å‡½æ•°å°†ç®¡ç†ä»»åŠ¡å§”æ‰˜ç»™æ“ä½œç³»ç»Ÿã€‚è¿™æ„å‘³ç€å®ƒä»¬å¯ä»¥åœ¨å‡ ä¸ªå‡½æ•°è°ƒç”¨ä¹‹é—´ä¿æŒæœ‰æ•ˆï¼Œä½†ç®¡ç†æ˜¯æ˜‚è´µçš„ã€‚

#### Vçš„é»˜è®¤æ–¹æ³•

å‡ºäºæ€§èƒ½è€ƒè™‘ï¼ŒVä¼šå°½å¯èƒ½å°†å¯¹è±¡æ”¾åœ¨æ ˆä¸Šï¼Œä½†åœ¨æ˜æ˜¾éœ€è¦æ—¶ä¼šå°†å®ƒä»¬åˆ†é…åœ¨å †ä¸Šã€‚ä¾‹å¦‚ï¼š

```v
struct MyStruct {
	n int
}

struct RefStruct {
	r &MyStruct
}

fn main() {
	q, w := f()
	println('q: ${q.r.n}, w: ${w.n}')
}

fn f() (RefStruct, &MyStruct) {
	a := MyStruct{
		n: 1
	}
	b := MyStruct{
		n: 2
	}
	c := MyStruct{
		n: 3
	}
	e := RefStruct{
		r: &b
	}
	x := a.n + c.n
	println('x: ${x}')
	return e, &c
}
```

åœ¨è¿™é‡Œï¼Œ`a` å­˜å‚¨åœ¨æ ˆä¸Šï¼Œå› ä¸ºå®ƒçš„åœ°å€æ°¸è¿œä¸ä¼šç¦»å¼€å‡½æ•° `f()`ã€‚ç„¶è€Œï¼Œå¯¹ `b` çš„å¼•ç”¨æ˜¯ä½œä¸ºè¿”å›å€¼çš„ä¸€éƒ¨åˆ†åŒ…å«åœ¨ `e` ä¸­çš„ã€‚åŒæ—¶å¯¹ `c` çš„å¼•ç”¨ä¹Ÿæ˜¯è¿”å›çš„ä¸€éƒ¨åˆ†ã€‚å› æ­¤ `b` å’Œ `c` å°†è¢«åˆ†é…åœ¨å †ä¸Šã€‚

å½“å°†å¯¹è±¡çš„å¼•ç”¨ä½œä¸ºå‡½æ•°å‚æ•°ä¼ é€’æ—¶ï¼Œæƒ…å†µå˜å¾—ä¸é‚£ä¹ˆæ˜æ˜¾ï¼š

```v
struct MyStruct {
mut:
	n int
}

fn main() {
	mut q := MyStruct{
		n: 7
	}
	w := MyStruct{
		n: 13
	}
	x := q.f(&w) // ä¼ é€’äº† `q` å’Œ `w` çš„å¼•ç”¨
	println('q: ${q}\nx: ${x}')
}

fn (mut a

 MyStruct) f(b &MyStruct) int {
	a.n += b.n
	x := a.n * b.n
	return x
}
```

åœ¨è¿™é‡Œï¼Œè°ƒç”¨ `q.f(&w)` ä¼ é€’äº†å¯¹ `q` å’Œ `w` çš„å¼•ç”¨ï¼Œå› ä¸º `a` æ˜¯ `mut` è€Œ `f()` çš„å£°æ˜ä¸­ `b` çš„ç±»å‹æ˜¯ `&MyStruct`ï¼Œæ‰€ä»¥ä»æŠ€æœ¯ä¸Šè®²ï¼Œè¿™äº›å¼•ç”¨æ˜¯ç¦»å¼€ `main()` çš„ã€‚ç„¶è€Œï¼Œè¿™äº›å¼•ç”¨çš„ *ç”Ÿå‘½å‘¨æœŸ* ä½äº `main()` çš„ä½œç”¨åŸŸå†…ï¼Œæ‰€ä»¥ `q` å’Œ `w` æ˜¯åœ¨æ ˆä¸Šåˆ†é…çš„ã€‚

#### æ ˆå’Œå †çš„æ‰‹åŠ¨æ§åˆ¶

åœ¨æœ€åä¸€ä¸ªç¤ºä¾‹ä¸­ï¼ŒVç¼–è¯‘å™¨å¯ä»¥å°† `q` å’Œ `w` æ”¾åœ¨æ ˆä¸Šï¼Œå› ä¸ºå®ƒå‡è®¾åœ¨è°ƒç”¨ `q.f(&w)` ä¸­ï¼Œè¿™äº›å¼•ç”¨ä»…è¢«ç”¨äºè¯»å–å’Œä¿®æ”¹å¼•ç”¨çš„å€¼ - è€Œä¸æ˜¯ä¼ é€’å¼•ç”¨æœ¬èº«ã€‚ä»æŸç§ç¨‹åº¦ä¸Šæ¥è¯´ï¼Œ`q` å’Œ `w` å¯¹ `f()` åªæ˜¯ *å€Ÿç”¨* äº†è¿™äº›å¼•ç”¨ã€‚

å¦‚æœ `f()` è‡ªå·±å¤„ç†å¼•ç”¨ï¼Œæƒ…å†µä¼šæœ‰æ‰€ä¸åŒï¼š

```v
struct RefStruct {
mut:
	r &MyStruct
}

// å‚è§ä¸‹é¢çš„è®¨è®º
[heap]
struct MyStruct {
	n int
}

fn main() {
	m := MyStruct{}
	mut r := RefStruct{
		r: &m
	}
	r.g()
	println('r: ${r}')
}

fn (mut r RefStruct) g() {
	s := MyStruct{
		n: 7
	}
	r.f(&s) // å¼•ç”¨ `s` åœ¨ `r` ä¸­è¢«ä¼ é€’å› `main()`
}

fn (mut r RefStruct) f(s &MyStruct) {
	r.r = s // åœ¨æ²¡æœ‰ `[heap]` çš„æƒ…å†µä¸‹ä¼šè§¦å‘é”™è¯¯
}
```

åœ¨è¿™é‡Œï¼Œ`f()` çœ‹èµ·æ¥å¾ˆæ— å®³ï¼Œä½†å®ƒå´åœ¨åšæ¶å¿ƒçš„äº‹æƒ… - å®ƒå°†å¯¹ `s` çš„å¼•ç”¨æ’å…¥åˆ° `r` ä¸­ã€‚è¿™æ ·åšçš„é—®é¢˜åœ¨äº `s` çš„ç”Ÿå­˜æœŸä»…åœ¨ `g()` æ‰§è¡ŒæœŸé—´ï¼Œä½† `r` åœ¨ `g()` åé¢çš„ `main()` ä¸­ä½¿ç”¨ã€‚å› æ­¤ç¼–è¯‘å™¨ä¼šå¯¹ `f()` ä¸­çš„èµ‹å€¼å‘å‡ºè­¦å‘Šï¼Œå› ä¸º `s` *â€œå¯èƒ½æŒ‡çš„æ˜¯å­˜å‚¨åœ¨æ ˆä¸Šçš„å¯¹è±¡â€*ã€‚åœ¨ `g()` ä¸­æ‰€åšçš„å‡è®¾æ˜¯é”™è¯¯çš„ã€‚

è§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•æ˜¯åœ¨ `struct MyStruct` çš„å£°æ˜ä¸­ä½¿ç”¨ `[heap]` [attribute](#attributes)ã€‚å®ƒæŒ‡ç¤ºç¼–è¯‘å™¨ *å§‹ç»ˆ* åœ¨å †ä¸Šåˆ†é… `MyStruct` å¯¹è±¡ã€‚è¿™æ ·ï¼Œå¯¹ `s` çš„å¼•ç”¨åœ¨ `g()` è¿”å›åä»ç„¶æœ‰æ•ˆã€‚ç¼–è¯‘å™¨åœ¨æ£€æŸ¥ `f()` æ—¶ä¼šè€ƒè™‘åˆ° `MyStruct` å¯¹è±¡å§‹ç»ˆåœ¨å †ä¸Šåˆ†é…ï¼Œå› æ­¤å…è®¸å°†å¼•ç”¨èµ‹ç»™ `r.r` å­—æ®µã€‚

åœ¨å…¶ä»–ç¼–ç¨‹è¯­è¨€ä¸­ç»å¸¸çœ‹åˆ°çš„ä¸€ç§æ¨¡å¼æ˜¯ï¼š

```v failcompile
fn (mut a MyStruct) f() &MyStruct {
	// å¯¹ `a` åšä¸€äº›äº‹æƒ…
	return &a // å°†è¿”å›å€Ÿç”¨å¯¹è±¡çš„åœ°å€
}
```

åœ¨è¿™é‡Œï¼Œ`f()` ä½œä¸ºæ¥æ”¶è€…ä¼ é€’äº†å¯¹ `a` çš„å¼•ç”¨ï¼Œè¯¥å¼•ç”¨åœ¨è°ƒç”¨è€…å¤„è¿”å›å¹¶åŒæ—¶ä½œä¸ºç»“æœè¿”å›ã€‚è¿™æ ·å£°æ˜çš„æ„å›¾æ˜¯æ–¹æ³•é“¾å¼è°ƒç”¨ï¼Œå¦‚ `y = x.f().g()`ã€‚ç„¶è€Œï¼Œä½¿ç”¨è¿™ç§æ–¹æ³•çš„é—®é¢˜åœ¨äºä¼šåˆ›å»ºå¯¹ `a` çš„ç¬¬äºŒä¸ªå¼•ç”¨ - å› æ­¤ä¸ä»…æ˜¯å€Ÿç”¨çš„ï¼Œè€Œä¸”å¿…é¡»å°† `MyStruct` å£°æ˜ä¸º `[heap]`ã€‚

åœ¨Vä¸­ï¼Œæ›´å¥½çš„åšæ³•æ˜¯ï¼š

```v
struct MyStruct {
mut:
	n int
}

fn (mut a MyStruct) f() {
	// å¯¹ `a` åšä¸€äº›äº‹æƒ…
}

fn (mut a MyStruct) g() {
	// å¯¹ `a` åšä¸€äº›å…¶ä»–äº‹æƒ…
}

fn main() {
	x := MyStruct{} // åˆ†é…åœ¨æ ˆä¸Š
	mut y := x
	y.f()
	y.g()
	// è€Œä¸æ˜¯ `mut y := x.f().g()
}
```

è¿™æ ·å°±å¯ä»¥é¿å…ä½¿ç”¨ `[heap]` å±æ€§ï¼Œä»è€Œæå‡æ€§èƒ½ã€‚

ç„¶è€Œï¼Œæ ˆç©ºé—´éå¸¸æœ‰é™ï¼Œæ­£å¦‚ä¸Šé¢æåˆ°çš„ã€‚å› æ­¤ï¼Œå³ä½¿å¯¹äºåƒä¸Šé¢æåˆ°çš„ç”¨ä¾‹ä¸€æ ·ï¼Œä¹Ÿå¯èƒ½é€‚åˆå¯¹éå¸¸å¤§çš„ç»“æ„ä½¿ç”¨ `[heap]` å±æ€§ã€‚

è¿˜æœ‰ä¸€ç§åœ¨ç‰¹å®šæƒ…å†µä¸‹æ‰‹åŠ¨æ§åˆ¶åˆ†é…çš„æ›¿ä»£æ–¹æ³•ã€‚å°½ç®¡ä¸å»ºè®®ä½¿ç”¨è¿™ç§æ–¹æ³•ï¼Œä½†å‡ºäºå®Œæ•´æ€§çš„è€ƒè™‘

ï¼Œè¿™é‡Œæ˜¾ç¤ºå‡ºæ¥ï¼š

```v
struct MyStruct {
	n int
}

struct RefStruct {
mut:
	r &MyStruct
}

// ç®€å•çš„å‡½æ•° - åªæ˜¯ç”¨æ¥è¦†ç›–å…ˆå‰ç”± `g()` ä½¿ç”¨çš„æ ˆæ®µ

fn use_stack() {
	x := 7.5
	y := 3.25
	z := x + y
	println('${x} ${y} ${z}')
}

fn main() {
	m := MyStruct{}
	mut r := RefStruct{
		r: &m
	}
	r.g()
	use_stack() // ä»¥æ“¦é™¤æ— æ•ˆçš„æ ˆå†…å®¹
	println('r: ${r}')
}

fn (mut r RefStruct) g() {
	s := &MyStruct{ // `s` æ˜ç¡®å¼•ç”¨å †å¯¹è±¡
		n: 7
	}
	// å°†ä¸Šé¢çš„ `&MyStruct` æ”¹æˆ `MyStruct` å¹¶å°†ä¸‹é¢çš„ `r.f(s)` æ”¹æˆ `r.f(&s)`
	// å¯ä»¥çœ‹åˆ°æ ˆæ®µä¸­çš„æ•°æ®è¢«è¦†å†™
	r.f(s)
}

fn (mut r RefStruct) f(s &MyStruct) {
	r.r = unsafe { s } // è¦†ç›–ç¼–è¯‘å™¨çš„æ£€æŸ¥
}
```

åœ¨è¿™é‡Œï¼Œä½¿ç”¨ `unsafe` å—æŠ‘åˆ¶äº†ç¼–è¯‘å™¨æ£€æŸ¥ã€‚å³ä½¿ç¼–è¯‘å™¨å¯èƒ½ä¸éœ€è¦è¿™ä¸€æ­¥ï¼Œä½†å¦‚æœä¸è¿™æ ·åšï¼Œ`r` ä¸­çš„å¼•ç”¨å°†å˜å¾—æ— æ•ˆï¼ˆæŒ‡å‘çš„å†…å­˜åŒºåŸŸå°†è¢« `use_stack()` è¦†å†™ï¼‰ï¼Œç¨‹åºå¯èƒ½ä¼šå´©æºƒï¼ˆæˆ–è€…è‡³å°‘äº§ç”Ÿä¸€ä¸ªä¸å¯é¢„æµ‹çš„æœ€ç»ˆè¾“å‡ºï¼‰ã€‚è¿™å°±æ˜¯è¿™ç§æ–¹æ³•è¢«ç§°ä¸º *ä¸å®‰å…¨* çš„åŸå› ï¼Œåº”è¯¥é¿å…ä½¿ç”¨å®ƒï¼

## ORM

ï¼ˆORMåŠŸèƒ½ä»å¤„äºAlphaçŠ¶æ€ï¼‰

Væ‹¥æœ‰ä¸€ä¸ªå†…ç½®çš„ORMï¼ˆå¯¹è±¡å…³ç³»æ˜ å°„ï¼‰ï¼Œæ”¯æŒSQLiteã€MySQLå’ŒPostgresï¼Œä½†å¾ˆå¿«å°†æ”¯æŒMS SQLå’ŒOracleã€‚

Vçš„ORMæä¾›äº†è®¸å¤šä¼˜ç‚¹ï¼š

- é€šç”¨çš„SQLæ–¹è¨€è¯­æ³•ã€‚ï¼ˆåœ¨ä¸åŒæ•°æ®åº“ä¹‹é—´è¿ç§»å˜å¾—æ›´å®¹æ˜“ã€‚ï¼‰
- ä½¿ç”¨Vçš„è¯­æ³•æ„å»ºæŸ¥è¯¢ã€‚ï¼ˆæ— éœ€å­¦ä¹ å¦ä¸€ç§è¯­æ³•ã€‚ï¼‰
- å®‰å…¨æ€§ã€‚ï¼ˆæ‰€æœ‰æŸ¥è¯¢éƒ½ä¼šè‡ªåŠ¨è¿›è¡Œæ¸…ç†ï¼Œä»¥é˜²æ­¢SQLæ³¨å…¥ã€‚ï¼‰
- ç¼–è¯‘æ—¶æ£€æŸ¥ã€‚ï¼ˆé˜²æ­¢åªèƒ½åœ¨è¿è¡Œæ—¶æ•è·çš„æ‹¼å†™é”™è¯¯ã€‚ï¼‰
- å¯è¯»æ€§å’Œç®€æ´æ€§ã€‚ï¼ˆæ— éœ€æ‰‹åŠ¨è§£ææŸ¥è¯¢ç»“æœï¼Œç„¶åæ‰‹åŠ¨ä»è§£æç»“æœæ„å»ºå¯¹è±¡ã€‚ï¼‰

```v
import db.sqlite

// è®¾ç½®è‡ªå®šä¹‰è¡¨åã€‚é»˜è®¤ä¸ºç»“æ„ä½“åç§°ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰
[table: 'customers']
struct Customer {
	id        int    [primary; sql: serial] // æ•´æ•°ç±»å‹çš„åä¸º`id`çš„å­—æ®µå¿…é¡»æ˜¯ç¬¬ä¸€ä¸ªå­—æ®µ
	name      string [nonull]
	nr_orders int
	country   string [nonull]
}

db := sqlite.connect('customers.db')!

// ä½ å¯ä»¥åˆ›å»ºè¡¨æ ¼ï¼š
// CREATE TABLE IF NOT EXISTS `Customer` (
//      `id` INTEGER PRIMARY KEY,
//      `name` TEXT NOT NULL,
//      `nr_orders` INTEGER,
//      `country` TEXT NOT NULL
// )
sql db {
	create table Customer
}!

// ä»customersä¸­é€‰æ‹©è®¡æ•°(*)
nr_customers := sql db {
	select count from Customer
}!
println('æ‰€æœ‰å®¢æˆ·çš„æ•°é‡ï¼š${nr_customers}')

// å¯ä»¥ä½¿ç”¨Vè¯­æ³•æ„å»ºæŸ¥è¯¢
uk_customers := sql db {
	select from Customer where country == 'uk' && nr_orders > 0
}!
println(uk_customers.len)
for customer in uk_customers {
	println('${customer.id} - ${customer.name}')
}

// æ’å…¥ä¸€ä¸ªæ–°å®¢æˆ·
new_customer := Customer{
	name: 'Bob'
	nr_orders: 10
}
sql db {
	insert new_customer into Customer
}!
```

æ›´å¤šç¤ºä¾‹å’Œæ–‡æ¡£ï¼Œè¯·å‚é˜…[vlib/orm](https://github.com/vlang/v/tree/master/vlib/orm)ã€‚

## æ’°å†™æ–‡æ¡£

å…¶å·¥ä½œæ–¹å¼ä¸Goéå¸¸ç›¸ä¼¼ã€‚éå¸¸ç®€å•ï¼šä¸éœ€è¦ä¸ºä»£ç å•ç‹¬ç¼–å†™æ–‡æ¡£ï¼Œ
vdocå°†ä»æºä»£ç ä¸­çš„æ–‡æ¡£å­—ç¬¦ä¸²ç”Ÿæˆå®ƒã€‚

æ¯ä¸ªå‡½æ•°/ç±»å‹/å¸¸é‡çš„æ–‡æ¡£å¿…é¡»æ”¾åœ¨å£°æ˜çš„å‰é¢ï¼š

```v
// clearallæ¸…é™¤æ•°ç»„ä¸­çš„æ‰€æœ‰ä½
fn clearall() {
}
```

æ³¨é‡Šå¿…é¡»ä»¥å®šä¹‰çš„åç§°å¼€å¤´ã€‚

æœ‰æ—¶å€™ä¸€è¡Œä¸è¶³ä»¥è§£é‡Šä¸€ä¸ªå‡½æ•°çš„ä½œç”¨ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ³¨é‡Šåº”è¯¥ä½¿ç”¨å•è¡Œæ³¨é‡Šå»¶ä¼¸åˆ°æ–‡æ¡£åŒ–çš„å‡½æ•°ï¼š

```v
// copy_allé€šè¿‡å…¶å€¼é€’å½’å¤åˆ¶æ•°ç»„çš„æ‰€æœ‰å…ƒç´ ï¼Œ
// å¦‚æœ`dupes`ä¸ºfalseï¼Œåˆ™åœ¨è¿‡ç¨‹ä¸­å°†æ¶ˆé™¤æ‰€æœ‰é‡å¤çš„å€¼ã€‚
fn copy_all(dupes bool) {
	// ...
}
```

æŒ‰ç…§æƒ¯ä¾‹ï¼Œå»ºè®®ä»¥*ç°åœ¨æ—¶*ç¼–å†™æ³¨é‡Šã€‚

æ¨¡å—çš„æ¦‚è¿°å¿…é¡»æ”¾åœ¨æ¨¡å—åç§°åé¢çš„ç¬¬ä¸€ä¸ªæ³¨é‡Šä¸­ã€‚

è¦ç”Ÿæˆæ–‡æ¡£ï¼Œè¯·ä½¿ç”¨vdocï¼Œä¾‹å¦‚ `v doc net.http`ã€‚

### æ–‡æ¡£æ³¨é‡Šä¸­çš„æ¢è¡Œ

è·¨è¶Šå¤šè¡Œçš„æ³¨é‡Šå°†ä½¿ç”¨ç©ºæ ¼åˆå¹¶åœ¨ä¸€èµ·ï¼Œé™¤éï¼š

- è¯¥è¡Œä¸ºç©º
- è¯¥è¡Œä»¥ `.` ç»“å°¾ï¼ˆå¥å­ç»“å°¾ï¼‰
- è¯¥è¡Œç”±è‡³å°‘3ä¸ª `-`ã€`= `ã€`_`ã€`*`ã€`~`ï¼ˆæ°´å¹³åˆ†éš”çº¿ï¼‰ç»„æˆ
- è¯¥è¡Œä»¥è‡³å°‘ä¸€ä¸ª `#` åè·Ÿä¸€ä¸ªç©ºæ ¼å¼€å§‹ï¼ˆæ ‡é¢˜ï¼‰
- è¯¥è¡Œä»¥ `|` å¼€å¤´å¹¶ä»¥ `|` ç»“å°¾ï¼ˆè¡¨æ ¼ï¼‰
- è¯¥è¡Œä»¥ `- ` å¼€å¤´ï¼ˆåˆ—è¡¨ï¼‰

## å·¥å…·

### v fmt

ä½ ä¸éœ€è¦æ‹…å¿ƒä»£ç æ ¼å¼æˆ–è®¾ç½®æ ·å¼æŒ‡å—ã€‚`v fmt`ä¼šä¸ºä½ æå®šï¼š

```shell
v fmt file.v
```

å»ºè®®è®¾ç½®ç¼–è¾‘å™¨ï¼Œä»¥ä¾¿åœ¨æ¯æ¬¡ä¿å­˜æ—¶è¿è¡Œ `v fmt -w`ã€‚vfmtè¿è¡Œé€šå¸¸å¾ˆå¿«ï¼ˆ<30æ¯«ç§’ï¼‰ã€‚

åœ¨æ¨é€ä»£ç ä¹‹å‰ï¼Œå§‹ç»ˆè¿è¡Œ `v fmt -w file.v`ã€‚

#### åœ¨æœ¬åœ°ç¦ç”¨æ ¼å¼åŒ–

è¦åœ¨ä»£ç å—ä¸­ç¦ç”¨æ ¼å¼åŒ–ï¼Œè¯·ä½¿ç”¨ `// vfmt off` å’Œ `// vfmt on` æ³¨é‡Šå°†å…¶åŒ…è£…èµ·æ¥ã€‚

```bash
// ä¸å—fmtå½±å“
// vfmt off

... è¿™é‡Œæ˜¯ä½ çš„ä»£ç  ...

// vfmt on

// å—fmtå½±å“
... è¿™é‡Œæ˜¯ä½ çš„ä»£ç  ...
```

### v shader

ä½ å¯ä»¥åœ¨Vå›¾å½¢åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨GPUç€è‰²å™¨ã€‚ä½ å¯ä»¥ä½¿ç”¨[å¸¦æœ‰æ³¨é‡Šçš„GLSLæ–¹è¨€](https://github.com/vlang/v/blob/1d8ece7/examples/sokol/02_cubes_glsl/cube_glsl.glsl)ç¼–å†™ä½ çš„ç€è‰²å™¨ï¼Œå¹¶ä½¿ç”¨ `v shader` å°†å…¶ç¼–è¯‘ä¸ºæ‰€æœ‰å—æ”¯æŒçš„ç›®æ ‡å¹³å°ã€‚

```shell
v shader /path/to/project/dir/or/file.v
```

ç›®å‰ï¼Œä½ éœ€è¦åœ¨ä»£ç ä¸­ä½¿ç”¨ç€è‰²å™¨ä¹‹å‰ï¼Œ[åŒ…å«ä¸€ä¸ªå¤´æ–‡ä»¶å¹¶å£°æ˜ä¸€ä¸ªç²˜åˆå‡½æ•°](https://github.com/vlang/v/blob/c14c324/examples/sokol/02_cubes_glsl/cube_glsl.v#L43-L46)ã€‚

### æ€§èƒ½åˆ†æ

Vå¯¹äºå¯¹ç¨‹åºè¿›è¡Œæ€§èƒ½åˆ†ææœ‰å¾ˆå¥½çš„æ”¯æŒï¼š`v -profile profile.txt run file.v`ã€‚è¿™å°†äº§ç”Ÿä¸€ä¸ªprofile.txtæ–‡ä»¶ï¼Œä½ å¯ä»¥éšåå¯¹å…¶è¿›è¡Œåˆ†æã€‚

ç”Ÿæˆçš„profile.txtæ–‡ä»¶å°†å…·æœ‰å¸¦æœ‰4åˆ—çš„è¡Œï¼š
a) å‡½æ•°è¢«è°ƒç”¨çš„æ¬¡æ•°
b) ä¸€ä¸ªå‡½æ•°æ€»å…±èŠ±è´¹äº†å¤šå°‘æ—¶é—´ï¼ˆä»¥æ¯«ç§’ä¸ºå•ä½ï¼‰
c) å¹³å‡è°ƒç”¨ä¸€ä¸ªå‡½æ•°èŠ±è´¹äº†å¤šå°‘æ—¶é—´ï¼ˆä»¥çº³ç§’ä¸ºå•ä½ï¼‰
d) vå‡½æ•°çš„åç§°

ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŒ‰åˆ—3ï¼ˆæ¯ä¸ªå‡½æ•°çš„å¹³å‡æ—¶é—´ï¼‰è¿›è¡Œæ’åºï¼š
`sort -n -k3 profile.txt|tail`

ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ç§’è¡¨æ¥æ˜¾å¼åœ°æµ‹é‡ä½ çš„ä»£ç çš„éƒ¨åˆ†ï¼š

```v
import time

fn main() {
	sw := time.new_stopwatch()
	println('Hello world')
	println('é—®å€™å…¨ä¸–ç•ŒèŠ±è´¹æ—¶é—´ï¼š${sw.elapsed().nanoseconds()}ns')
}
```

## åŒ…ç®¡ç†

ä¸€ä¸ªV *æ¨¡å—* æ˜¯ä¸€ä¸ªåŒ…å«.væ–‡ä»¶çš„å•ä¸ªæ–‡ä»¶å¤¹ã€‚ä¸€ä¸ªV *åŒ…* å¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªVæ¨¡å—ã€‚ä¸€ä¸ªV *åŒ…* åº”è¯¥åœ¨å…¶é¡¶å±‚æ–‡ä»¶å¤¹ä¸­æœ‰ä¸€ä¸ª`v.mod`æ–‡ä»¶ï¼Œæè¿°äº†åŒ…çš„å†…å®¹ã€‚

VåŒ…é€šå¸¸å®‰è£…åœ¨`~/.vmodules`æ–‡ä»¶å¤¹ä¸­ã€‚å¯ä»¥é€šè¿‡è®¾ç½®ç¯å¢ƒå˜é‡`VMODULES`æ¥è¦†ç›–è¯¥ä½ç½®ã€‚

### åŒ…å‘½ä»¤

ä½ å¯ä»¥ä½¿ç”¨Vå‰ç«¯æ¥æ‰§è¡ŒåŒ…æ“ä½œï¼Œå°±åƒä½ å¯ä»¥ç”¨å®ƒæ¥ç¼–è¯‘ä»£ç ã€æ ¼å¼åŒ–ä»£ç ã€å®¡æŸ¥ä»£ç ç­‰ä¸€æ ·ã€‚

```powershell
v [package_command] [param]
```

å…¶ä¸­åŒ…å‘½ä»¤å¯ä»¥æ˜¯ä»¥ä¸‹ä¹‹ä¸€ï¼š

```
   install           ä»VPMå®‰è£…åŒ…ã€‚
   remove            åˆ é™¤ä»VPMå®‰è£…çš„åŒ…ã€‚
   search            ä»VPMæœç´¢åŒ…ã€‚
   update            ä»VPMæ›´æ–°å·²å®‰è£…çš„åŒ…ã€‚
   upgrade           å‡çº§æ‰€æœ‰è¿‡æ—¶çš„åŒ…ã€‚
   list              åˆ—å‡ºæ‰€æœ‰å·²å®‰è£…çš„åŒ…ã€‚
   outdated          æ˜¾ç¤ºéœ€è¦æ›´æ–°çš„å·²å®‰è£…åŒ…ã€‚
```

ä½ å¯ä»¥ä½¿ç”¨VPMå®‰è£…å·²ç”±å…¶ä»–äººåˆ›å»ºçš„åŒ…ï¼š

```powershell
v install [package]
```

**ç¤ºä¾‹:**

```powershell
v install ui
```

åŒ…å¯ä»¥ç›´æ¥ä»gitæˆ–mercurialä»“åº“å®‰è£…ã€‚

```powershell
v install [--once] [--git|--hg] [url]
```

**ç¤ºä¾‹:**

```powershell
v install --git https://github.com/vlang/markdown
```

æœ‰æ—¶ï¼Œä½ å¯èƒ½åªæƒ³åœ¨æœªå®‰è£…è¿™äº›åŒ…æ—¶æ‰å®‰è£…ä¾èµ–é¡¹ï¼š

```
v install --once [package]
```

ä½¿ç”¨våˆ é™¤ä¸€ä¸ªåŒ…ï¼š

```powershell
v remove [package]
```

**ç¤ºä¾‹:**

```powershell
v remove ui
```

ä»[VPM](https://vpm.vlang.io/)æ›´æ–°å·²å®‰è£…çš„åŒ…ï¼š

```powershell
v update [package]
```

**ç¤ºä¾‹:**

```powershell
v update ui
```

æˆ–è€…ä½ å¯ä»¥æ›´æ–°æ‰€æœ‰ä½ çš„åŒ…ï¼š

```powershell
v update
```

è¦æŸ¥çœ‹ä½ å·²å®‰è£…çš„æ‰€æœ‰åŒ…ï¼Œä½ å¯ä»¥ä½¿ç”¨ï¼š

```powershell
v list
```

**ç¤ºä¾‹:**

```powershell
> v list
å·²å®‰è£…çš„åŒ…:
  markdown
  ui
```

è¦æŸ¥çœ‹æ‰€æœ‰éœ€è¦æ›´æ–°çš„åŒ…ï¼š

```powershell
v outdated
```

**ç¤ºä¾‹:**

```powershell
> v outdated
åŒ…å·²æ˜¯æœ€æ–°çš„ã€‚
```

### å‘å¸ƒåŒ…

1. åœ¨ä½ çš„åŒ…çš„é¡¶å±‚æ–‡ä»¶å¤¹ä¸­æ”¾ç½®ä¸€ä¸ª`v.mod`æ–‡ä»¶ï¼ˆå¦‚æœä½ ç”¨å‘½ä»¤`v new mypackage`æˆ–`v init`åˆ›å»ºäº†ä½ çš„åŒ…ï¼Œä½ å·²ç»æœ‰äº†ä¸€ä¸ª`v.mod`æ–‡ä»¶ï¼‰ã€‚

   ```sh
   v new mypackage
   è¾“å…¥ä½ çš„é¡¹ç›®æè¿°: æˆ‘çš„ä¼˜ç§€åŒ…ã€‚
   è¾“å…¥ä½ çš„é¡¹ç›®ç‰ˆæœ¬: (0.0.0) 0.0.1
   è¾“å…¥ä½ çš„é¡¹ç›®è®¸å¯è¯: (MIT)
   åˆå§‹åŒ– ...
   å®Œæˆ!
   ````

   ç¤ºä¾‹ `v.mod`ï¼š

   ```v ignore
   Module {
       name: 'mypackage'
       description: 'æˆ‘çš„ä¼˜ç§€åŒ…ã€‚'
       version: '0.0.1'
       license: 'MIT'
       dependencies: []
   }
   ```

   æœ€å°çš„æ–‡ä»¶ç»“æ„ï¼š

   ```
   v.mod
   mypackage.v
   ```

   ä½ çš„åŒ…çš„åç§°åº”è¯¥ä¸`mypackage.v`ä¸­çš„`module`æŒ‡ä»¤ä¸€èµ·ä½¿ç”¨ã€‚

2. åœ¨å¸¦æœ‰`v.mod`æ–‡ä»¶çš„æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ªgitå­˜å‚¨åº“ï¼ˆå¦‚æœä½ ä½¿ç”¨äº†`v new`æˆ–`v init`ï¼Œåˆ™ä¸éœ€è¦æ­¤æ­¥éª¤ï¼‰ï¼š

   ```sh
   git init
   git add .
   git commit -m "INIT"
   ````

3. åœ¨github.comä¸Šåˆ›å»ºä¸€ä¸ªå…¬å…±å­˜å‚¨åº“ã€‚

4. å°†æœ¬åœ°å­˜å‚¨åº“è¿æ¥åˆ°è¿œç¨‹å­˜å‚¨åº“å¹¶æ¨é€æ›´æ”¹ã€‚

5. å°†ä½ çš„åŒ…æ·»åŠ åˆ°å…¬å…±VåŒ…æ³¨å†Œè¡¨VPMï¼š
   https://vpm.vlang.io/new

   ä½ éœ€è¦ä½¿ç”¨ä½ çš„Githubè´¦å·ç™»å½•æ‰èƒ½æ³¨å†ŒåŒ…ã€‚
   **è­¦å‘Šï¼š** _ç›®å‰æ— æ³•åœ¨æäº¤åç¼–è¾‘ä½ çš„æ¡ç›®ã€‚è¯·ä»”ç»†æ£€æŸ¥ä½ çš„åŒ…åå’Œgithub urlï¼Œå› ä¸ºä½ ä»¥åæ— æ³•æ›´æ”¹å®ƒä»¬ã€‚_

6. æœ€ç»ˆåŒ…åæ˜¯ä½ çš„githubè´¦å·å’Œä½ æä¾›çš„åŒ…åçš„ç»„åˆï¼Œä¾‹å¦‚`mygithubname.mypackage`ã€‚

**å¯é€‰çš„ï¼š** åœ¨github.comä¸Šä½¿ç”¨ `vlang` å’Œ `vlang-package` æ ‡è®°ä½ çš„VåŒ…ï¼Œä»¥æä¾›æ›´å¥½çš„æœç´¢ä½“éªŒã€‚

# é«˜çº§ä¸»é¢˜ï¼ˆAdvanced Topicsï¼‰

## å±æ€§

Vè¯­è¨€å…·æœ‰å‡ ä¸ªå±æ€§ï¼Œå¯ä»¥ä¿®æ”¹å‡½æ•°å’Œç»“æ„ä½“çš„è¡Œä¸ºã€‚

å±æ€§æ˜¯æŒ‡å®šåœ¨å‡½æ•°/ç»“æ„ä½“/æšä¸¾å£°æ˜ä¹‹å‰çš„`[]`å†…çš„ç¼–è¯‘å™¨æŒ‡ä»¤ï¼Œä»…é€‚ç”¨äºåç»­çš„å£°æ˜ã€‚

```v
// [flag] å¯ç”¨æšä¸¾ç±»å‹ä½œä¸ºä½å­—æ®µä½¿ç”¨

[flag]
enum BitField {
	read
	write
	other
}

fn main() {
	assert 1 == int(BitField.read)
	assert 2 == int(BitField.write)
	mut bf := BitField.read
	assert bf.has(.read | .other) // æµ‹è¯•æ˜¯å¦è®¾ç½®äº†*è‡³å°‘ä¸€ä¸ª*æ ‡å¿—
	assert !bf.all(.read | .other) // æµ‹è¯•æ˜¯å¦æ‰€æœ‰æ ‡å¿—éƒ½å·²è®¾ç½®
	bf.set(.write | .other)
	assert bf.has(.read | .write | .other)
	assert bf.all(.read | .write | .other)
	bf.toggle(.other)
	assert bf == BitField.read | .write
	assert bf.all(.read | .write)
	assert !bf.has(.other)
}
```

ç»“æ„ä½“å­—æ®µçš„å¼ƒç”¨ï¼š

```v oksyntax
module abc

// è¯·æ³¨æ„ï¼Œä»…åœ¨*å…¶ä»–æ¨¡å—*ä¸­å¯¹Xyz.dçš„*ç›´æ¥*è®¿é—®ï¼Œå°†äº§ç”Ÿå¼ƒç”¨é€šçŸ¥/è­¦å‘Šï¼š
pub struct Xyz {
pub mut:
	a int
	d int [deprecated: 'è¯·ä½¿ç”¨Xyz.aä»£æ›¿'; deprecated_after: '2999-03-01']
	// ä¸Šè¿°æ ‡ç­¾ï¼Œå°†äº§ç”Ÿä¸€ä¸ªé€šçŸ¥ï¼Œå› ä¸ºå¼ƒç”¨æ—¥æœŸåœ¨é¥è¿œçš„æœªæ¥
}
```

å‡½æ•°/æ–¹æ³•çš„å¼ƒç”¨ï¼š

```v
// è°ƒç”¨æ­¤å‡½æ•°å°†å¯¼è‡´å¼ƒç”¨è­¦å‘Š

[deprecated]
fn old_function() {
}

// è¿˜å¯ä»¥æ˜¾ç¤ºè‡ªå®šä¹‰çš„å¼ƒç”¨æ¶ˆæ¯

[deprecated: 'è¯·ä½¿ç”¨new_function()ä»£æ›¿']
fn legacy_function() {}

// ä½ è¿˜å¯ä»¥æŒ‡å®šä¸€ä¸ªæ—¥æœŸï¼Œåœ¨æ­¤æ—¥æœŸä¹‹åï¼Œå°†è§†è¯¥å‡½æ•°ä¸ºå·²å¼ƒç”¨ã€‚åœ¨æ­¤æ—¥æœŸä¹‹å‰ï¼Œå¯¹å‡½æ•°çš„è°ƒç”¨å°†æ˜¯ç¼–è¯‘å™¨é€šçŸ¥ - ä½ ä¼šçœ‹åˆ°å®ƒä»¬ï¼Œä½†ä¸ä¼šå½±å“ç¼–è¯‘ã€‚åœ¨æ­¤æ—¥æœŸä¹‹åï¼Œè°ƒç”¨å°†æˆä¸ºè­¦å‘Šï¼Œå› æ­¤ä½¿ç”¨æ™®é€šç¼–è¯‘ä»å°†æ­£å¸¸å·¥ä½œï¼Œä½†ä½¿ç”¨ -prod ç¼–è¯‘å°†ä¸ä¼šï¼ˆæ‰€æœ‰è­¦å‘Šéƒ½åƒé”™è¯¯ä¸€æ ·å¤„ç†ï¼‰ã€‚
// å¼ƒç”¨æ—¥æœŸåçš„6ä¸ªæœˆï¼Œè°ƒç”¨å°†æˆä¸ºä¸¥æ ¼çš„ç¼–è¯‘å™¨é”™è¯¯ã€‚

[deprecated: 'è¯·ä½¿ç”¨new_function2()ä»£æ›¿']
[deprecated_after: '2021-05-27']
fn legacy_function2() {}
```

```v nofmt
// æ­¤å‡½æ•°çš„è°ƒç”¨å°†è¢«å†…è”ã€‚
[inline]
fn inlined_function() {
}

// æ­¤å‡½æ•°çš„è°ƒç”¨å°†ä¸ä¼šè¢«å†…è”ã€‚
[noinline]
fn function() {
}

// æ­¤å‡½æ•°å°†ä¸ä¼šè¿”å›ç»™å…¶è°ƒç”¨è€…ã€‚
// è¿™æ ·çš„å‡½æ•°å¯ä»¥åœ¨ä»£ç å—çš„æœ«å°¾ä½¿ç”¨ï¼Œå°±åƒ exit/1 æˆ– panic/1 ä¸€æ ·ã€‚æ­¤ç±»å‡½æ•°ä¸èƒ½å…·æœ‰è¿”å›ç±»å‹ï¼Œå¹¶ä¸”åº”è¯¥ä»¥ for{} ç»“æŸï¼Œæˆ–è€…é€šè¿‡è°ƒç”¨å…¶ä»– `[noreturn]` å‡½æ•°æ¥ç»“æŸã€‚
[noreturn]
fn forever() {
	for {}
}

// å¿…é¡»åœ¨ `unsafe {}` å—ä¸­è°ƒç”¨ä»¥ä¸‹å‡½æ•°ã€‚
// è¯·æ³¨æ„ï¼Œ`risky_business()` ä¸­çš„ä»£ç ä»å°†è¢«æ£€æŸ¥ï¼Œé™¤éä½ ä¹Ÿå°†å…¶åŒ…è£…åœ¨ `unsafe {}` å—ä¸­ã€‚
// è¿™åœ¨ä½ æƒ³è¦åœ¨æŸäº›ä¸å®‰å…¨æ“ä½œä¹‹å‰/ä¹‹åå…·æœ‰æ£€æŸ¥çš„ `[unsafe]` å‡½æ•°æ—¶éå¸¸æœ‰ç”¨ï¼Œä½†ä»å°†å—ç›ŠäºVçš„å®‰å…¨åŠŸèƒ½ã€‚

[unsafe]
fn risky_business() {
	// å°†è¦æ£€æŸ¥çš„ä»£ç ï¼Œä¹Ÿè®¸æ£€æŸ¥å‰ææ¡ä»¶
	unsafe {
		// ä¸ä¼šè¢«æ£€æŸ¥çš„ä»£ç ï¼Œä¾‹å¦‚æŒ‡é’ˆç®—æœ¯ï¼Œè®¿é—®è”åˆå­—æ®µï¼Œè°ƒç”¨å…¶ä»– `[unsafe]` å‡½æ•°ç­‰...
		é€šå¸¸æƒ…å†µä¸‹ï¼Œå°†ä»£ç åŒ…è£…åœ¨ `unsafe{}` ä¸­æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„åšæ³•ã€‚
		å¦è¯·å‚è§ [Memory-unsafe code](#memory-unsafe-code)ã€‚
	}
	// å°†è¦æ£€æŸ¥çš„ä»£ç ï¼Œä¹Ÿè®¸æ£€æŸ¥åææ¡ä»¶å’Œ/æˆ–ä¿æŒä¸å˜é‡
}

// Vçš„è‡ªåŠ¨é‡Šæ”¾å¼•æ“å°†ä¸ä¼šåœ¨æ­¤å‡½æ•°ä¸­å¤„ç†å†…å­˜ç®¡ç†ã€‚
// ä½ å°†è´Ÿè´£åœ¨æ­¤å‡½æ•°ä¸­æ‰‹åŠ¨é‡Šæ”¾å†…å­˜ã€‚
[manualfree]
fn custom_allocations() {
}

// ä»…ç”¨äºCäº’æ“ä½œï¼Œå‘Šè¯‰Vä»¥ä¸‹ç»“æ„ä½“åœ¨Cä¸­ç”¨ `typedef struct` å®šä¹‰
[typedef]
struct C.Foo {
}

// ç”¨äºå‘å‡½æ•°æ·»åŠ è‡ªå®šä¹‰è°ƒç”¨çº¦å®šï¼Œå¯ç”¨è°ƒç”¨çº¦å®šï¼šstdcallã€fastcall å’Œ cdeclã€‚
// æ­¤åˆ—è¡¨ä¹Ÿé€‚ç”¨äºç±»å‹åˆ«åï¼ˆè§ä¸‹æ–‡ï¼‰ã€‚
[callconv: "stdcall"]
fn C.DefWindowProc(hwnd int, msg int, lparam int, wparam int)

// ç”¨äºå‘å‡½æ•°ç±»å‹åˆ«åæ·»åŠ è‡ªå®šä¹‰è°ƒç”¨çº¦å®šã€‚
[callconv: "fastcall"]
type FastFn = fn (int) bool

// ä»…åœ¨Windowsä¸Šï¼š
// å¦‚æœæ²¡æœ‰æ­¤å±æ€§ï¼Œæ‰€æœ‰å›¾å½¢åº”ç”¨ç¨‹åºåœ¨Windowsä¸Šéƒ½å°†å…·æœ‰ä»¥ä¸‹è¡Œä¸ºï¼š
// å¦‚æœä»æ§åˆ¶å°æˆ–ç»ˆç«¯è¿è¡Œï¼›ä¿æŒç»ˆç«¯æ‰“å¼€ä»¥ä¾¿æŸ¥çœ‹æ‰€æœ‰ (e)println è¯­å¥ã€‚
// å¦‚æœä»Explorerç­‰å¯åŠ¨ï¼›æ‰“å¼€åº”ç”¨ç¨‹åºï¼Œä½†ä¸ä¼šæ‰“å¼€ç»ˆç«¯ï¼Œä¹Ÿä¸ä¼šçœ‹åˆ° (e)println è¾“å‡ºã€‚
// ç”¨äºå¼ºåˆ¶æ‰“å¼€ä¸€ä¸ªç»ˆç«¯ä»¥æŸ¥çœ‹è¾“å‡º

ï¼Œå³ä½¿æ˜¯ä»Explorerå¯åŠ¨çš„åº”ç”¨ç¨‹åºä¹Ÿæ˜¯å¦‚æ­¤ã€‚
// ä»…åœ¨ main() ä¹‹å‰æœ‰æ•ˆã€‚
[console]
fn main() {
}
```

## æ¡ä»¶ç¼–è¯‘

### ç¼–è¯‘æ—¶ä¼ªå˜é‡

Vè¿˜ä¸ºæ‚¨çš„ä»£ç æä¾›äº†ä¸€ç»„ä¼ªå­—ç¬¦ä¸²å˜é‡ï¼Œå®ƒä»¬åœ¨ç¼–è¯‘æ—¶æ›¿æ¢ä¸ºå®é™…çš„å€¼ï¼š

- `@FN` => æ›¿æ¢ä¸ºå½“å‰Vå‡½æ•°çš„åç§°
- `@METHOD` => æ›¿æ¢ä¸ºReceiverType.MethodName
- `@MOD` => æ›¿æ¢ä¸ºå½“å‰Væ¨¡å—çš„åç§°
- `@STRUCT` => æ›¿æ¢ä¸ºå½“å‰Vç»“æ„ä½“çš„åç§°
- `@FILE` => æ›¿æ¢ä¸ºVæºæ–‡ä»¶çš„ç»å¯¹è·¯å¾„
- `@LINE` => æ›¿æ¢ä¸ºå‡ºç°å®ƒçš„Vè¡Œå·ï¼ˆä½œä¸ºå­—ç¬¦ä¸²ï¼‰ã€‚
- `@FILE_LINE` => åƒ `@FILE:@LINE` ä¸€æ ·ï¼Œä½†æ–‡ä»¶éƒ¨åˆ†æ˜¯ç›¸å¯¹è·¯å¾„
- `@COLUMN` => æ›¿æ¢ä¸ºå‡ºç°å®ƒçš„åˆ—å·ï¼ˆä½œä¸ºå­—ç¬¦ä¸²ï¼‰ã€‚
- `@VEXE` => æ›¿æ¢ä¸ºVç¼–è¯‘å™¨çš„è·¯å¾„
- `@VEXEROOT`  => å°†è¢«æ›¿æ¢ä¸ºåŒ…å«Vå¯æ‰§è¡Œæ–‡ä»¶çš„*æ–‡ä»¶å¤¹*ï¼ˆä½œä¸ºå­—ç¬¦ä¸²ï¼‰ã€‚
- `@VHASH`  => æ›¿æ¢ä¸ºVç¼–è¯‘å™¨çš„ç¼©çŸ­æäº¤å“ˆå¸Œï¼ˆä½œä¸ºå­—ç¬¦ä¸²ï¼‰ã€‚
- `@VMOD_FILE` => æ›¿æ¢ä¸ºæœ€è¿‘çš„v.modæ–‡ä»¶çš„å†…å®¹ï¼ˆä½œä¸ºå­—ç¬¦ä¸²ï¼‰ã€‚
- `@VMODROOT` => å°†è¢«æ›¿æ¢ä¸ºæœ€è¿‘çš„v.modæ–‡ä»¶æ‰€åœ¨çš„*æ–‡ä»¶å¤¹*ï¼ˆä½œä¸ºå­—ç¬¦ä¸²ï¼‰ã€‚

è¿™å…è®¸ä½ åœ¨è°ƒè¯•/è®°å½•/è·Ÿè¸ªä»£ç æ—¶æ‰§è¡Œä»¥ä¸‹ç¤ºä¾‹ï¼š

```v
eprintln('file: ' + @FILE + ' | line: ' + @LINE + ' | fn: ' + @MOD + '.' + @FN)
```

å¦ä¸€ä¸ªä¾‹å­æ˜¯ï¼Œå¦‚æœä½ æƒ³å°†v.modä¸­çš„ç‰ˆæœ¬/åç§°åµŒå…¥åˆ°ä½ çš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼š

```v ignore
import v.vmod
vm := vmod.decode( @VMOD_FILE ) or { panic(err) }
eprintln('${vm.name} ${vm.version}\n ${vm.description}')
```

### ç¼–è¯‘æ—¶åå°„

`$` ç”¨ä½œç¼–è¯‘æ—¶ï¼ˆä¹Ÿç§°ä¸ºâ€œcomptimeâ€ï¼‰æ“ä½œçš„å‰ç¼€ã€‚

å†…ç½®JSONæ”¯æŒéå¸¸å¥½ï¼Œä½†Vè¿˜å…è®¸ä½ ä¸ºä»»ä½•æ•°æ®æ ¼å¼åˆ›å»ºé«˜æ•ˆçš„åºåˆ—åŒ–ç¨‹åºã€‚Vå…·æœ‰ç¼–è¯‘æ—¶çš„ `if` å’Œ `for` ç»“æ„ï¼š

```v
struct User {
	name string
	age  int
}

fn main() {
	$for field in User.fields {
		$if field.typ is string {
			println('${field.name} æ˜¯å­—ç¬¦ä¸²ç±»å‹')
		}
	}
}

// è¾“å‡ºï¼š
// name æ˜¯å­—ç¬¦ä¸²ç±»å‹
```

æœ‰å…³æ›´å®Œæ•´çš„ç¤ºä¾‹ï¼Œè¯·å‚é˜…[`examples/compiletime/reflection.v`](/examples/compiletime/reflection.v)ã€‚

#### `$if` æ¡ä»¶

```v
fn main() {
	// æ”¯æŒåœ¨ä¸€ä¸ªåˆ†æ”¯ä¸­æœ‰å¤šä¸ªæ¡ä»¶
	$if ios || android {
		println('åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šè¿è¡Œï¼')
	}
	$if linux && x64 {
		println('64ä½ Linuxã€‚')
	}
	// ç”¨ä½œè¡¨è¾¾å¼çš„ç”¨æ³•
	os := $if windows { 'Windows' } $else { 'UNIX' }
	println('ä½¿ç”¨ ${os}')
	// $else-$if åˆ†æ”¯
	$if tinyc {
		println('tinyc')
	} $else $if clang {
		println('clang')
	} $else $if gcc {
		println('gcc')
	} $else {
		println('ä¸åŒçš„ç¼–è¯‘å™¨')
	}
	$if test {
		println('æµ‹è¯•ä¸­')
	}
	// v -cg ...
	$if debug {
		println('è°ƒè¯•ä¸­')
	}
	// v -prod ...
	$if prod {
		println('ç”Ÿäº§æ„å»º')
	}
	// v -d é€‰é¡¹ ...
	$if option ? {
		println('è‡ªå®šä¹‰é€‰é¡¹')
	}
}
```

å¦‚æœè¦åœ¨ç¼–è¯‘æ—¶è¯„ä¼°`if`æ¡ä»¶ï¼Œå¿…é¡»åœ¨å‰é¢åŠ ä¸Š`$`ç¬¦å·ã€‚
ç›®å‰å®ƒå¯ä»¥ç”¨äºæ£€æµ‹æ“ä½œç³»ç»Ÿã€ç¼–è¯‘å™¨ã€å¹³å°æˆ–ç¼–è¯‘é€‰é¡¹ã€‚
`$if debug`æ˜¯ä¸€ä¸ªç‰¹æ®Šé€‰é¡¹ï¼Œå°±åƒ`$if windows`æˆ–`$if x32`ä¸€æ ·ï¼Œå®ƒåœ¨ç¨‹åºä½¿ç”¨`v -g`æˆ–`v -cg`ç¼–è¯‘æ—¶å¯ç”¨ã€‚
å¦‚æœä½ ä½¿ç”¨äº†è‡ªå®šä¹‰çš„`#ifdef`ï¼Œé‚£ä¹ˆä½ ç¡®å®éœ€è¦`$if option ? {}`ï¼Œå¹¶ä½¿ç”¨`v -d option`è¿›è¡Œç¼–è¯‘ã€‚
å†…ç½®é€‰é¡¹çš„å®Œæ•´åˆ—è¡¨å¦‚ä¸‹ï¼š

| æ“ä½œç³»ç»Ÿ                       | ç¼–è¯‘å™¨           | å¹³å°                          | å…¶ä»–                                  |
| ------------------------------ | ---------------- | ----------------------------- | ------------------------------------- |
| `windows`, `linux`, `macos`    | `gcc`, `tinyc`   | `amd64`, `arm64`, `aarch64`   | `debug`, `prod`, `test`               |
| `mac`, `darwin`, `ios`,        | `clang`, `mingw` | `i386`, `arm32`               | `js`, `glibc`, `prealloc`             |
| `android`, `mach`, `dragonfly` | `msvc`           | `x64`, `x32`                  | `no_bounds_checking`, `freestanding`  |
| `gnu`, `hpux`, `haiku`, `qnx`  | `cplusplus`      | `little_endian`, `big_endian` | `no_segfault_handler`, `no_backtrace` |
| `solaris`, `termux`            |                  |                               | `no_main`                             |

#### `$embed_file`

```v ignore
import os
fn main() {
	embedded_file := $embed_file('v.png')
	os.write_file('exported.png', embedded_file.to_string())!
}
```

Vå¯ä»¥ä½¿ç”¨`$embed_file(<path>)`ç¼–è¯‘æ—¶è°ƒç”¨å°†ä»»æ„æ–‡ä»¶åµŒå…¥å¯æ‰§è¡Œæ–‡ä»¶ä¸­ã€‚è·¯å¾„å¯ä»¥æ˜¯ç›¸å¯¹äºæºæ–‡ä»¶çš„ç»å¯¹è·¯å¾„æˆ–ç›¸å¯¹è·¯å¾„ã€‚

å½“ä½ ä¸ä½¿ç”¨`-prod`æ—¶ï¼Œæ–‡ä»¶å°†ä¸ä¼šè¢«åµŒå…¥ã€‚ç›¸åï¼Œå®ƒå°†åœ¨ç¨‹åºé¦–æ¬¡åœ¨è¿è¡Œæ—¶è°ƒç”¨`embedded_file.data()`æ—¶åœ¨è¿è¡Œæ—¶åŠ è½½ï¼Œè¿™æ ·ä½ å°±å¯ä»¥æ›´å®¹æ˜“åœ°åœ¨å¤–éƒ¨ç¼–è¾‘å™¨ä¸­è¿›è¡Œæ›´æ”¹ï¼Œè€Œæ— éœ€é‡æ–°ç¼–è¯‘å¯æ‰§è¡Œæ–‡ä»¶ã€‚

å½“ä½ ä½¿ç”¨`-prod`ç¼–è¯‘æ—¶ï¼Œæ–‡ä»¶å°†*è¢«åµŒå…¥åˆ°*å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œå¢åŠ äº†äºŒè¿›åˆ¶æ–‡ä»¶çš„å¤§å°ï¼Œä½†ä½¿å…¶æ›´è‡ªåŒ…å«ï¼Œå› æ­¤æ›´å®¹æ˜“åˆ†å‘ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ`embedded_file.data()`å°†ä¸ä¼šè¿›è¡Œ*ä»»ä½•IO*ï¼Œå®ƒå°†å§‹ç»ˆè¿”å›ç›¸åŒçš„æ•°æ®ã€‚

`$embed_file`åœ¨ä½¿ç”¨`-prod`ç¼–è¯‘æ—¶æ”¯æŒå¯¹åµŒå…¥æ–‡ä»¶è¿›è¡Œå‹ç¼©ã€‚ç›®å‰ä»…æ”¯æŒä¸€ç§å‹ç¼©ç±»å‹ï¼š`zlib`ã€‚

```v ignore
import os
fn main() {
	embedded_file := $embed_file('v.png', .zlib) // ä½¿ç”¨zlibå‹ç¼©
	os.write_file('exported.png', embedded_file.to_string())!
}
```

`$embed_file`è¿”å›ä¸€ä¸ªåä¸º[EmbedFileData](https://modules.vlang.io/v.embed_file.html#EmbedFileData)çš„å¯¹è±¡ï¼Œå¯ä»¥ç”¨äºä»¥`string`æˆ–`[]u8`çš„å½¢å¼è·å–æ–‡ä»¶å†…å®¹ã€‚

#### `$tmpl` ç”¨äºåµŒå…¥å’Œè§£æVæ¨¡æ¿æ–‡ä»¶

Væ‹¥æœ‰ä¸€ä¸ªç®€å•çš„æ¨¡æ¿è¯­è¨€ï¼Œå¯ä»¥ç”¨äºæ–‡æœ¬å’ŒHTMLæ¨¡æ¿ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡`$tmpl('path/to/template.txt')`è½»æ¾åœ°è¿›è¡ŒåµŒå…¥ï¼š

```v ignore
fn build() string {
	name := 'Peter'
	age := 25
	numbers := [1, 2, 3]
	return $tmpl('1.txt')
}

fn main() {
	println(build())
}
```

1.txt:

```
name: @name

age: @age

numbers: @numbers

@for number in numbers
  @number
@end
```

è¾“å‡º:

```
name: Peter

age: 25

numbers: [1, 2, 3]

1
2
3
```

äº†è§£æ›´å¤šè¯¦ç»†ä¿¡æ¯ [details](https://github.com/vlang/v/blob/master/vlib/v/TEMPLATES.md)

#### `$env`

```v
module main

fn main() {
	compile_time_env := $env('ENV_VAR')
	println(compile_time_env)
}
```

Vå¯ä»¥ä»ç¯å¢ƒå˜é‡ä¸­åœ¨ç¼–è¯‘æ—¶è·å–å€¼ã€‚
`$env('ENV_VAR')`ä¹Ÿå¯ä»¥ç”¨äºé¡¶å±‚çš„`#flag`å’Œ`#include`è¯­å¥ï¼š
`#flag linux -I $env('JAVA_HOME')/include`ã€‚

#### `$compile_error` å’Œ `$compile_warn`

è¿™ä¸¤ä¸ªç¼–è¯‘æ—¶å‡½æ•°åœ¨ç¼–è¯‘æ—¶æ˜¾ç¤ºè‡ªå®šä¹‰é”™è¯¯/è­¦å‘Šé

å¸¸æœ‰ç”¨ã€‚

ä¸¤è€…çš„å”¯ä¸€å‚æ•°éƒ½æ˜¯åŒ…å«è¦æ˜¾ç¤ºçš„æ¶ˆæ¯çš„å­—ç¬¦ä¸²æ–‡å­—ï¼š

```v failcompile nofmt
// x.v
module main

$if linux {
    $compile_error('Linux is not supported')
}

fn main() {
}

$ v run x.v
x.v:4:5: error: Linux is not supported
    2 |
    3 | $if linux {
    4 |     $compile_error('Linux is not supported')
      |     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    5 | }
    6 |
```

### ç¼–è¯‘æ—¶ç±»å‹

ç¼–è¯‘æ—¶ç±»å‹å°†å¤šä¸ªç±»å‹ç»„åˆæˆä¸€ä¸ªæ›´é«˜çº§çš„é€šç”¨ç±»å‹ã€‚è¿™åœ¨å…·æœ‰é€šç”¨å‚æ•°çš„å‡½æ•°ä¸­å¾ˆæœ‰ç”¨ï¼Œå…¶ä¸­è¾“å…¥ç±»å‹å¿…é¡»å…·æœ‰ç‰¹å®šå±æ€§ï¼Œä¾‹å¦‚æ•°ç»„ä¸­çš„`.len`å±æ€§ã€‚

Væ”¯æŒä»¥ä¸‹ç¼–è¯‘æ—¶ç±»å‹ï¼š

- `$alias` => åŒ¹é…[ç±»å‹åˆ«å](#ç±»å‹åˆ«å)ã€‚
- `$array` => åŒ¹é…[æ•°ç»„](#æ•°ç»„)å’Œ[å›ºå®šå¤§å°æ•°ç»„](#å›ºå®šå¤§å°æ•°ç»„)ã€‚
- `$enum` => åŒ¹é…[æšä¸¾](#æšä¸¾)ã€‚
- `$float` => åŒ¹é…`f32`ã€`f64`å’Œæµ®ç‚¹å­—é¢å€¼ã€‚
- `$function` => åŒ¹é…[å‡½æ•°ç±»å‹](#å‡½æ•°ç±»å‹)ã€‚
- `$int` => åŒ¹é…`int`ã€`i8`ã€`i16`ã€`i32`ã€`i64`ã€`u8`ã€`u16`ã€`u32`ã€`u64`ã€`isize`ã€`usize`å’Œæ•´æ•°å­—é¢å€¼ã€‚
- `$interface` => åŒ¹é…[æ¥å£](#æ¥å£)ã€‚
- `$map` => åŒ¹é…[æ˜ å°„](#æ˜ å°„)ã€‚
- `$option` => åŒ¹é…[Optionç±»å‹](#optionresultç±»å‹å’Œé”™è¯¯å¤„ç†)ã€‚
- `$struct` => åŒ¹é…[ç»“æ„ä½“](#ç»“æ„ä½“)ã€‚
- `$sumtype` => åŒ¹é…[æ±‚å’Œç±»å‹](#æ±‚å’Œç±»å‹)ã€‚

### ç‰¹å®šç¯å¢ƒçš„æ–‡ä»¶

å¦‚æœæ–‡ä»¶å…·æœ‰ç‰¹å®šäºç¯å¢ƒçš„åç¼€ï¼Œå®ƒå°†ä»…åœ¨è¯¥ç¯å¢ƒä¸­è¿›è¡Œç¼–è¯‘ã€‚

- `.js.v` => ä»…ç”±JSåç«¯ä½¿ç”¨ã€‚è¿™äº›æ–‡ä»¶å¯ä»¥åŒ…å«JSä»£ç ã€‚
- `.c.v` => ä»…ç”±Cåç«¯ä½¿ç”¨ã€‚è¿™äº›æ–‡ä»¶å¯ä»¥åŒ…å«Cä»£ç ã€‚
- `.native.v` => ä»…ç”±Vçš„æœ¬æœºåç«¯ä½¿ç”¨ã€‚
- `_nix.c.v` => ä»…åœ¨Unixç³»ç»Ÿï¼ˆéWindowsï¼‰ä¸Šä½¿ç”¨ã€‚
- `_${os}.c.v` => ä»…åœ¨ç‰¹å®š`os`ç³»ç»Ÿä¸Šä½¿ç”¨ã€‚ä¾‹å¦‚ï¼Œ`_windows.c.v`ä»…åœ¨Windowsä¸Šç¼–è¯‘æ—¶ä½¿ç”¨ï¼Œæˆ–è€…ä½¿ç”¨`-os windows`ã€‚
- `_default.c.v` => ä»…å½“æ²¡æœ‰æ›´ç‰¹å®šçš„å¹³å°æ–‡ä»¶æ—¶ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼Œå¦‚æœåŒæ—¶å­˜åœ¨`file_linux.c.v`å’Œ`file_default.c.v`ï¼Œå¹¶ä¸”ä½ æ­£åœ¨ä¸ºlinuxç¼–è¯‘ï¼Œé‚£ä¹ˆåªä¼šä½¿ç”¨`file_linux.c.v`ï¼Œå¹¶ä¸”å°†å¿½ç•¥`file_default.c.v`ã€‚

ä»¥ä¸‹æ˜¯ä¸€ä¸ªæ›´å®Œæ•´çš„ç¤ºä¾‹ï¼š
main.v:

```v ignore
module main
fn main() { println(message) }
```

main_default.c.v:

```v ignore
module main
const ( message = 'Hello world' )
```

main_linux.c.v:

```v ignore
module main
const ( message = 'Hello linux' )
```

main_windows.c.v:

```v ignore
module main
const ( message = 'Hello windows' )
```

åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼š

- å½“ä½ ä¸ºWindowsç¼–è¯‘æ—¶ï¼Œä½ å°†å¾—åˆ°'Hello windows'

- å½“ä½ ä¸ºlinuxç¼–è¯‘æ—¶ï¼Œä½ å°†å¾—åˆ°'Hello linux'

- å½“ä½ ä¸ºä»»ä½•å…¶ä»–å¹³å°ç¼–è¯‘æ—¶ï¼Œä½ å°†å¾—åˆ°ä¸ç‰¹å®šçš„'Hello world'æ¶ˆæ¯ã€‚

- `_d_customflag.v` => ä»…å½“ä½ å‘Vä¼ é€’`-d customflag`æ—¶æ‰ä¼šä½¿ç”¨ã€‚è¿™å¯¹åº”äº`$if customflag ? {}`ï¼Œä½†é€‚ç”¨äºæ•´ä¸ªæ–‡ä»¶ï¼Œè€Œä¸ä»…ä»…æ˜¯ä¸€ä¸ªå•ç‹¬çš„å—ã€‚`customflag`åº”è¯¥æ˜¯ä¸€ä¸ªè›‡å½¢å‘½åçš„æ ‡è¯†ç¬¦ï¼Œä¸èƒ½åŒ…å«ä»»æ„å­—ç¬¦ï¼ˆåªèƒ½æ˜¯å°å†™æ‹‰ä¸å­—æ¯+æ•°å­—+`_`ï¼‰ã€‚

  > **æ³¨æ„**

> ç»„åˆ `_d_customflag_linux.c.v` åç¼€å°†ä¸èµ·ä½œç”¨ã€‚
> å¦‚æœä½ ç¡®å®éœ€è¦ä¸€ä¸ªåŒ…å«å¹³å°ç›¸å…³ä»£ç çš„è‡ªå®šä¹‰æ ‡å¿—æ–‡ä»¶ï¼Œè¯·ä½¿ç”¨åç¼€ `_d_customflag.v`ï¼Œç„¶ååœ¨å…¶ä¸­ä½¿ç”¨å¹³å°ç›¸å…³çš„ç¼–è¯‘æ—¶æ¡ä»¶å—ï¼Œä¾‹å¦‚ `$if linux {}` ç­‰ã€‚

- `_notd_customflag.v` => ç±»ä¼¼äº _d_customflag.vï¼Œä½†ä»…åœ¨ä½ æœªä¼ é€’ `-d customflag` ç»™ V æ—¶ä½¿ç”¨ã€‚

å¦è¯·å‚é˜… [äº¤å‰ç¼–è¯‘](#äº¤å‰ç¼–è¯‘)ã€‚

## å†…å­˜ä¸å®‰å…¨çš„ä»£ç 

æœ‰æ—¶ä¸ºäº†æ•ˆç‡ï¼Œæ‚¨å¯èƒ½å¸Œæœ›ç¼–å†™å¯èƒ½ä¼šæŸåå†…å­˜æˆ–å®¹æ˜“å—åˆ°å®‰å…¨æ¼æ´å½±å“çš„åº•å±‚ä»£ç ã€‚V æ”¯æŒç¼–å†™æ­¤ç±»ä»£ç ï¼Œä½†é»˜è®¤æƒ…å†µä¸‹ä¸å…è®¸ã€‚

V è¦æ±‚å°†ä»»ä½•å¯èƒ½ä¸å®‰å…¨çš„å†…å­˜æ“ä½œæ ‡è®°ä¸ºæœ‰æ„çš„ã€‚å°†å®ƒä»¬æ ‡è®°ä¹Ÿä¼šå‘é˜…è¯»ä»£ç çš„ä»»ä½•äººæŒ‡å‡ºï¼Œå¦‚æœå‡ºç°é”™è¯¯ï¼Œå¯èƒ½ä¼šå­˜åœ¨å†…å­˜å®‰å…¨æ€§é—®é¢˜ã€‚

å¯èƒ½ä¸å®‰å…¨çš„æ“ä½œç¤ºä¾‹åŒ…æ‹¬ï¼š

- æŒ‡é’ˆç®—æœ¯
- æŒ‡é’ˆç´¢å¼•
- ä»ä¸å…¼å®¹ç±»å‹è½¬æ¢ä¸ºæŒ‡é’ˆ
- è°ƒç”¨æŸäº› C å‡½æ•°ï¼Œä¾‹å¦‚ `free`ã€`strlen` å’Œ `strncmp`ã€‚

è¦æ ‡è®°å¯èƒ½ä¸å®‰å…¨çš„æ“ä½œï¼Œè¯·å°†å®ƒä»¬æ”¾åœ¨ `unsafe` å—ä¸­ï¼š

```v
// åˆ†é… 2 ä¸ªæœªåˆå§‹åŒ–çš„å­—èŠ‚å¹¶è¿”å›å¯¹å®ƒä»¬çš„å¼•ç”¨
mut p := unsafe { malloc(2) }
p[0] = `h` // é”™è¯¯ï¼šåªå…è®¸åœ¨ `unsafe` å—ä¸­è¿›è¡ŒæŒ‡é’ˆç´¢å¼•
unsafe {
    p[0] = `h` // æ­£ç¡®
    p[1] = `i`
}
p++ // é”™è¯¯ï¼šåªå…è®¸åœ¨ `unsafe` å—ä¸­è¿›è¡ŒæŒ‡é’ˆç®—æœ¯
unsafe {
    p++ // æ­£ç¡®
}
assert *p == `i`
```

æœ€ä½³å®è·µæ˜¯é¿å…å°†å†…å­˜å®‰å…¨è¡¨è¾¾å¼æ”¾åœ¨ `unsafe` å—å†…ï¼Œä»¥ä¾¿å°½å¯èƒ½æ¸…æ™°åœ°è¯´æ˜ä½¿ç”¨ `unsafe` çš„åŸå› ã€‚é€šå¸¸ï¼Œä»»ä½•æ‚¨è®¤ä¸ºæ˜¯å†…å­˜å®‰å…¨çš„ä»£ç éƒ½ä¸åº”è¯¥åœ¨ `unsafe` å—å†…ï¼Œä»¥ä¾¿ç¼–è¯‘å™¨å¯ä»¥éªŒè¯å®ƒã€‚

å¦‚æœæ‚¨æ€€ç–‘ç¨‹åºè¿åäº†å†…å­˜å®‰å…¨æ€§ï¼Œæ‚¨å¯ä»¥æå‰æ‰¾åˆ°åŸå› ï¼šæŸ¥çœ‹ `unsafe` å—ï¼ˆä»¥åŠå®ƒä»¬ä¸å‘¨å›´ä»£ç çš„äº¤äº’æ–¹å¼ï¼‰ã€‚

> **æ³¨æ„**
> è¿™æ˜¯ä¸€ä¸ªæ­£åœ¨è¿›è¡Œçš„å·¥ä½œã€‚

## å…·æœ‰å¼•ç”¨å­—æ®µçš„ç»“æ„ä½“

å…·æœ‰å¼•ç”¨çš„ç»“æ„ä½“éœ€è¦æ˜¾å¼å°†åˆå§‹å€¼è®¾ç½®ä¸ºå¼•ç”¨å€¼ï¼Œé™¤éç»“æ„ä½“å·²ç»å®šä¹‰äº†è‡ªå·±çš„åˆå§‹å€¼ã€‚

é›¶å€¼å¼•ç”¨ï¼Œæˆ–è€…è¯´ç©ºæŒ‡é’ˆï¼Œåœ¨æœªæ¥å°†**ä¸ä¼š**å¾—åˆ°æ”¯æŒï¼Œç›®å‰ä¾ç„¶å¯ä»¥ä½¿ç”¨å€¼ `0` çš„æ•°æ®ç»“æ„ï¼Œä¾‹å¦‚ä¾èµ–äºå¼•ç”¨å­—æ®µçš„é“¾è¡¨æˆ–äºŒå‰æ ‘ï¼Œä½†éœ€è¦äº†è§£å®ƒæ˜¯ä¸å®‰å…¨çš„ï¼Œå¹¶ä¸”å¯èƒ½ä¼šå¯¼è‡´ panicã€‚

```v
struct Node {
	a &Node
	b &Node = unsafe { nil } // è‡ªåŠ¨åˆå§‹åŒ–ä¸º nilï¼Œè°¨æ…ä½¿ç”¨ï¼
}

// å¼•ç”¨å­—æ®µå¿…é¡»åˆå§‹åŒ–ï¼Œé™¤éå£°æ˜äº†åˆå§‹å€¼ã€‚
// é›¶å€¼ (0) æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯è¦è°¨æ…ä½¿ç”¨ï¼Œå®ƒæ˜¯ä¸€ä¸ªç©ºæŒ‡é’ˆã€‚
foo := Node{
	a: 0
}
bar := Node{
	a: &foo
}
baz := Node{
	a: 0
	b: 0
}
qux := Node{
	a: &foo
	b: &bar
}
println(baz)
println(qux)
```

## sizeof å’Œ __offsetof

- `sizeof(Type)` ç»™å‡ºäº†ç±»å‹çš„å­—èŠ‚å¤§å°ã€‚
- `__offsetof(Struct, field_name)` ç»™å‡ºäº†ç»“æ„ä½“å­—æ®µçš„åç§»é‡ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚

```v
struct Foo {
	a int
	b int
}

assert sizeof(Foo) == 8
assert __offsetof(Foo, a) == 0
assert __offsetof(Foo, b) == 4
```

## æœ‰é™çš„è¿ç®—ç¬¦é‡è½½

è¿ç®—ç¬¦é‡è½½å®šä¹‰äº†æŸäº›ç±»å‹çš„ç‰¹å®šäºŒå…ƒè¿ç®—ç¬¦çš„è¡Œä¸ºã€‚

```v
struct Vec {
	x int
	y int
}

fn (a Vec) str() string {
	return '{${a.x}, ${a.y}}'
}

fn (a Vec) + (b Vec) Vec {
	return Vec{a.x + b.x, a.y + b.y}
}

fn (a Vec) - (b Vec) Vec {
	return Vec{a.x - b.x, a.y - b.y}
}

fn main() {
	a := Vec{2, 3}
	b := Vec{4, 5}
	mut c := Vec{1, 2}

	println(a + b) // "{6, 8}"
	println(a - b) // "{-2, -2}"
	c += a
	//^^ è‡ªåŠ¨ç”Ÿæˆè‡ª + é‡è½½
	println(c) // "{3, 5}"
}
```

> è¿ç®—ç¬¦é‡è½½è¿åäº† V çš„ç®€å•å’Œå¯é¢„æµ‹æ€§çš„å“²å­¦ã€‚
> ä½†ç”±äºç§‘å­¦å’Œå›¾å½¢åº”ç”¨æ˜¯ V çš„é¢†åŸŸä¹‹ä¸€ï¼Œ
> è¿ç®—ç¬¦é‡è½½æ˜¯ä¸€ä¸ªé‡è¦çš„åŠŸèƒ½ï¼Œä»¥æé«˜å¯è¯»æ€§ï¼š
>
> `a.add(b).add(c.mul(d))` æ¯” `a + b + c * d` éš¾ä»¥é˜…è¯»å¾—å¤šã€‚

å¯ä»¥å¯¹ä»¥ä¸‹äºŒå…ƒè¿ç®—ç¬¦è¿›è¡Œè¿ç®—ç¬¦é‡è½½ï¼š`+ï¼Œ-ï¼Œ*ï¼Œ/ï¼Œ%ï¼Œ<ï¼Œ==`ã€‚

### éšå¼ç”Ÿæˆçš„é‡è½½

- `==` ç”±ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆï¼Œä½†å¯ä»¥è¢«è¦†ç›–ã€‚

- `!=`ï¼Œ`>`ï¼Œ`<=` å’Œ `>=` åœ¨å®šä¹‰äº† `==` å’Œ `<` æ—¶ä¼šè‡ªåŠ¨ç”Ÿæˆã€‚
  å®ƒä»¬ä¸èƒ½è¢«æ˜¾å¼è¦†ç›–ã€‚
- èµ‹å€¼è¿ç®—ç¬¦ (`*=`, `+=`, `/=`, ç­‰) åœ¨ç›¸åº”çš„è¿ç®—ç¬¦è¢«å®šä¹‰ä¸”æ“ä½œæ•°å…·æœ‰ç›¸åŒç±»å‹æ—¶ä¼šè‡ªåŠ¨ç”Ÿæˆã€‚
  å®ƒä»¬ä¸èƒ½è¢«æ˜¾å¼è¦†ç›–ã€‚

### é™åˆ¶

ä¸ºäº†æé«˜å®‰å…¨æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œè¿ç®—ç¬¦é‡è½½å—åˆ°é™åˆ¶ã€‚

#### ç±»å‹é™åˆ¶

- åœ¨è¦†ç›– `<` å’Œ `==` æ—¶ï¼Œè¿”å›ç±»å‹å¿…é¡»ä¸¥æ ¼ä¸º `bool`ã€‚
- ä¸¤ä¸ªå‚æ•°å¿…é¡»å…·æœ‰ç›¸åŒçš„ç±»å‹ï¼ˆå°±åƒåœ¨ V çš„æ‰€æœ‰è¿ç®—ç¬¦ä¸­ä¸€æ ·ï¼‰ã€‚

#### å…¶ä»–é™åˆ¶

- ä¸å…è®¸åœ¨é‡è½½ä¸­æ›´æ”¹å‚æ•°ã€‚
- åœ¨è¿ç®—ç¬¦å‡½æ•°å†…éƒ¨è°ƒç”¨å…¶ä»–å‡½æ•°æ˜¯ä¸å…è®¸çš„ï¼ˆ**è®¡åˆ’ä¸­**ï¼‰ã€‚

## æ€§èƒ½è°ƒä¼˜



ç”Ÿæˆçš„ C ä»£ç é€šå¸¸åœ¨ä½¿ç”¨ `-prod` ç¼–è¯‘æ‚¨çš„ä»£ç æ—¶è¶³å¤Ÿå¿«ã€‚ç„¶è€Œï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‚¨å¯èƒ½å¸Œæœ›å‘ç¼–è¯‘å™¨æä¾›é¢å¤–çš„æç¤ºï¼Œä»¥ä¾¿å®ƒå¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–æŸäº›ä»£ç å—ã€‚

> **æ³¨æ„**
> è¿™äº›é€šå¸¸æ˜¯ *å¾ˆå°‘* éœ€è¦çš„ï¼Œå¹¶ä¸”é™¤éæ‚¨*åˆ†ææ‚¨çš„ä»£ç *ï¼Œç„¶åçœ‹åˆ°å¯¹å®ƒä»¬å­˜åœ¨é‡å¤§å¥½å¤„ï¼Œå¦åˆ™ä¸åº”ä½¿ç”¨å®ƒä»¬ã€‚
> æ­£å¦‚ gcc çš„æ–‡æ¡£æ‰€è¯´ï¼šâ€œç¨‹åºå‘˜åœ¨é¢„æµ‹ä»–ä»¬çš„ç¨‹åºå®é™…æ‰§è¡Œæ—¶é€šå¸¸åšå¾—å¾ˆç³Ÿç³•â€ã€‚

`[inline]` - æ‚¨å¯ä»¥å°†å‡½æ•°æ ‡è®°ä¸º `[inline]`ï¼Œä»¥ä¾¿ C ç¼–è¯‘å™¨å°è¯•å†…è”å®ƒä»¬ï¼Œè¿™åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½å¯¹æ€§èƒ½æœ‰åˆ©ï¼Œä½†å¯èƒ½ä¼šå½±å“å¯æ‰§è¡Œæ–‡ä»¶çš„å¤§å°ã€‚

`[direct_array_access]` - åœ¨æ ‡è®°ä¸º `[direct_array_access]` çš„å‡½æ•°ä¸­ï¼Œç¼–è¯‘å™¨å°†ç›´æ¥å°†æ•°ç»„æ“ä½œè½¬æ¢ä¸º C æ•°ç»„æ“ä½œ - çœç•¥è¾¹ç•Œæ£€æŸ¥ã€‚è¿™å¯èƒ½ä¼šåœ¨å‡½æ•°ä¸­èŠ‚çœå¤§é‡æ—¶é—´ï¼Œä½†ä»£ä»·æ˜¯ä½¿å‡½æ•°å˜å¾—ä¸å®‰å…¨ - é™¤éç”¨æˆ·å°†æ£€æŸ¥è¾¹ç•Œã€‚

`if _likely_(bool expression) {` è¿™å‘ C ç¼–è¯‘å™¨æš—ç¤ºä¼ é€’çš„å¸ƒå°”è¡¨è¾¾å¼éå¸¸å¯èƒ½ä¸º trueï¼Œå› æ­¤å®ƒå¯ä»¥ç”Ÿæˆå…·æœ‰è¾ƒä½çš„åˆ†æ”¯é¢„æµ‹é”™è¯¯æœºä¼šçš„æ±‡ç¼–ä»£ç ã€‚åœ¨ JS åç«¯ä¸­ï¼Œè¿™ä»€ä¹ˆä¹Ÿä¸åšã€‚

`if _unlikely_(bool expression) {` ç±»ä¼¼äº `_likely_(x)`ï¼Œä½†å®ƒæš—ç¤ºå¸ƒå°”è¡¨è¾¾å¼éå¸¸ä¸å¯èƒ½ä¸ºçœŸã€‚åœ¨ JS åç«¯ä¸­ï¼Œè¿™ä¹Ÿä»€ä¹ˆä¹Ÿä¸åšã€‚

### é€šè¿‡ä»£ç ç”Ÿæˆè¿›è¡Œåå°„

### å†…å­˜ä½¿ç”¨ä¼˜åŒ–

V æä¾›äº†ä¸å†…å­˜ä½¿ç”¨ç›¸å…³çš„ä»¥ä¸‹å±æ€§ï¼Œå¯åº”ç”¨äºç»“æ„ç±»å‹ï¼š`[packed]` å’Œ `[minify]`ã€‚è¿™äº›å±æ€§ä¼šå½±å“ç»“æ„çš„å†…å­˜å¸ƒå±€ï¼Œä»è€Œå¯èƒ½å‡å°‘ç¼“å­˜/å†…å­˜çš„ä½¿ç”¨ï¼Œå¹¶æé«˜æ€§èƒ½ã€‚

#### `[packed]`

å¯ä»¥å‘ç»“æ„æ·»åŠ  `[packed]` å±æ€§ï¼Œä»¥åˆ›å»ºä¸€ä¸ªä¸å¯¹é½çš„å†…å­˜å¸ƒå±€ï¼Œä»è€Œå‡å°ç»“æ„çš„æ•´ä½“å†…å­˜å ç”¨ã€‚

> **æ³¨æ„**
> åœ¨æŸäº› CPU æ¶æ„ä¸Šï¼Œä½¿ç”¨ [packed] å±æ€§å¯èƒ½ä¼šå¯¹æ€§èƒ½äº§ç”Ÿè´Ÿé¢å½±å“ï¼Œç”šè‡³å¯èƒ½ä¼šå—åˆ°ç¦æ­¢ã€‚
> ä»…å½“æœ€å°åŒ–å†…å­˜ä½¿ç”¨å¯¹æ‚¨çš„ç¨‹åºè‡³å…³é‡è¦å¹¶ä¸”æ‚¨æ„¿æ„ç‰ºç‰²æ€§èƒ½æ—¶æ‰ä½¿ç”¨æ­¤å±æ€§ã€‚

#### `[minify]`

å¯ä»¥å‘ç»“æ„æ·»åŠ  `[minify]` å±æ€§ï¼Œå…è®¸ç¼–è¯‘å™¨é‡æ–°æ’åˆ—å­—æ®µï¼Œä»¥æœ€å°åŒ–å†…éƒ¨é—´éš”ï¼ŒåŒæ—¶ä¿æŒå¯¹é½ã€‚

> **æ³¨æ„**
> ä½¿ç”¨ `[minify]` å±æ€§å¯èƒ½ä¼šå¯¼è‡´äºŒè¿›åˆ¶åºåˆ—åŒ–æˆ–åå°„æ–¹é¢å‡ºç°é—®é¢˜ã€‚
> åœ¨ä½¿ç”¨æ­¤å±æ€§æ—¶ï¼Œè¯·æ³¨æ„è¿™äº›æ½œåœ¨çš„å‰¯ä½œç”¨ã€‚

## åŸå­æ“ä½œï¼ˆAtomicsï¼‰

V æ²¡æœ‰å¯¹åŸå­æ“ä½œæä¾›ç‰¹æ®Šçš„æ”¯æŒï¼Œä½†å¯ä»¥é€šè¿‡åœ¨ V ä¸­è°ƒç”¨ C å‡½æ•°æ¥å°†å˜é‡è§†ä¸ºåŸå­æ“ä½œã€‚
é€šå¸¸æƒ…å†µä¸‹ï¼ŒC11 æ ‡å‡†çš„åŸå­æ“ä½œå‡½æ•°ï¼ˆå¦‚ `atomic_store()`ï¼‰é€šå¸¸æ˜¯ä½¿ç”¨å®å’Œ C ç¼–è¯‘å™¨æŠ€å·§æ¥å®šä¹‰çš„ï¼Œä»¥æä¾›ä¸€ç§*é‡è½½çš„ C å‡½æ•°*ã€‚

ç”±äº V æ•…æ„ä¸æ”¯æŒå‡½æ•°é‡è½½ï¼Œå› æ­¤åœ¨åä¸º `atomic.h` çš„ C å¤´æ–‡ä»¶ä¸­å®šä¹‰äº†è¿™äº›åŒ…è£…å‡½æ•°ï¼Œå®ƒä»¬æ˜¯ V ç¼–è¯‘å™¨åŸºç¡€è®¾æ–½çš„ä¸€éƒ¨åˆ†ã€‚

é’ˆå¯¹æ‰€æœ‰æ— ç¬¦å·æ•´æ•°ç±»å‹å’ŒæŒ‡é’ˆéƒ½æœ‰ä¸“ç”¨çš„åŒ…è£…å™¨ã€‚ï¼ˆåœ¨ Windows ä¸Šä¸å®Œå…¨æ”¯æŒ `u8`ï¼‰- å‡½æ•°åç§°åŒ…æ‹¬ç±»å‹åç§°ä½œä¸ºåç¼€ï¼Œä¾‹å¦‚ `C.atomic_load_ptr()` æˆ– `C.atomic_fetch_add_u64()`ã€‚

è¦ä½¿ç”¨è¿™äº›å‡½æ•°ï¼Œå¿…é¡»åŒ…å«æ‰€ä½¿ç”¨æ“ä½œç³»ç»Ÿçš„ C å¤´æ–‡ä»¶ï¼Œå¹¶å£°æ˜æ‰“ç®—ä½¿ç”¨çš„å‡½æ•°ã€‚ä¾‹å¦‚ï¼š

```v
$if windows {
	#include "@VEXEROOT/thirdparty/stdatomic/win/atomic.h"
} $else {
	#include "@VEXEROOT/thirdparty/stdatomic/nix/atomic.h"
}

// å£°æ˜æˆ‘ä»¬æƒ³è¦ä½¿ç”¨çš„å‡½æ•° - V ä¸è§£æ C å¤´æ–‡ä»¶
fn C.atomic_store_u32(&u32, u32)
fn C.atomic_load_u32(&u32) u32
fn C.atomic_compare_exchange_weak_u32(&u32, &u32, u32) bool
fn C.atomic_compare_exchange_strong_u32(&u32, &u32, u32) bool

const num_iterations = 10000000

// è¯·å‚è§ä¸‹é¢çš„â€œå…¨å±€å˜é‡â€éƒ¨åˆ†
__global (
	atom u32 // æ™®é€šå˜é‡ä½†ç”¨ä½œåŸå­å˜é‡
)

fn change() int {
	mut races_won_by_change := 0
	for {
		mut cmp := u32(17) // å¯å¯»å€çš„å€¼ï¼Œç”¨äºæ¯”è¾ƒå’Œå­˜å‚¨æ‰¾åˆ°çš„å€¼
		// `if atom == 17 { atom = 23 races_won_by_change++ } else { cmp = atom }` çš„åŸå­ç‰ˆæœ¬
		if C.atomic_compare_exchange_strong_u32(&atom, &cmp, 23) {
			races_won_by_change++
		} else {
			if cmp == 31 {
				break
			}
			cmp = 17 // é‡æ–°åˆ†é…ï¼Œå› ä¸ºè¢« atom çš„å€¼è¦†ç›–äº†
		}
	}
	return races_won_by_change
}

fn main() {
	C.atomic_store_u32(&atom, 17)
	t := spawn change()
	mut races_won_by_main := 0
	mut cmp17 := u32(17)
	mut cmp23 := u32(23)
	for i in 0 .. num_iterations {
		// `if atom == 17 { atom = 23 races_won_by_main++ }` çš„åŸå­ç‰ˆæœ¬
		if C.atomic_compare_exchange_strong_u32(&atom, &cmp17, 23) {
			races_won_by_main++
		} else {
			cmp17 = 17
		}
		desir := if i == num_iterations - 1 { u32(31) } else { u32(17) }
		// `for atom != 23 {} atom = desir` çš„åŸå­ç‰ˆæœ¬
		for !C.atomic_compare_exchange_weak_u32(&atom, &cmp23, desir) {
			cmp23 = 23
		}
	}
	races_won_by_change := t.wait()
	atom_new := C.atomic_load_u32(&atom)
	println('atom: ${atom_new}, #exchanges: ${races_won_by_main + races_won_by_change}')
	// æ‰“å° `atom: 31, #exchanges: 10000000`)
	println('races won by\n- `main()`: ${races_won_by_main}\n- `change()`: ${races_won_by_change}')
}
```

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œ`main()` å’Œç”Ÿæˆçš„çº¿ç¨‹ `change()` éƒ½å°è¯•ç”¨å€¼ `17` æ›¿æ¢å…¨å±€ `atom` ä¸­çš„å€¼ä¸º `23`ã€‚åæ–¹å‘çš„æ›¿æ¢ä¹Ÿä¼šåš 10000000 æ¬¡ã€‚æœ€åä¸€æ¬¡æ›¿æ¢å°†ä½¿ç”¨ `31` å®Œæˆï¼Œä»è€Œä½¿ç”Ÿæˆçš„çº¿ç¨‹ç»“æŸã€‚

æ— æ³•é¢„æµ‹å“ªä¸ªçº¿ç¨‹ä¼šå‘ç”Ÿå¤šå°‘æ¬¡æ›¿æ¢ï¼Œä½†æ€»å’Œå°†å§‹ç»ˆä¸º 10000000ã€‚ï¼ˆä½¿ç”¨æ³¨é‡Šä¸­çš„éåŸå­å‘½ä»¤ï¼Œè¯¥å€¼å°†æ›´é«˜æˆ–ç¨‹åºå°†æŒ‚èµ· - å–å†³äºæ‰€ä½¿ç”¨çš„ç¼–è¯‘å™¨ä¼˜åŒ–ã€‚ï¼‰

## å…¨å±€å˜é‡

é»˜è®¤æƒ…å†µä¸‹ï¼ŒV ä¸å…è®¸å…¨å±€å˜é‡ã€‚ç„¶è€Œï¼Œåœ¨ä½çº§åº”ç”¨ç¨‹åºä¸­ï¼Œå®ƒä»¬æ˜¯æœ‰ç”¨çš„ï¼Œå› æ­¤å¯ä»¥é€šè¿‡ç¼–è¯‘å™¨æ ‡å¿— `-enable-globals` å¯ç”¨å®ƒä»¬çš„ä½¿ç”¨ã€‚å…¨å±€å˜é‡çš„å£°æ˜å¿…é¡»ç”¨ `__global ( ... )` åŒ…å›´ï¼Œå°±åƒä¸Šé¢çš„ä¾‹å­ä¸­æ‰€ç¤ºã€‚

å…¨å±€å˜é‡çš„åˆå§‹åŒ–å™¨å¿…é¡»æ˜ç¡®è½¬æ¢ä¸ºæ‰€éœ€çš„ç›®æ ‡ç±»å‹ã€‚å¦‚æœæ²¡æœ‰æä¾›åˆå§‹åŒ–å™¨ï¼Œåˆ™ä¼šæ‰§è¡Œé»˜è®¤åˆå§‹åŒ–ã€‚æŸäº›å¯¹è±¡ï¼ˆå¦‚ä¿¡å·é‡å’Œäº’æ–¥é”ï¼‰éœ€è¦åœ¨ *ç°åœº* æ˜ç¡®åˆå§‹åŒ–ï¼Œå³ä¸ä½¿ç”¨ä»å‡½æ•°è°ƒç”¨è¿”å›çš„å€¼ï¼Œè€Œæ˜¯é€šè¿‡å¼•ç”¨è°ƒç”¨æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–ã€‚å¯ä»¥ä½¿ç”¨ä¸€ä¸ªå•ç‹¬çš„ `init()` å‡½æ•°æ¥å®ç°æ­¤ç›®çš„ - å®ƒå°†åœ¨ `main()` ä¹‹å‰è°ƒç”¨ï¼š

```v
import sync

__global (
	sem   sync.Semaphore // éœ€è¦åœ¨ `init()` ä¸­åˆå§‹åŒ–
	mtx   sync.RwMutex   // éœ€è¦åœ¨ `init()` ä¸­åˆå§‹åŒ–
	f1    = f64(34.0625)  // æ˜¾å¼åˆå§‹åŒ–
	shmap shared map[string]f64  // ä½œä¸ºç©ºçš„ `shared` map åˆå§‹åŒ–
	f2    f64             // åˆå§‹åŒ–ä¸º `0.0`
)

fn init() {
	sem.init(0)
	mtx.init()
}
```

è¯·æ³¨æ„ï¼Œåœ¨å¤šçº¿ç¨‹åº”ç”¨ç¨‹åºä¸­ï¼Œå¯¹å…¨å±€å˜é‡çš„è®¿é—®å—åˆ°ç«æ€æ¡ä»¶çš„å½±å“ã€‚æœ‰å‡ ç§æ–¹æ³•å¯ä»¥å¤„ç†è¿™äº›é—®é¢˜ï¼š

- å¯¹äºå˜é‡å£°æ˜ï¼Œè¯·ä½¿ç”¨ `shared` ç±»å‹å¹¶å¯¹è®¿é—®ä½¿ç”¨ `lock` å—ã€‚å¯¹äºè¾ƒå¤§çš„å¯¹è±¡ï¼ˆå¦‚ç»“æ„ä½“ã€æ•°ç»„æˆ–æ˜ å°„ï¼‰è¿™æ˜¯æœ€åˆé€‚çš„æ–¹æ³•ã€‚
- ä½¿ç”¨ç‰¹æ®Šçš„ C å‡½æ•°ï¼ˆå‚è§[ä¸Šæ–‡](#åŸå­)ï¼‰å°†åŸå§‹æ•°æ®ç±»å‹å¤„ç†ä¸ºâ€œåŸå­â€ã€‚
- ä½¿ç”¨æ˜¾å¼åŒæ­¥åŸè¯­ï¼ˆå¦‚äº’æ–¥é”ï¼‰æ¥æ§åˆ¶è®¿é—®ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨æ— æ³•çœŸæ­£å¸®åŠ©ï¼Œå› æ­¤ä½ å¿…é¡»çŸ¥é“ä½ åœ¨åšä»€ä¹ˆã€‚
- ä¸åœ¨ä¹ â€”â€” è¿™ç§æ–¹æ³•æ˜¯å¯èƒ½çš„ï¼Œä½†ä»…åœ¨å…¨å±€å˜é‡çš„ç¡®åˆ‡å€¼å¹¶ä¸çœŸçš„é‡è¦æ—¶æ‰æœ‰æ„ä¹‰ã€‚ä¾‹å¦‚ï¼Œ`rand` æ¨¡å—ä¸­å°±å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªä¾‹å­ï¼Œå…¶ä¸­å…¨å±€å˜é‡ç”¨äºç”Ÿæˆï¼ˆéå¯†ç å­¦ï¼‰ä¼ªéšæœºæ•°ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ•°æ®ç«äº‰å¯¼è‡´ä¸åŒçº¿ç¨‹ä¸­çš„éšæœºæ•°åœ¨æŸç§ç¨‹åº¦ä¸Šç›¸äº’å…³è”ï¼Œè€ƒè™‘åˆ°ä½¿ç”¨åŒæ­¥åŸè¯­ä¼šå¸¦æ¥çš„æ€§èƒ½æƒ©ç½šï¼Œè¿™æ˜¯å¯ä»¥æ¥å—çš„ã€‚

## äº¤å‰ç¼–è¯‘ï¼ˆCross Compilationï¼‰

è¦è¿›è¡Œäº¤å‰ç¼–è¯‘é¡¹ç›®ï¼Œåªéœ€è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```shell
v -os windows .
```

æˆ–è€…

```shell
v -os linux .
```

> **æ³¨æ„**
> åœ¨Linuxæœºå™¨ä¸Šè¿›è¡Œäº¤å‰ç¼–è¯‘WindowsäºŒè¿›åˆ¶æ–‡ä»¶éœ€è¦å…ˆå®‰è£…ç”¨äºMinGW-w64ï¼ˆé¢å‘Win64ï¼‰çš„GNU Cç¼–è¯‘å™¨ã€‚

å¯¹äºåŸºäºUbuntu/Debiançš„å‘è¡Œç‰ˆï¼š

```shell
sudo apt-get install gcc-mingw-w64-x86-64
```

å¯¹äºåŸºäºArchçš„å‘è¡Œç‰ˆï¼š

```shell
sudo pacman -S mingw-w64-gcc
```

ï¼ˆæš‚æ—¶æ— æ³•è¿›è¡ŒmacOSçš„äº¤å‰ç¼–è¯‘ã€‚ï¼‰

å¦‚æœä½ æ²¡æœ‰ä»»ä½•Cä¾èµ–é¡¹ï¼Œé‚£ä¹ˆè¿™å°±æ˜¯ä½ éœ€è¦åšçš„ä¸€åˆ‡ã€‚è¿™ç”šè‡³é€‚ç”¨äºä½¿ç”¨`ui`æ¨¡å—ç¼–è¯‘GUIåº”ç”¨ç¨‹åºæˆ–ä½¿ç”¨`gg`ç¼–è¯‘å›¾å½¢åº”ç”¨ç¨‹åºçš„æƒ…å†µã€‚

ä½ å°†éœ€è¦å®‰è£…Clangã€LLDé“¾æ¥å™¨ï¼Œå¹¶ä¸‹è½½ä¸€ä¸ªåŒ…å«Windowså’ŒLinuxåº“æ–‡ä»¶ä»¥åŠåŒ…å«æ–‡ä»¶çš„zipæ–‡ä»¶ã€‚Vä¼šæä¾›ç»™ä½ ä¸€ä¸ªé“¾æ¥ã€‚

## è°ƒè¯•ï¼ˆDebuggingï¼‰

### C åç«¯äºŒè¿›åˆ¶ï¼ˆé»˜è®¤ï¼‰

è¦è°ƒè¯•ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆæ ‡å¿—ï¼š`-b c`ï¼‰ï¼Œä½ å¯ä»¥ä¼ é€’ä»¥ä¸‹æ ‡å¿—ï¼š

- `-g` - ç”Ÿæˆä¸€ä¸ªå¸¦æœ‰æ›´å¤šè°ƒè¯•ä¿¡æ¯çš„ä¼˜åŒ–ç¨‹åº¦è¾ƒä½çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚Vä¼šåœ¨panicæ—¶äº§ç”Ÿçš„å †æ ˆè·Ÿè¸ªä¸­å¼ºåˆ¶æ‰§è¡Œæ¥è‡ª.væ–‡ä»¶çš„è¡Œå·ã€‚é€šå¸¸æœ€å¥½ä¼ é€’`-g`ï¼Œé™¤éä½ æ­£åœ¨ç¼–å†™åº•å±‚ä»£ç ï¼Œæ­¤æ—¶è¯·ä½¿ç”¨ä¸‹ä¸€ä¸ªé€‰é¡¹`-cg`ã€‚
- `-cg` - ç”Ÿæˆä¸€ä¸ªå¸¦æœ‰æ›´å¤šè°ƒè¯•ä¿¡æ¯çš„ä¼˜åŒ–ç¨‹åº¦è¾ƒä½çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯æ‰§è¡Œæ–‡ä»¶å°†ä½¿ç”¨Cæºä»£ç çš„è¡Œå·ã€‚å®ƒé€šå¸¸ä¸`-keepc`ä¸€èµ·ä½¿ç”¨ï¼Œè¿™æ ·ä½ å¯ä»¥åœ¨panicæ—¶æ£€æŸ¥ç”Ÿæˆçš„Cç¨‹åºï¼Œæˆ–è€…ä½¿ä½ çš„è°ƒè¯•å™¨ï¼ˆ`gdb`ã€`lldb`ç­‰ï¼‰èƒ½å¤Ÿæ˜¾ç¤ºç”Ÿæˆçš„Cæºä»£ç ã€‚
- `-showcc` - æ‰“å°ç”¨äºæ„å»ºç¨‹åºçš„Cå‘½ä»¤ã€‚
- `-show-c-output` - æ‰“å°åœ¨ç¼–è¯‘ç¨‹åºæ—¶ä½ çš„Cç¼–è¯‘å™¨äº§ç”Ÿçš„è¾“å‡ºã€‚
- `-keepc` - åœ¨æˆåŠŸç¼–è¯‘åä¸è¦åˆ é™¤ç”Ÿæˆçš„Cæºä»£ç æ–‡ä»¶ã€‚ä¹Ÿä¿æŒä½¿ç”¨ç›¸åŒçš„æ–‡ä»¶è·¯å¾„ï¼Œè¿™æ ·æ›´ç¨³å®šï¼Œæ›´å®¹æ˜“åœ¨ç¼–è¾‘å™¨/IDEä¸­ä¿æŒæ‰“å¼€ã€‚

å¦‚æœä½ æ­£åœ¨ä¸ºç°æœ‰çš„Cåº“ç¼–å†™ä¸€ä¸ªåº•å±‚çš„åŒ…è£…å™¨ï¼Œä¸ºäº†è·å¾—æœ€ä½³çš„è°ƒè¯•ä½“éªŒï¼Œä½ å¯ä»¥åŒæ—¶ä¼ é€’è¿™äº›æ ‡å¿—ï¼š`v -keepc -cg -showcc yourprogram.v`ï¼Œç„¶ååªéœ€åœ¨ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶`yourprogram`ä¸Šè¿è¡Œè°ƒè¯•å™¨ï¼ˆgdb/lldbï¼‰æˆ–IDEã€‚

å¦‚æœä½ åªæƒ³æ£€æŸ¥ç”Ÿæˆçš„Cä»£ç ï¼Œè€Œä¸è¿›è¡Œè¿›ä¸€æ­¥çš„ç¼–è¯‘ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨`-o`æ ‡å¿—ï¼ˆä¾‹å¦‚`-o file.c`ï¼‰ã€‚è¿™å°†ä½¿Vç”Ÿæˆ`file.c`ç„¶ååœæ­¢ã€‚

å¦‚æœä½ æƒ³æŸ¥çœ‹ä»…é’ˆå¯¹å•ä¸ªCå‡½æ•°ï¼ˆä¾‹å¦‚`main`ï¼‰ç”Ÿæˆçš„Cæºä»£ç ï¼Œä½ å¯ä»¥ä½¿ç”¨ï¼š`-printfn main -o file.c`ã€‚

è¦è°ƒè¯•Vå¯æ‰§è¡Œæ–‡ä»¶æœ¬èº«ï¼Œä½ éœ€è¦ä»srcä¸­è¿›è¡Œç¼–è¯‘ï¼Œä½¿ç”¨ `./v -g -o v cmd/v`ã€‚

ä½ å¯ä»¥ä½¿ç”¨ä¾‹å¦‚ `v -g -keepc prog_test.v` æ¥è°ƒè¯•æµ‹è¯•ã€‚éœ€è¦ä½¿ç”¨ `-keepc` æ ‡å¿—ï¼Œä»¥ä¾¿åœ¨åˆ›å»ºå¹¶è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶åï¼Œå®ƒä¸ä¼šè¢«åˆ é™¤ã€‚

è¦æŸ¥çœ‹Væ”¯æŒçš„æ‰€æœ‰æ ‡å¿—çš„è¯¦ç»†åˆ—è¡¨ï¼Œè¯·ä½¿ç”¨ `v help`ï¼Œ`v help build` å’Œ `v help build-c`ã€‚

**å‘½ä»¤è¡Œè°ƒè¯•**

1. ä½¿ç”¨è°ƒè¯•ä¿¡æ¯ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶ `v -g hello.v`
2. ä½¿ç”¨ [lldb](https://lldb.llvm.org) æˆ– [GDB](https://www.gnu.org/software/gdb/) è¿›è¡Œè°ƒè¯•ï¼Œä¾‹å¦‚ `lldb hello`

[åœ¨GDBä¸­è°ƒè¯•ç”±Våˆ›å»ºçš„å¯æ‰§è¡Œæ–‡ä»¶æ—¶çš„æ•…éšœæ’é™¤ï¼ˆè°ƒè¯•ï¼‰](https://github.com/vlang/v/wiki/Troubleshooting-(debugging)-executables-created-with-V-in-GDB)

**å¯è§†åŒ–è°ƒè¯•è®¾ç½®:**

* [Visual Studio Code](vscode.md)

### æœ¬åœ°åç«¯äºŒè¿›åˆ¶

ç›®å‰ï¼Œå¯¹äºç”±æœ¬åœ°åç«¯ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆæ ‡å¿—ï¼š`-b native`ï¼‰ï¼Œä¸æä¾›è°ƒè¯•æ”¯æŒã€‚

### JavaScript åç«¯

è¦è°ƒè¯•ç”Ÿæˆçš„ JavaScript è¾“å‡ºï¼Œä½ å¯ä»¥æ¿€æ´»æºæ˜ å°„ï¼š
`v -b js -sourcemap hello.v -o hello.js`

æŸ¥çœ‹æ‰€æœ‰æ”¯æŒçš„é€‰é¡¹ï¼Œè¯·æŸ¥çœ‹æœ€æ–°çš„å¸®åŠ©ï¼š
`v help build-js`

## V and C

### ä»Vè°ƒç”¨C

**ç¤ºä¾‹**

```v
#flag -lsqlite3
#include "sqlite3.h"
// å‚è§ https://www.sqlite.org/quickstart.html ä¸­çš„ç¤ºä¾‹
struct C.sqlite3 {
}

struct C.sqlite3_stmt {
}

type FnSqlite3Callback = fn (voidptr, int, &&char, &&char) int

fn C.sqlite3_open(&char, &&C.sqlite3) int

fn C.sqlite3_close(&C.sqlite3) int

fn C.sqlite3_column_int(stmt &C.sqlite3_stmt, n int) int

// ... ä½ ä¹Ÿå¯ä»¥åªå®šä¹‰å‚æ•°çš„ç±»å‹è€Œçœç•¥C.å‰ç¼€

fn C.sqlite3_prepare_v2(&C.sqlite3, &char, int, &&C.sqlite3_stmt, &&char) int

fn C.sqlite3_step(&C.sqlite3_stmt)

fn C.sqlite3_finalize(&C.sqlite3_stmt)

fn C.sqlite3_exec(db &C.sqlite3, sql &char, cb FnSqlite3Callback, cb_arg voidptr, emsg &&char) int

fn C.sqlite3_free(voidptr)

fn my_callback(arg voidptr, howmany int, cvalues &&char, cnames &&char) int {
	unsafe {
		for i in 0 .. howmany {
			print('| ${cstring_to_vstring(cnames[i])}: ${cstring_to_vstring(cvalues[i]):20} ')
		}
	}
	println('|')
	return 0
}

fn main() {
	db := &C.sqlite3(unsafe { nil }) // è¿™è¡¨ç¤º `sqlite3* db = 0`
	// å°†å­—ç¬¦ä¸²æ–‡å­—ä¼ é€’ç»™Cå‡½æ•°è°ƒç”¨å°†å¾—åˆ°Cå­—ç¬¦ä¸²ï¼Œè€Œä¸æ˜¯Vå­—ç¬¦ä¸²
	C.sqlite3_open(c'users.db', &db)
	// C.sqlite3_open(db_path.str, &db)
	query := 'select count(*) from users'
	stmt := &C.sqlite3_stmt(unsafe { nil })
	// æ³¨æ„ï¼šä½ ä¹Ÿå¯ä»¥ä½¿ç”¨Vå­—ç¬¦ä¸²çš„`.str`å­—æ®µï¼Œ
	// ä»¥è·å–å…¶Cé£æ ¼çš„é›¶ç»ˆæ­¢è¡¨ç¤º
	C.sqlite3_prepare_v2(db, &char(query.str), -1, &stmt, 0)
	C.sqlite3_step(stmt)
	nr_users := C.sqlite3_column_int(stmt, 0)
	C.sqlite3_finalize(stmt)
	println('æ•°æ®åº“ä¸­æœ‰ ${nr_users} ä¸ªç”¨æˆ·ã€‚')
	//
	error_msg := &char(0)
	query_all_users := 'select * from users'
	rc := C.sqlite3_exec(db, &char(query_all_users.str), my_callback, voidptr(7), &error_msg)
	if rc != C.SQLITE_OK {
		eprintln(unsafe { cstring_to_vstring(error_msg) })
		C.sqlite3_free(error_msg)
	}
	C.sqlite3_close(db)
}
```

### ä»Cè°ƒç”¨V

ç”±äºVå¯ä»¥ç¼–è¯‘ä¸ºCï¼Œæ‰€ä»¥è°ƒç”¨Vä»£ç ä»Cä¸­éå¸¸å®¹æ˜“ï¼Œä¸€æ—¦ä½ çŸ¥é“äº†å¦‚ä½•åšã€‚

ä½¿ç”¨ `v -o file.c your_file.v` ç”Ÿæˆä¸€ä¸ªå¯¹åº”äºVä»£ç çš„Cæ–‡ä»¶ã€‚

æ›´å¤šè¯¦æƒ…å‚è§ [call_v_from_c example](../examples/call_v_from_c)ã€‚

### ä¼ é€’Cç¼–è¯‘flag

åœ¨Væ–‡ä»¶çš„é¡¶éƒ¨æ·»åŠ  `#flag` æŒ‡ä»¤ä»¥æä¾›Cç¼–è¯‘æ ‡å¿—ï¼Œå¦‚ï¼š

- `-I` ç”¨äºæ·»åŠ CåŒ…å«æ–‡ä»¶æœç´¢è·¯å¾„
- `-l` ç”¨äºæ·»åŠ è¦é“¾æ¥çš„Cåº“åç§°
- `-L` ç”¨äºæ·»åŠ Cåº“æ–‡ä»¶æœç´¢è·¯å¾„
- `-D` ç”¨äºè®¾ç½®ç¼–è¯‘æ—¶å˜é‡

ä½ å¯ä»¥ï¼ˆå¯é€‰åœ°ï¼‰ä¸ºä¸åŒçš„ç›®æ ‡ä½¿ç”¨ä¸åŒçš„æ ‡å¿—ã€‚
ç›®å‰æ”¯æŒ `linux`, `darwin`, `freebsd`, å’Œ `windows` æ ‡å¿—ã€‚

> **æ³¨æ„**
> æ¯ä¸ªæ ‡å¿—å¿…é¡»å•ç‹¬å ä¸€è¡Œï¼ˆæš‚æ—¶å¦‚æ­¤ï¼‰

```v oksyntax
#flag linux -lsdl2
#flag linux -Ivig
#flag linux -DCIMGUI_DEFINE_ENUMS_AND_STRUCTS=1
#flag linux -DIMGUI_DISABLE_OBSOLETE_FUNCTIONS=1
#flag linux -DIMGUI_IMPL_API=
```

åœ¨æ§åˆ¶å°æ„å»ºå‘½ä»¤ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ï¼š

- `-cc` æ¥æ›´æ”¹é»˜è®¤çš„Cåç«¯ç¼–è¯‘å™¨ã€‚
- `-cflags` ä¼ é€’è‡ªå®šä¹‰æ ‡å¿—ç»™åç«¯Cç¼–è¯‘å™¨ï¼ˆåœ¨å…¶ä»–Cé€‰é¡¹ä¹‹å‰ä¼ é€’ï¼‰ã€‚
- `-ldflags` ä¼ é€’è‡ªå®šä¹‰æ ‡å¿—ç»™åç«¯Cé“¾æ¥å™¨ï¼ˆåœ¨å…¶ä»–Cé€‰é¡¹ä¹‹åä¼ é€’ï¼‰ã€‚
- ä¾‹å¦‚ï¼š`-cc gcc-9 -cflags -fsanitize=thread`ã€‚

ä½ å¯ä»¥åœ¨ç»ˆç«¯ä¸­å®šä¹‰ä¸€ä¸ª `VFLAGS` ç¯å¢ƒå˜é‡æ¥å­˜å‚¨ä½ çš„ `-cc` å’Œ `-cflags` è®¾ç½®ï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½åœ¨æ„å»ºå‘½ä»¤ä¸­åŒ…å«å®ƒä»¬ã€‚

### #pkgconfig

æ·»åŠ  `#pkgconfig` æŒ‡ä»¤ç”¨äºå‘Šè¯‰ç¼–è¯‘å™¨åº”è¯¥ä½¿ç”¨å“ªäº›æ¨¡å—æ¥è¿›è¡Œç¼–è¯‘å’Œé“¾æ¥ï¼Œä½¿ç”¨ç›¸åº”ä¾èµ–å…³ç³»æä¾›çš„ pkg-config æ–‡ä»¶ã€‚

ç”±äºåœ¨ `#flag` ä¸­ä¸èƒ½ä½¿ç”¨åå¼•å·ï¼Œå¹¶ä¸”å‡ºäºå®‰å…¨å’Œå¯ç§»æ¤æ€§åŸå› ä¸å¸Œæœ›ç”Ÿæˆè¿›ç¨‹ï¼ŒVä½¿ç”¨äº†è‡ªå·±çš„pkgconfigåº“ï¼Œå®ƒä¸æ ‡å‡†çš„freedesktopåº“å…¼å®¹ã€‚

å¦‚æœæ²¡æœ‰ä¼ é€’æ ‡å¿—ï¼Œå®ƒå°†å‘ pkgconfig æ·»åŠ  `--cflags` å’Œ `--libs` ï¼ˆè€Œä¸æ˜¯Vï¼‰ã€‚
æ¢å¥è¯è¯´ï¼Œä¸‹é¢çš„ä¸¤è¡Œä»£ç åšçš„æ˜¯ä¸€æ ·çš„ï¼š

```v oksyntax
#pkgconfig r_core
#pkgconfig --cflags --libs r_core
```

ä¼šåœ¨ä¸€ä¸ªç¡¬ç¼–ç çš„é»˜è®¤pkg-configè·¯å¾„åˆ—è¡¨ä¸­æŸ¥æ‰¾ `.pc` æ–‡ä»¶ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ä½¿ç”¨ `PKG_CONFIG_PATH` ç¯å¢ƒå˜é‡æ·»åŠ é¢å¤–çš„è·¯å¾„ã€‚å¯ä»¥ä¼ é€’å¤šä¸ªæ¨¡å—ã€‚

è¦æ£€æŸ¥pkg-configæ˜¯å¦å­˜åœ¨ï¼Œå¯ä»¥å°† `$pkgconfig('pkg')` ä½œä¸ºä¸€ä¸ªç¼–è¯‘æ—¶çš„â€œifâ€æ¡ä»¶æ¥ä½¿ç”¨ï¼Œä»¥æ£€æŸ¥pkg-configæ˜¯å¦å­˜åœ¨ã€‚å¦‚æœå­˜åœ¨ï¼Œå°†åˆ›å»ºåˆ†æ”¯ã€‚å¯ä»¥ä½¿ç”¨ `$else` æˆ– `$else $if` æ¥å¤„ç†å…¶ä»–æƒ…å†µã€‚

```v ignore
$if $pkgconfig('mysqlclient') {
	#pkgconfig mysqlclient
} $else $if $pkgconfig('mariadb') {
	#pkgconfig mariadb
}
```

### åŒ…å«Cä»£ç 

ä½ ä¹Ÿå¯ä»¥ç›´æ¥åœ¨ä½ çš„Væ¨¡å—ä¸­åŒ…å«Cä»£ç ã€‚
ä¾‹å¦‚ï¼Œå‡è®¾ä½ çš„Cä»£ç ä½äºæ¨¡å—æ–‡ä»¶å¤¹å†…åä¸º 'c' çš„æ–‡ä»¶å¤¹ä¸­ã€‚ç„¶åï¼š

- åœ¨ä½ çš„æ¨¡å—é¡¶å±‚æ–‡ä»¶å¤¹ä¸­

æ”¾ç½®ä¸€ä¸ªåä¸º `v.mod` çš„æ–‡ä»¶ï¼ˆå¦‚æœä½ ç”¨ `v new` åˆ›å»ºäº†ä½ çš„æ¨¡å—ï¼Œä½ å·²ç»æœ‰äº† `v.mod` æ–‡ä»¶ï¼‰ã€‚ä¾‹å¦‚ï¼š

```v ignore
Module {
	name: 'mymodule',
	description: 'æˆ‘çš„æ¨¡å—å°è£…äº†ä¸€ä¸ªç®€å•çš„Cåº“ã€‚',
	version: '0.0.1'
	dependencies: []
}
```

- åœ¨ä½ çš„æ¨¡å—é¡¶éƒ¨æ·»åŠ ä»¥ä¸‹è¡Œï¼š

```v oksyntax
#flag -I @VMODROOT/c
#flag @VMODROOT/c/implementation.o
#include "header.h"
```

> **æ³¨æ„**
> @VMODROOT å°†è¢«Væ›¿æ¢ä¸º*æœ€è¿‘çš„çˆ¶æ–‡ä»¶å¤¹ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ª v.mod æ–‡ä»¶*ã€‚
> ä»»ä½•ä¸v.modæ–‡ä»¶æ‰€åœ¨çš„æ–‡ä»¶å¤¹ç›¸é‚»æˆ–åœ¨å…¶ä¸‹é¢çš„.væ–‡ä»¶ï¼Œéƒ½å¯ä»¥ä½¿ç”¨ `#flag @VMODROOT/abc` æ¥å¼•ç”¨æ­¤æ–‡ä»¶å¤¹ã€‚
> @VMODROOT æ–‡ä»¶å¤¹ä¹Ÿä¼šè¢«*æ·»åŠ åˆ°æ¨¡å—æŸ¥æ‰¾è·¯å¾„çš„å‰é¢*ï¼Œå› æ­¤ä½ å¯ä»¥é€šè¿‡åªå‘½åå®ƒä»¬æ¥*å¯¼å…¥*@VMODROOTä¸‹çš„å…¶ä»–æ¨¡å—ã€‚

ä»¥ä¸Šçš„æŒ‡ä»¤ä¼šè®©Våœ¨ä½ çš„æ¨¡å—æ–‡ä»¶å¤¹ä¸­æŸ¥æ‰¾ä¸€ä¸ªå·²ç¼–è¯‘çš„ .o æ–‡ä»¶ã€‚
å¦‚æœVæ‰¾åˆ°äº†å®ƒï¼Œé‚£ä¹ˆè¯¥ .o æ–‡ä»¶å°†ä¼šé“¾æ¥åˆ°ä½¿ç”¨è¯¥æ¨¡å—çš„ä¸»å¯æ‰§è¡Œæ–‡ä»¶ä¸­ã€‚
å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼ŒVå°†å‡è®¾å­˜åœ¨ä¸€ä¸ª `@VMODROOT/c/implementation.c` æ–‡ä»¶ï¼Œå¹¶å°è¯•å°†å…¶ç¼–è¯‘æˆ .o æ–‡ä»¶ï¼Œç„¶åå°†ä½¿ç”¨å®ƒã€‚

è¿™å…è®¸ä½ åœ¨Væ¨¡å—ä¸­åŒ…å«Cä»£ç ï¼Œä»¥ä¾¿æ›´å®¹æ˜“åœ°è¿›è¡Œåˆ†å‘ã€‚
ä½ å¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹ä¸€ä¸ªå®Œæ•´çš„ä½¿ç”¨Cä»£ç çš„VåŒ…è£…æ¨¡å—çš„æœ€å°ç¤ºä¾‹ï¼š
[project_with_c_code](https://github.com/vlang/v/tree/master/vlib/v/tests/project_with_c_code)ã€‚
å¦ä¸€ä¸ªç¤ºä¾‹æ¼”ç¤ºäº†å¦‚ä½•åœ¨Cå’ŒVä¹‹é—´ä¼ é€’ç»“æ„ä½“ï¼š
[interoperate between C to V to C](https://github.com/vlang/v/tree/master/vlib/v/tests/project_with_c_code_2)ã€‚

### Cç±»å‹

æ™®é€šçš„é›¶ç»ˆæ­¢Cå­—ç¬¦ä¸²å¯ä»¥é€šè¿‡ `unsafe { &char(cstring).vstring() }` æˆ–è€…å¦‚æœä½ å·²ç»çŸ¥é“å®ƒä»¬çš„é•¿åº¦å¯ä»¥ç”¨ `unsafe { &char(cstring).vstring_with_len(len) }` è½¬æ¢ä¸ºVå­—ç¬¦ä¸²ã€‚

> **æ³¨æ„**
> `.vstring()` å’Œ `.vstring_with_len()` æ–¹æ³•å¹¶ä¸ä¼šåˆ›å»º `cstring` çš„å‰¯æœ¬ï¼Œæ‰€ä»¥åœ¨è°ƒç”¨å®Œ `.vstring()` æ–¹æ³•åä¸åº”è¯¥é‡Šæ”¾å®ƒã€‚
> å¦‚æœä½ éœ€è¦å¤åˆ¶Cå­—ç¬¦ä¸²ï¼ˆä¸€äº›libc APIï¼ˆå¦‚ `getenv`ï¼‰å‡ ä¹è¦æ±‚å¦‚æ­¤ï¼Œå› ä¸ºå®ƒä»¬è¿”å›æŒ‡å‘å†…éƒ¨libcå†…å­˜çš„æŒ‡é’ˆï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ `cstring_to_vstring(cstring)`ã€‚

åœ¨Windowsä¸Šï¼ŒC APIé€šå¸¸è¿”å›æ‰€è°“çš„`wide`å­—ç¬¦ä¸²ï¼ˆutf16ç¼–ç ï¼‰ã€‚å¯ä»¥ä½¿ç”¨ `string_from_wide(&u16(cwidestring))` å°†å…¶è½¬æ¢ä¸ºVå­—ç¬¦ä¸²ã€‚

Væ‹¥æœ‰ä»¥ä¸‹ç±»å‹ï¼Œä»¥ä¾¿ä¸Cæ›´è½»æ¾åœ°è¿›è¡Œäº¤äº’ï¼š

- `voidptr` ç”¨äºCçš„ `void*`ï¼Œ
- `&u8` ç”¨äºCçš„ `byte*`ï¼Œ
- `&char` ç”¨äºCçš„ `char*`ï¼Œ
- `&&char` ç”¨äºCçš„ `char**`ã€‚

è¦å°† `voidptr` è½¬æ¢ä¸ºVå¼•ç”¨ï¼Œè¯·ä½¿ç”¨ `user := &User(user_void_ptr)`ã€‚

`voidptr` ä¹Ÿå¯ä»¥é€šè¿‡ç±»å‹è½¬æ¢è§£å¼•ç”¨ä¸ºVç»“æ„ä½“ï¼š`user := User(user_void_ptr)`ã€‚

[ä¸€ä¸ªä»Vè°ƒç”¨Cä»£ç çš„æ¨¡å—çš„ç¤ºä¾‹](https://github.com/vlang/v/blob/master/vlib/v/tests/project_with_c_code/mod1/wrapper.v)

### Cå£°æ˜

Cæ ‡è¯†ç¬¦å¯ä»¥é€šè¿‡ä¸æ¨¡å—ç‰¹å®šæ ‡è¯†ç¬¦ç±»ä¼¼çš„æ–¹å¼è®¿é—®ï¼Œå‡½æ•°å¿…é¡»åœ¨ä½¿ç”¨ä¹‹å‰åœ¨Vä¸­é‡æ–°å£°æ˜ã€‚å¯ä»¥åœ¨Cçš„ `C` å‰ç¼€åé¢ä½¿ç”¨ä»»ä½•Cç±»å‹ï¼Œä½†æ˜¯å¿…é¡»åœ¨Vä¸­é‡æ–°å£°æ˜ç±»å‹æ‰èƒ½è®¿é—®ç±»å‹æˆå‘˜ã€‚

è¦é‡æ–°å£°æ˜å¤æ‚ç±»å‹ï¼Œä¾‹å¦‚ä»¥ä¸‹Cä»£ç ï¼š

```c
struct SomeCStruct {
	uint8_t implTraits;
	uint16_t memPoolData;
	union {
		struct {
			void* data;
			size_t size;
		};

		DataView view;
	};
};
```

å­æ•°æ®ç»“æ„çš„æˆå‘˜å¯ä»¥ç›´æ¥åœ¨åŒ…å«ç»“æ„ä¸­å£°æ˜ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```v
struct C.SomeCStruct {
	implTraits  u8
	memPoolData u16
	// è¿™äº›æˆå‘˜å±äºå½“å‰æ— æ³•åœ¨Vä¸­å®Œå…¨è¡¨ç¤ºçš„å­æ•°æ®ç»“æ„ã€‚
	// ç›´æ¥åƒè¿™æ ·å£°æ˜å®ƒä»¬å°±è¶³ä»¥è®¿é—®ã€‚
	// union {
	// struct {
	data voidptr
	size usize
	// }
	view C.DataView
	// }
}
```

æ•°æ®æˆå‘˜çš„å­˜åœ¨å¯¹Væ˜¯å·²çŸ¥çš„ï¼Œå¯ä»¥åœ¨ä¸é‡æ–°åˆ›å»ºåŸå§‹ç»“æ„çš„æƒ…å†µä¸‹ä½¿ç”¨å®ƒä»¬ã€‚

æˆ–è€…ï¼Œä½ å¯ä»¥[åµŒå…¥](#åµŒå…¥ç»“æ„)å­æ•°æ®ç»“æ„ä»¥ä¿æŒå¹¶è¡Œä»£ç ç»“æ„ã€‚

### å¯¼å‡ºåˆ°å…±äº«åº“

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰Vå‡½æ•°åœ¨Cä¸­çš„å‘½åæ–¹æ¡ˆå¦‚ä¸‹ï¼š`[æ¨¡å—å]__[å‡½æ•°å]`ã€‚

ä¾‹å¦‚ï¼Œæ¨¡å—`bar`ä¸­çš„ `fn foo() {}` å°†å¯¼è‡´ `bar__foo()`ã€‚

è¦ä½¿ç”¨è‡ªå®šä¹‰å¯¼å‡ºåç§°ï¼Œè¯·ä½¿ç”¨ `[export]` å±æ€§ï¼š

```v
[export: 'my_custom_c_name']
fn foo() {
}
```

### å°†Cè½¬æ¢ä¸ºV

Vå¯ä»¥å°†æ‚¨çš„Cä»£ç è½¬æ¢ä¸ºå¯è¯»çš„Vä»£ç ï¼Œå¹¶åœ¨Cåº“ä¹‹ä¸Šç”ŸæˆVåŒ…è£…å™¨ã€‚

C2Vå½“å‰ä½¿ç”¨Clangçš„ASTæ¥ç”ŸæˆVä»£ç ï¼Œå› æ­¤è¦å°†Cæ–‡ä»¶è½¬æ¢ä¸ºVï¼Œä½ éœ€è¦åœ¨ä½ çš„æœºå™¨ä¸Šå®‰è£…Clangã€‚

è®©æˆ‘ä»¬é¦–å…ˆåˆ›å»ºä¸€ä¸ªç®€å•çš„ç¨‹åº `test.c`ï¼š

```c
#include "stdio.h"

int main() {
	for (int i = 0; i < 10; i++) {
		printf("hello world\n");
	}
        return 0;
}
```

è¿è¡Œ `v translate test.c`ï¼ŒVå°†ä¼šç”Ÿæˆ `test.v`ï¼š

```v
fn main() {
	for i := 0; i < 10; i++ {
		println('hello world')
	}
}
```

è¦åœ¨Cåº“ä¹‹ä¸Šç”Ÿæˆä¸€ä¸ªåŒ…è£…å™¨ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```bash
v translate wrapper c_code/libsodium/src/libsodium
```

è¿™å°†ç”Ÿæˆä¸€ä¸ªåä¸º `libsodium` çš„ç›®å½•ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªVæ¨¡å—ã€‚

ä¸€ä¸ªç”±C2Vç”Ÿæˆçš„libsodiumåŒ…è£…å™¨çš„ç¤ºä¾‹ï¼š

[https://github.com/vlang/libsodium](https://github.com/vlang/libsodium)

<br>

ä½•æ—¶åº”è¯¥å°†Cä»£ç è½¬æ¢ä¸ºVï¼Œä½•æ—¶åº”è¯¥åªæ˜¯ä»Vè°ƒç”¨Cä»£ç ï¼Ÿ

å¦‚æœä½ æœ‰ä¸€ä¸ªç¼–å†™è‰¯å¥½ã€ç»è¿‡è‰¯å¥½æµ‹è¯•çš„Cä»£ç ï¼Œ
é‚£ä¹ˆå½“ç„¶ä½ å¯ä»¥éšæ—¶ä»Vä¸­è°ƒç”¨è¿™æ®µCä»£ç ã€‚

å°†å…¶è½¬æ¢ä¸ºVä¼šç»™ä½ å¸¦æ¥å‡ ä¸ªä¼˜ç‚¹ï¼š

- å¦‚æœä½ è®¡åˆ’å¼€å‘è¯¥ä»£ç åº“ï¼Œç°åœ¨ä½ æ‹¥æœ‰äº†ä¸€ä¸ªè¯­è¨€ä¸­çš„æ‰€æœ‰å†…å®¹ï¼Œè¿™æ¯”Cæ›´å®‰å…¨ä¸”æ›´å®¹æ˜“å¼€å‘ã€‚
- äº¤å‰ç¼–è¯‘å˜å¾—æ›´å®¹æ˜“ã€‚ä½ å®Œå…¨ä¸å¿…æ‹…å¿ƒå®ƒã€‚
- ä¹Ÿä¸å†éœ€è¦æ„å»ºæ ‡å¿—å’ŒåŒ…å«æ–‡ä»¶ã€‚

### è§£å†³Cé—®é¢˜

åœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒCäº’æ“ä½œå¯èƒ½éå¸¸å›°éš¾ã€‚
å…¶ä¸­ä¹‹ä¸€æ˜¯å½“å¤´æ–‡ä»¶ç›¸äº’å†²çªæ—¶ã€‚
ä¾‹å¦‚ï¼ŒVéœ€è¦åŒ…å«Windowså¤´æ–‡ä»¶åº“ï¼Œä»¥ä¾¿æ‚¨çš„VäºŒè¿›åˆ¶æ–‡ä»¶åœ¨æ‰€æœ‰å¹³å°ä¸Šéƒ½èƒ½æ— ç¼åœ°å·¥ä½œã€‚

ç„¶è€Œï¼Œç”±äºWindowså¤´æ–‡ä»¶åº“ä½¿ç”¨éå¸¸é€šç”¨çš„åç§°ï¼ˆå¦‚`Rectangle`ï¼‰ï¼Œ
å¦‚æœä½ å¸Œæœ›ä½¿ç”¨Cä»£ç ï¼Œè€ŒCä»£ç ä¹Ÿå®šä¹‰äº†ä¸€ä¸ªåä¸º`Rectangle`çš„åç§°ï¼Œè¿™å°†å¯¼è‡´å†²çªã€‚

å¯¹äºè¿™ç§éå¸¸ç‰¹å®šçš„æƒ…å†µï¼Œæˆ‘ä»¬æœ‰ `#preinclude`ã€‚

è¿™å°†å…è®¸åœ¨Væ·»åŠ å…¶å†…ç½®åº“ä¹‹å‰å¯¹äº‹ç‰©è¿›è¡Œé…ç½®ã€‚

ç¤ºä¾‹ç”¨æ³•ï¼š

```v ignore
// è¿™å°†åœ¨ä½¿ç”¨å†…ç½®åº“ä¹‹å‰åŒ…å«ã€‚
#preinclude "pre_include.h"
// è¿™å°†åœ¨ä½¿ç”¨å†…ç½®åº“ååŒ…å«ã€‚
#include "include.h"
```

å¯èƒ½ä¼šåŒ…å«åœ¨ `pre_include.h` ä¸­çš„ç¤ºä¾‹
å¯ä»¥åœ¨[è¿™é‡Œæ‰¾åˆ°](https://github.com/irish

greencitrus/raylib.v/blob/main/include/pre.h)ã€‚

è¿™æ˜¯ä¸€ä¸ªé«˜çº§åŠŸèƒ½ï¼Œé™¤éåœ¨Cäº’æ“ä½œçš„éå¸¸ç‰¹å®šæƒ…å†µä¸‹ï¼Œå¦åˆ™ä¸ä¼šå¿…è¦ï¼Œ
è¿™å¯èƒ½ä¼šå¼•èµ·æ›´å¤šçš„é—®é¢˜è€Œä¸æ˜¯è§£å†³é—®é¢˜ã€‚

è¯·å°†å…¶è§†ä¸ºæœ€åçš„æ‰‹æ®µï¼

## Vå…¶å®ƒçš„åŠŸèƒ½

### å†…è”æ±‡ç¼–

<!-- ignore because it doesn't pass fmt test (why?) -->

```v ignore
a := 100
b := 20
mut c := 0
asm amd64 {
    mov eax, a
    add eax, b
    mov c, eax
    ; =r (c) as c // è¾“å‡º
    ; r (a) as a // è¾“å…¥
      r (b) as b
}
println('a: ${a}') // 100
println('b: ${b}') // 20
println('c: ${c}') // 120
```

è¦è·å–æ›´å¤šç¤ºä¾‹ï¼Œè¯·å‚é˜… [vlib/v/slow_tests/assembly/asm_test.amd64.v](https://github.com/vlang/v/tree/master/vlib/v/slow_tests/assembly/asm_test.amd64.v)ã€‚

### ä»£ç çƒ­é‡è½½

```v live
module main

import time

[live]
fn print_message() {
	println('Hello! Modify this message while the program is running.')
}

fn main() {
	for {
		print_message()
		time.sleep(500 * time.millisecond)
	}
}
```

ä½¿ç”¨ `v -live message.v` æ„å»ºæ­¤ç¤ºä¾‹ã€‚

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ `v -live run message.v` è¿è¡Œæ­¤ç¤ºä¾‹ã€‚ç¡®ä¿åœ¨å‘½ä»¤ä¸­ä½¿ç”¨Vçš„æ–‡ä»¶è·¯å¾„ï¼Œ**è€Œä¸æ˜¯**æ–‡ä»¶å¤¹è·¯å¾„ï¼ˆå¦‚ `v -live run .`ï¼‰ - åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨éœ€è¦ä¿®æ”¹æ–‡ä»¶å¤¹çš„å†…å®¹ï¼ˆä¾‹å¦‚æ·»åŠ æ–°æ–‡ä»¶ï¼‰ï¼Œå› ä¸ºå¯¹ *message.v* çš„æ›´æ”¹å°†ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœã€‚

æ‚¨å¸Œæœ›é‡æ–°åŠ è½½çš„å‡½æ•°å¿…é¡»åœ¨å…¶å®šä¹‰ä¹‹å‰å¸¦æœ‰ `[live]` å±æ€§ã€‚

ç›®å‰ä¸èƒ½åœ¨ç¨‹åºè¿è¡Œæ—¶ä¿®æ”¹ç±»å‹ã€‚

æ›´å¤šç¤ºä¾‹ï¼ŒåŒ…æ‹¬ä¸€ä¸ªå›¾å½¢åº”ç”¨ç¨‹åºï¼š
[github.com/vlang/v/tree/master/examples/hot_reload](https://github.com/vlang/v/tree/master/examples/hot_reload)ã€‚

### åœ¨Vä¸­ç¼–å†™è·¨å¹³å°Shellè„šæœ¬

Vå¯ä»¥ç”¨ä½œç¼–å†™éƒ¨ç½²è„šæœ¬ã€æ„å»ºè„šæœ¬ç­‰çš„Bashçš„æ›¿ä»£æ–¹æ¡ˆã€‚

ä½¿ç”¨Vè¿›è¡Œè¿™ç§æ“ä½œçš„ä¼˜åŠ¿åœ¨äºè¯­è¨€çš„ç®€å•æ€§å’Œå¯é¢„æµ‹æ€§ï¼Œä»¥åŠè·¨å¹³å°æ”¯æŒã€‚ "Vè„šæœ¬" å¯åœ¨ç±»Unixç³»ç»Ÿä»¥åŠWindowsä¸Šè¿è¡Œã€‚

è¦ä½¿ç”¨Vçš„è„šæœ¬æ¨¡å¼ï¼Œè¯·å°†æºæ–‡ä»¶ä¿å­˜ä¸ºå¸¦æœ‰ `.vsh` æ–‡ä»¶æ‰©å±•åã€‚è¿™å°†ä½¿ `os` æ¨¡å—ä¸­çš„æ‰€æœ‰å‡½æ•°æˆä¸ºå…¨å±€å‡½æ•°ï¼ˆå› æ­¤æ‚¨å¯ä»¥ä½¿ç”¨ `mkdir()` è€Œä¸æ˜¯ `os.mkdir()`ï¼Œä¾‹å¦‚ï¼‰ã€‚

Vè¿˜çŸ¥é“ç«‹å³ç¼–è¯‘å¹¶è¿è¡Œ `.vsh` æ–‡ä»¶ï¼Œå› æ­¤æ‚¨ä¸éœ€è¦å•ç‹¬çš„æ­¥éª¤æ¥ç¼–è¯‘å®ƒä»¬ã€‚Vè¿˜ä¼šé‡æ–°ç¼–è¯‘ç”± `.vsh` æ–‡ä»¶ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œ*ä»…å½“å®ƒæ¯” .vsh æºæ–‡ä»¶æ—§æ—¶*ï¼Œå³ç¬¬ä¸€æ¬¡è¿è¡Œåï¼Œå°†æ›´å¿«ï¼Œå› ä¸ºä¸éœ€è¦é‡æ–°ç¼–è¯‘æœªæ›´æ”¹çš„è„šæœ¬ã€‚

ç¤ºä¾‹ `deploy.vsh`ï¼š

```v oksyntax
#!/usr/bin/env -S v

// æ³¨æ„ï¼šä¸Šé¢çš„ shebang è¡Œå°† .vsh æ–‡ä»¶ä¸Unixç±»ç³»ç»Ÿå…³è”èµ·æ¥ï¼Œ
// å› æ­¤å¯ä»¥é€šè¿‡æŒ‡å®š .vsh æ–‡ä»¶çš„è·¯å¾„æ¥è¿è¡Œå®ƒï¼Œä¸€æ—¦å°†å…¶è®¾ç½®ä¸ºå¯æ‰§è¡Œï¼ˆä½¿ç”¨ `chmod +x deploy.vsh`ï¼‰ï¼Œ
// å°±å¯ä»¥åƒè¿™æ ·è¾“å…¥å…¶åç§°/è·¯å¾„ï¼š `./deploy.vsh`

// æ‰“å°å‘½ä»¤ç„¶åæ‰§è¡Œå®ƒ
fn sh(cmd string) {
	println('â¯ ${cmd}')
	print(execute_or_exit(cmd).output)
}

// å¦‚æœ build/ å­˜åœ¨ï¼Œåˆ™å°†å…¶åˆ é™¤ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™å¿½ç•¥ä»»ä½•é”™è¯¯
rmdir_all('build') or {}

// åˆ›å»º build/ï¼Œç”±äº build/ ä¸å­˜åœ¨ï¼Œæ°¸è¿œä¸ä¼šå¤±è´¥
mkdir('build')!

// å°† *.v æ–‡ä»¶ç§»åŠ¨åˆ° build/
result := execute('mv *.v build/')
if result.exit_code != 0 {
	println(result.output)
}

sh('ls')

// ç±»ä¼¼äºï¼š
// files := ls('.')!
// mut count := 0
// if files.len > 0 {
//     for file in files {
//         if file.ends_with('.v') {
//              mv(file, 'build/') or {
//                  println('err: ${err}')
//                  return
//              }
//         }
//         count++
//     }
// }
// if count == 0 {
//     println('No files')
// }
```

ç°åœ¨ï¼Œæ‚¨å¯ä»¥åƒç¼–è¯‘æ™®é€šçš„Vç¨‹åºä¸€æ ·ç¼–è¯‘å®ƒï¼Œå¹¶è·å¾—ä¸€ä¸ªå¯ä»¥åœ¨ä»»ä½•åœ°æ–¹éƒ¨ç½²å’Œè¿è¡Œçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼š
`v deploy.vsh && ./deploy`

æˆ–è€…åªæ˜¯åƒä¼ ç»Ÿçš„Bashè„šæœ¬ä¸€æ ·è¿è¡Œå®ƒï¼š
`v run deploy.vsh`

åœ¨ç±»Unixå¹³å°ä¸Šï¼Œå¯ä»¥ç›´æ¥è¿è¡Œè¯¥æ–‡ä»¶ï¼Œæ–¹æ³•æ˜¯ä½¿å…¶å¯æ‰§è¡Œï¼ˆä½¿ç”¨ `chmod +x`ï¼‰ï¼š
`./deploy.vsh`

### æ²¡æœ‰æ‰©å±•åçš„Vshè„šæœ¬

è™½ç„¶Vé€šå¸¸ä¸å…è®¸æ²¡æœ‰æŒ‡å®šæ–‡ä»¶æ‰©å±•åçš„vshè„šæœ¬ï¼Œä½†æœ‰ä¸€ç§æ–¹æ³•å¯ä»¥ç»•è¿‡æ­¤è§„åˆ™å¹¶æ‹¥æœ‰å…·æœ‰å®Œå…¨è‡ªå®šä¹‰åç§°å’Œshebangçš„æ–‡ä»¶ã€‚å°½ç®¡å­˜åœ¨æ­¤åŠŸèƒ½ï¼Œä½†åªå»ºè®®ç”¨äºç‰¹å®šç”¨ä¾‹ï¼Œå¦‚å°†è„šæœ¬æ”¾åœ¨è·¯å¾„ä¸­ï¼Œå¹¶ä¸”ä¸åº”ç”¨äºè¯¸å¦‚æ„å»ºæˆ–éƒ¨ç½²è„šæœ¬ä¹‹ç±»çš„æƒ…å†µã€‚è¦è®¿é—®æ­¤åŠŸèƒ½ï¼Œè¯·ä»¥ `#!/usr/bin/env -S v -raw-vsh-tmp-prefix tmp` å¼€å¤´ï¼Œå…¶ä¸­ `tmp` æ˜¯å†…ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„å‰ç¼€ã€‚è¿™å°†ä»¥ crun æ¨¡å¼è¿è¡Œï¼Œå› æ­¤ä»…åœ¨å¯¹è„šæœ¬è¿›è¡Œæ›´æ”¹åæ‰ä¼šé‡æ–°æ„å»º

ï¼Œå¹¶å°†äºŒè¿›åˆ¶æ–‡ä»¶ä¿ç•™ä¸º `tmp.<scriptfilename>`ã€‚**æ³¨æ„**ï¼šå¦‚æœæ­¤æ–‡ä»¶åå·²å­˜åœ¨ï¼Œåˆ™å°†è¦†ç›–è¯¥æ–‡ä»¶ã€‚å¦‚æœæ¯æ¬¡éƒ½è¦é‡æ–°æ„å»ºï¼Œè€Œä¸æ˜¯ä¿ç•™æ­¤äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¯·æ”¹ç”¨ `#!/usr/bin/env -S v -raw-vsh-tmp-prefix tmp run`ã€‚

# é™„å½•

## é™„å½•ä¸€ï¼šå…³é”®å­—

Vè¯­è¨€æœ‰44ä¸ªä¿ç•™å…³é”®å­—ï¼ˆå…¶ä¸­3ä¸ªæ˜¯å­—é¢é‡ï¼‰ï¼š

```v ignore
as
asm
assert
atomic
break
const
continue
defer
else
enum
false
fn
for
go
goto
if
import
in
interface
is
isreftype
lock
match
module
mut
none
or
pub
return
rlock
select
shared
sizeof
spawn
static
struct
true
type
typeof
union
unsafe
volatile
__global
__offsetof
```

è¯·å‚é˜… [V ç±»å‹](#V ç±»å‹)ã€‚

## é™„å½•äºŒï¼šè¿ç®—ç¬¦

è¿™é‡Œåªåˆ—å‡ºäº†é’ˆå¯¹[åŸºæœ¬ç±»å‹](#åŸºæœ¬ç±»å‹)çš„è¿ç®—ç¬¦ã€‚

```v ignore
+    sum                    integers, floats, strings
-    difference             integers, floats
*    product                integers, floats
/    quotient               integers, floats
%    remainder              integers

~    bitwise NOT            integers
&    bitwise AND            integers
|    bitwise OR             integers
^    bitwise XOR            integers

!    logical NOT            bools
&&   logical AND            bools
||   logical OR             bools
!=   logical XOR            bools

<<   left shift             integer << unsigned integer
>>   right shift            integer >> unsigned integer
>>>  unsigned right shift   integer >> unsigned integer


Precedence    Operator
    5            *  /  %  <<  >> >>> &
    4            +  -  |  ^
    3            ==  !=  <  <=  >  >=
    2            &&
    1            ||


Assignment Operators
+=   -=   *=   /=   %=
&=   |=   ^=
>>=  <<=  >>>=
```